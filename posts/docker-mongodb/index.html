<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Docker: 設定 MongoDB | Mango Blog</title><meta name=keywords content="Docker,MongoDB,Backend"><meta name=description content="使用 Docker 來建置 MongoDB，可以先到 docker mongo 來選擇版本。
MongoDB 會有幾種架構：

Standalone

建立難度 低
單一 MongoDB 資料庫


Replica Set

建立難度 中
資料會有多個副本提供容錯空間


Sharded Cluster

建立難度 高
資料放置在不同的 shard，每個 shard 或 config servers 都是 Replica Set




"><meta name=author content="Chen Yu Fan"><link rel=canonical href=https://et860525.github.io/posts/docker-mongodb/><link crossorigin=anonymous href=/assets/css/stylesheet.b579d89bdbc0d5e83f0be4b9671c62e5860161af5bd0102ad5edb561e5c0b90c.css integrity="sha256-tXnYm9vA1eg/C+S5Zxxi5YYBYa9b0BAq1e21YeXAuQw=" rel="preload stylesheet" as=style><link rel=icon href=https://et860525.github.io/images/favicon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://et860525.github.io/images/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://et860525.github.io/images/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://et860525.github.io/apple-touch-icon.png><link rel=mask-icon href=https://et860525.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Docker: 設定 MongoDB"><meta property="og:description" content="使用 Docker 來建置 MongoDB，可以先到 docker mongo 來選擇版本。
MongoDB 會有幾種架構：

Standalone

建立難度 低
單一 MongoDB 資料庫


Replica Set

建立難度 中
資料會有多個副本提供容錯空間


Sharded Cluster

建立難度 高
資料放置在不同的 shard，每個 shard 或 config servers 都是 Replica Set




"><meta property="og:type" content="article"><meta property="og:url" content="https://et860525.github.io/posts/docker-mongodb/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-03T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-03T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Docker: 設定 MongoDB"><meta name=twitter:description content="使用 Docker 來建置 MongoDB，可以先到 docker mongo 來選擇版本。
MongoDB 會有幾種架構：

Standalone

建立難度 低
單一 MongoDB 資料庫


Replica Set

建立難度 中
資料會有多個副本提供容錯空間


Sharded Cluster

建立難度 高
資料放置在不同的 shard，每個 shard 或 config servers 都是 Replica Set




"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://et860525.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Docker: 設定 MongoDB","item":"https://et860525.github.io/posts/docker-mongodb/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Docker: 設定 MongoDB","name":"Docker: 設定 MongoDB","description":"使用 Docker 來建置 MongoDB，可以先到 docker mongo 來選擇版本。\nMongoDB 會有幾種架構：\nStandalone 建立難度 低 單一 MongoDB 資料庫 Replica Set 建立難度 中 資料會有多個副本提供容錯空間 Sharded Cluster 建立難度 高 資料放置在不同的 shard，每個 shard 或 config servers 都是 Replica Set ","keywords":["Docker","MongoDB","Backend"],"articleBody":"使用 Docker 來建置 MongoDB，可以先到 docker mongo 來選擇版本。\nMongoDB 會有幾種架構：\nStandalone 建立難度 低 單一 MongoDB 資料庫 Replica Set 建立難度 中 資料會有多個副本提供容錯空間 Sharded Cluster 建立難度 高 資料放置在不同的 shard，每個 shard 或 config servers 都是 Replica Set Standalone Standalone 表示只有一個 MongoDB 實體，Mongo Client 只要直接連接它就可以使用。\n根據 Docker compose file 所顯示，2023年六月後就不會支援 Compose V1 ，所以除了在 Standalone 會試做一個 V1，其他都會換成 Compose V2 的格式\nDocker compose V1 使用 docker-compose 來建立 MongoDB：\n# docker-compose.yml versio: '3.1' services: mongo: image: mongo:latest container_name: mongodb environment: MONGO_INITDB_ROOT_USERNAME: root MONGO_INITDB_ROOT_PASSWORD: example ports: - '27017:27017' volumes: - mongo-mount-data:/data/db 運行 docker-compose：\n# Start docker-compose up -d # Close docker-compose down Docker compose V2 # docker-compose.yaml services: mongo: image: mongo:latest container_name: mongodb-test environment: MONGO_INITDB_ROOT_USERNAME: root MONGO_INITDB_ROOT_PASSWORD: example ports: - '27017:27017' volumes: - mongo-mount-data:/data/db 運行 docker compose：\n# Start docker compose up -d # Close docker compose down 進入 mongoDB docker exec -it bash 輸入後會看到命令列會由 root 開頭，接著再輸入：\n# 5.0+ mongosh -u root -p # 4.0 mongo -u root -p 輸入密碼後，就可以進入 MongoDB 了。\n使用 VM 會遇到的問題 如果在 VM 下使用 MongoDB 5.0+ 以上的版本，有可能會看到：\nWARNING: MongoDB 5.0+ requires a CPU with AVX support, and your current system does not appear to have that! 根據 Mongo DB deployment not working in kubernetes because processor doesn’t have AVX support\n如果是 Windows + VirtualBox 可以在 CMD 輸入：\nbcdedit /set hypervisorlaunchtype off DISM /Online /Disable-Feature:Microsoft-Hyper-V 重開機後就可以解決。\n目前我這裡還是有使用 WSL2，如果輸入以上指令可能會造成 WSL2 無法使用，所以我選擇使用舊版本，暫且不使用 mongo:5.0+。\nReplica Set MongoDB Replication 可以建立一份資料庫副本，在主要的資料庫發生問題時，副本可以直接接手主要資料庫的工作。\n使用 Replica Set 的重點：\nReplica Set 會提供 High availability 依照硬體規格來調整 Replica Set，例如：更大更快的硬碟 不會影響 Primary，使用 Read Preference 來讀取更快更近的副本 MongoDB Replication 的架構 MongoDB Replication 主要的架構的構成：\nReplica Set Member 有兩種：\nPrimary：接受所有讀寫的操作 Secondaries：複製 Primary 的資料 最基本的 Replica Set 需要有三個數據承載成員 ( data-bearing members )：一個 Primary 與二個 Secondary：\n在某些情況下 ( 例如：硬體限制 ) 可以將某個 member 改為 arbiter，它只會參與 投票 ( elections ) 並不會擁有任何資料，更不會成為 Primary：\n以下使用 Docker compose 來建構 Replica Set。\nDocker compose 使用 Docker compose 來建立下方的架構：\n這一個 Replica Set 命名為 RS，需要使用 --replSet RS 建立三個 container 來滿足最基本的 Replica Set： container (rs1/rs2/rs3) ；port ( 27041/27042/27043) docker-compose-replica-set.yaml：\nservices: rs1: image: mongo:4.4.19-focal container_name: rs1 network_mode: host command: mongod --replSet RS --port 27041 --dbpath /data/db --config /resource/mongod.yaml volumes: - ./replica/config/mongod.yaml:/resource/mongod.yaml - ./replica/data/rs1:/data/db extra_hosts: - \"rs1.local:127.0.0.1\" - \"rs2.local:127.0.0.1\" - \"rs3.local:127.0.0.1\" rs2: image: mongo:4.4.19-focal container_name: rs2 network_mode: host command: mongod --replSet RS --port 27042 --dbpath /data/db --config /resource/mongod.yaml volumes: - ./replica/config/mongod.yaml:/resource/mongod.yaml - ./replica/data/rs2:/data/db extra_hosts: - \"rs1.local:127.0.0.1\" - \"rs2.local:127.0.0.1\" - \"rs3.local:127.0.0.1\" rs3: image: mongo:4.4.19-focal container_name: rs3 network_mode: host command: mongod --replSet RS --port 27043 --dbpath /data/db --config /resource/mongod.yaml volumes: - ./replica/config/mongod.yaml:/resource/mongod.yaml - ./replica/data/rs3:/data/db extra_hosts: - \"rs1.local:127.0.0.1\" - \"rs2.local:127.0.0.1\" - \"rs3.local:127.0.0.1\" network_mode 設定為 host，資料庫會如同架設在本機一樣，讓 rs1.local、rs2.local 與 rs3.local 都會對應到 127.0.0.1 command 裡面的設定： --dbpath：指定 MongoDB 存放資料的資料夾 --port：指定 MongoDB 要開啟的 Port --config：指定 MongoDB Config file volumes 裡面的設定： ./replica/config/mongod.yaml:/resource/mongod.yaml：其格式為 A:B，A 為主機端的路徑；B 為容器內的路徑。當容器掛載完成，容器端就會有 /resource/mongod.yaml 檔案，達到路徑能共享資料的功能 ./replica/data/rs3:/data/db：與上方設定很像，資料共享與綁定。當目前的容器被刪除後，其資料都會被存放在本機端，等待下一個容器指向相同的位置，就可以繼續使用以前的資料 extra_hosts 設定解析的域名 rs1.local、rs2.local 與 rs3.local 都會解析 127.0.0.1，這樣就不用再打 127.0.0.1 接下來設定 MongoDB config file replica/config/mongod.yaml：\nnet: bindIpAll: true storage: engine: wiredTiger wiredTiger: engineConfig: cacheSizeGB: 0.1 net Option 裡的 bindIpAll：設定那些 Client IP 可以連進 MongoDB，預設為 localhost 也就是只有本機。假設 Client IP 來自不同的主機，設定 true 就表示任何 Client IP 都可以連進來 storage Option 裡的 engine：有 wiredTiger 與 inMemory 兩種，不論選擇哪一個都要小心設定 cacheSizeGB 或 inMemorySizeGB 的大小。這是因為 Mongo 會依照硬體配置來計算內部緩存的預設值，而 Mongo 並不會知道自己運行在 Docker 容器中，所以在同一個 Docker 上架設兩台以上的 Mongo，就有可能會出現問題，如：斷線或無法連線進去。所以使用 Docker 架設 Mongo 一定要設定 以上只用使用幾個重要的設定，完整的 Mongo config 可以到 Configuration File Options。\n都完成後，使用 docker compose up -d 來運行。\nReplica Set 設定 確認資料庫連線狀況 進入 rs1 容器，來測試能否用域名連線到其他資料庫：\ndocker exec -it rs1 bash 確認資料庫連線：\nmongo rs1.local:27041 --eval \"print('rs1 ok')\" mongo rs2.local:27042 --eval \"print('rs2 ok')\" mongo rs3.local:27043 --eval \"print('rs3 ok')\" 如果都能顯示這些字串，就可以開始設定 Replica Set。\n設定 Replica Set 隨便進入一個 member：\nmongo rs1.local:27041 設定 Replica Set config：\ncfg = { \"_id\": \"RS\", \"members\": [{ \"_id\": 0, \"host\": \"rs1.local:27041\" }, { \"_id\": 1, \"host\": \"rs2.local:27042\" }, { \"_id\": 2, \"host\": \"rs3.local:27043\" } ] }; rs.initiate(cfg); 顯示 ok: 1 就表示完成。\n確認 Replica Set 狀態 當要增加或減少 member 時，或是要檢查 member 是否有連線，就要確認 member 的狀態。最常用的有三種：\nrs.status()：members 的狀態 rs.status().members.forEach(m =\u003e print(`${m.name} =\u003e ${m.stateStr}`)) 會列出： rs1.local:27041 =\u003e PRIMARY rs2.local:27042 =\u003e SECONDARY rs3.local:27043 =\u003e SECONDARY 當然也可以直接使用 rs.status() 來看更詳細的狀態。 rs.printSecondaryReplicationInfo()：members 的同步狀態 source: rs2.local:27042 syncedTo: Fri Mar 03 2023 11:50:04 GMT+0000 (UTC) 0 secs (0 hrs) behind the primary source: rs3.local:27043 syncedTo: Fri Mar 03 2023 11:50:04 GMT+0000 (UTC) 0 secs (0 hrs) behind the primary rs.printReplicationInfo()：members 的 oplog 狀態 configured oplog size: 6040.000781059265MB log length start to end: 18735secs (5.2hrs) oplog first event time: Fri Mar 03 2023 06:33:09 GMT+0000 (UTC) oplog last event time: Fri Mar 03 2023 11:45:24 GMT+0000 (UTC) now: Fri Mar 03 2023 11:45:31 GMT+0000 (UTC) 結語 起初會接觸到 Replica Set 的原因，是出自於我想使用 Prisma 連接 local MongoDB。不過當連接時就會跳出錯誤：\nprisma needs to perform transactions, which requires your mongodb server to be run as a replica set. 這也讓我想了解一下這個 Replica Set 到底是什麼東西。\n而看了該文章才知道，在 Docker 裡建立 MongoDB 時需要設定 cacheSizeGB 來設定緩存大小。可能是通常我也只會使用到一個的 MongoDB 資料庫，所以才沒有遇到那些問題。\nReference [資料庫]使用 Docker 構築不同 MongoDB 架構 (三) - Replica Set ","wordCount":"738","inLanguage":"en","datePublished":"2023-03-03T00:00:00Z","dateModified":"2023-03-03T00:00:00Z","author":{"@type":"Person","name":"Chen Yu Fan"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://et860525.github.io/posts/docker-mongodb/"},"publisher":{"@type":"Organization","name":"Mango Blog","logo":{"@type":"ImageObject","url":"https://et860525.github.io/images/favicon/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://et860525.github.io/ accesskey=h title="Mango Blog (Alt + H)">Mango Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://et860525.github.io/ title=Home><span>Home</span></a></li><li><a href=https://et860525.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://et860525.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://et860525.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://et860525.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://et860525.github.io/posts/>Posts</a></div><h1 class=post-title>Docker: 設定 MongoDB</h1><div class=post-meta><span title='2023-03-03 00:00:00 +0000 UTC'>March 3, 2023</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;Chen Yu Fan</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#standalone aria-label=Standalone>Standalone</a><ul><li><a href=#docker-compose-v1 aria-label="Docker compose V1">Docker compose V1</a></li><li><a href=#docker-compose-v2 aria-label="Docker compose V2">Docker compose V2</a></li><li><a href=#%e9%80%b2%e5%85%a5-mongodb aria-label="進入 mongoDB">進入 mongoDB</a></li><li><a href=#%e4%bd%bf%e7%94%a8-vm-%e6%9c%83%e9%81%87%e5%88%b0%e7%9a%84%e5%95%8f%e9%a1%8c aria-label="使用 VM 會遇到的問題">使用 VM 會遇到的問題</a></li></ul></li><li><a href=#replica-set aria-label="Replica Set">Replica Set</a><ul><li><a href=#mongodb-replication-%e7%9a%84%e6%9e%b6%e6%a7%8b aria-label="MongoDB Replication 的架構">MongoDB Replication 的架構</a></li><li><a href=#docker-compose aria-label="Docker compose">Docker compose</a></li><li><a href=#replica-set-%e8%a8%ad%e5%ae%9a aria-label="Replica Set 設定">Replica Set 設定</a><ul><li><a href=#%e7%a2%ba%e8%aa%8d%e8%b3%87%e6%96%99%e5%ba%ab%e9%80%a3%e7%b7%9a%e7%8b%80%e6%b3%81 aria-label=確認資料庫連線狀況>確認資料庫連線狀況</a></li><li><a href=#%e8%a8%ad%e5%ae%9a-replica-set aria-label="設定 Replica Set">設定 Replica Set</a></li><li><a href=#%e7%a2%ba%e8%aa%8d-replica-set-%e7%8b%80%e6%85%8b aria-label="確認 Replica Set 狀態">確認 Replica Set 狀態</a></li></ul></li></ul></li><li><a href=#%e7%b5%90%e8%aa%9e aria-label=結語>結語</a></li><li><a href=#reference aria-label=Reference>Reference</a></li></ul></div></details></div><div class=post-content><p>使用 Docker 來建置 MongoDB，可以先到 <a href=https://hub.docker.com/_/mongo>docker mongo</a> 來選擇版本。</p><p>MongoDB 會有幾種架構：</p><ol><li>Standalone<ul><li>建立難度 <strong>低</strong></li><li>單一 MongoDB 資料庫</li></ul></li><li><a href=https://www.mongodb.com/docs/manual/replication/>Replica Set</a><ul><li>建立難度 <strong>中</strong></li><li>資料會有多個副本提供容錯空間</li></ul></li><li><a href=https://www.mongodb.com/docs/manual/sharding/>Sharded Cluster</a><ul><li>建立難度 <strong>高</strong></li><li>資料放置在不同的 shard，每個 shard 或 config servers 都是 <code>Replica Set</code>
<img loading=lazy src=/images/Docker-mongodb/Docker-sharded-cluster-production-architecture.png alt=Docker-sharded-cluster-production-architecture.png></li></ul></li></ol><h1 id=standalone>Standalone<a hidden class=anchor aria-hidden=true href=#standalone>#</a></h1><p>Standalone 表示只有一個 MongoDB 實體，Mongo Client 只要直接連接它就可以使用。</p><blockquote><p>根據 <a href=https://docs.docker.com/compose/compose-file/>Docker compose file</a> 所顯示，2023年六月後就不會支援 Compose V1 ，所以除了在 Standalone 會試做一個 V1，其他都會換成 Compose V2 的格式</p></blockquote><h2 id=docker-compose-v1>Docker compose V1<a hidden class=anchor aria-hidden=true href=#docker-compose-v1>#</a></h2><p>使用 <code>docker-compose</code> 來建立 MongoDB：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=c># docker-compose.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>versio</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mongo</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mongo:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>MONGO_INITDB_ROOT_USERNAME</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>MONGO_INITDB_ROOT_PASSWORD</span><span class=p>:</span><span class=w> </span><span class=l>example</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;27017:27017&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>mongo-mount-data:/data/db</span><span class=w>
</span></span></span></code></pre></div><p>運行 <code>docker-compose</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Start</span>
</span></span><span class=line><span class=cl>docker-compose up -d
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Close</span>
</span></span><span class=line><span class=cl>docker-compose down
</span></span></code></pre></div><h2 id=docker-compose-v2>Docker compose V2<a hidden class=anchor aria-hidden=true href=#docker-compose-v2>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># docker-compose.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mongo</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mongo:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>mongodb-test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>MONGO_INITDB_ROOT_USERNAME</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>MONGO_INITDB_ROOT_PASSWORD</span><span class=p>:</span><span class=w> </span><span class=l>example</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;27017:27017&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>mongo-mount-data:/data/db</span><span class=w>
</span></span></span></code></pre></div><p>運行 <code>docker compose</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Start</span>
</span></span><span class=line><span class=cl>docker compose up -d
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Close</span>
</span></span><span class=line><span class=cl>docker compose down
</span></span></code></pre></div><h2 id=進入-mongodb>進入 mongoDB<a hidden class=anchor aria-hidden=true href=#進入-mongodb>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker <span class=nb>exec</span> -it &lt;mongo-name&gt; bash
</span></span></code></pre></div><p>輸入後會看到命令列會由 <code>root</code> 開頭，接著再輸入：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 5.0+</span>
</span></span><span class=line><span class=cl>mongosh -u root -p
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4.0</span>
</span></span><span class=line><span class=cl>mongo -u root -p
</span></span></code></pre></div><p>輸入密碼後，就可以進入 MongoDB 了。</p><h2 id=使用-vm-會遇到的問題>使用 VM 會遇到的問題<a hidden class=anchor aria-hidden=true href=#使用-vm-會遇到的問題>#</a></h2><p>如果在 VM 下使用 MongoDB 5.0+ 以上的版本，有可能會看到：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>WARNING: MongoDB 5.0+ requires a CPU with AVX support, and your current system does not appear to have that!
</span></span></code></pre></div><p>根據 <a href=https://stackoverflow.com/questions/70818543/mongo-db-deployment-not-working-in-kubernetes-because-processor-doesnt-have-avx>Mongo DB deployment not working in kubernetes because processor doesn&rsquo;t have AVX support</a></p><p>如果是 Windows + VirtualBox 可以在 CMD 輸入：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>bcdedit</span> <span class=p>/</span><span class=nb>set </span><span class=n>hypervisorlaunchtype</span> <span class=n>off</span>
</span></span><span class=line><span class=cl><span class=n>DISM</span> <span class=p>/</span><span class=n>Online</span> <span class=p>/</span><span class=nb>Disable-Feature</span><span class=err>:</span><span class=nb>Microsoft-Hyper</span><span class=n>-V</span>
</span></span></code></pre></div><p>重開機後就可以解決。</p><blockquote><p>目前我這裡還是有使用 WSL2，如果輸入以上指令可能會造成 WSL2 無法使用，所以我選擇使用舊版本，暫且不使用 <code>mongo:5.0+</code>。</p></blockquote><hr><h1 id=replica-set>Replica Set<a hidden class=anchor aria-hidden=true href=#replica-set>#</a></h1><p><a href=https://www.mongodb.com/docs/manual/replication/>MongoDB Replication</a> 可以建立一份資料庫副本，在主要的資料庫發生問題時，副本可以直接接手主要資料庫的工作。</p><p>使用 Replica Set 的重點：</p><ul><li>Replica Set 會提供 <a href=https://www.mongodb.com/docs/manual/reference/glossary/#std-term-high-availability>High availability</a></li><li>依照硬體規格來調整 Replica Set，例如：更大更快的硬碟</li><li>不會影響 Primary，使用 <a href=https://www.mongodb.com/docs/manual/core/read-preference/>Read Preference</a> 來讀取更快更近的副本</li></ul><h2 id=mongodb-replication-的架構>MongoDB Replication 的架構<a hidden class=anchor aria-hidden=true href=#mongodb-replication-的架構>#</a></h2><p>MongoDB Replication 主要的架構的構成：</p><p><img loading=lazy src=/images/Docker-mongodb/Docker-replica-set-read-write-operations-primary.png alt=Docker-replica-set-read-write-operations-primary.png></p><p><a href=https://www.mongodb.com/docs/manual/core/replica-set-members/#std-label-replica-set-primary-member>Replica Set Member</a> 有兩種：</p><ul><li><code>Primary</code>：接受所有讀寫的操作</li><li><code>Secondaries</code>：複製 <code>Primary</code> 的資料</li></ul><p>最基本的 Replica Set 需要有三個<strong>數據承載成員 ( data-bearing members )</strong>：一個 <code>Primary</code> 與二個 <code>Secondary</code>：</p><p><img loading=lazy src=/images/Docker-mongodb/Docker-replica-set-primary-with-two-secondaries.png alt=Docker-replica-set-primary-with-two-secondaries.png></p><p>在某些情況下 ( 例如：硬體限制 ) 可以將某個 member 改為 <a href=https://www.mongodb.com/docs/manual/core/replica-set-arbiter/>arbiter</a>，它只會參與 <a href=https://www.mongodb.com/docs/manual/core/replica-set-elections/#std-label-replica-set-elections>投票 ( elections )</a> 並不會擁有任何資料，更不會成為 <code>Primary</code>：</p><p><img loading=lazy src=/images/Docker-mongodb/Docker-replica-set-primary-secondary-arbiter.png alt=Docker-replica-set-primary-secondary-arbiter.png></p><p>以下使用 Docker compose 來建構 Replica Set。</p><h2 id=docker-compose>Docker compose<a hidden class=anchor aria-hidden=true href=#docker-compose>#</a></h2><p>使用 Docker compose 來建立下方的架構：</p><p><img loading=lazy src=/images/Docker-mongodb/Docker-replica-set-compose.png alt=Docker-replica-set-compose.png></p><ul><li>這一個 Replica Set 命名為 <code>RS</code>，需要使用 <code>--replSet RS</code></li><li>建立三個 container 來滿足最基本的 Replica Set：<ul><li>container (<code>rs1</code>/<code>rs2</code>/<code>rs3</code>) ；port ( <code>27041</code>/<code>27042</code>/<code>27043</code>)</li></ul></li></ul><p><code>docker-compose-replica-set.yaml</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rs1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mongo:4.4.19-focal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>rs1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>network_mode</span><span class=p>:</span><span class=w> </span><span class=l>host</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>mongod --replSet RS --port 27041 --dbpath /data/db --config /resource/mongod.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./replica/config/mongod.yaml:/resource/mongod.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./replica/data/rs1:/data/db</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>extra_hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;rs1.local:127.0.0.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;rs2.local:127.0.0.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;rs3.local:127.0.0.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rs2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mongo:4.4.19-focal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>rs2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>network_mode</span><span class=p>:</span><span class=w> </span><span class=l>host</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>mongod --replSet RS --port 27042 --dbpath /data/db --config /resource/mongod.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./replica/config/mongod.yaml:/resource/mongod.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./replica/data/rs2:/data/db</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>extra_hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;rs1.local:127.0.0.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;rs2.local:127.0.0.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;rs3.local:127.0.0.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rs3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mongo:4.4.19-focal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>rs3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>network_mode</span><span class=p>:</span><span class=w> </span><span class=l>host</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>mongod --replSet RS --port 27043 --dbpath /data/db --config /resource/mongod.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./replica/config/mongod.yaml:/resource/mongod.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./replica/data/rs3:/data/db</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>extra_hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;rs1.local:127.0.0.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;rs2.local:127.0.0.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;rs3.local:127.0.0.1&#34;</span><span class=w>
</span></span></span></code></pre></div><ul><li><code>network_mode</code> 設定為 <code>host</code>，資料庫會如同架設在本機一樣，讓 <code>rs1.local</code>、<code>rs2.local</code> 與 <code>rs3.local</code> 都會對應到 <code>127.0.0.1</code></li><li><code>command</code> 裡面的設定：<ul><li><code>--dbpath</code>：指定 MongoDB 存放資料的資料夾</li><li><code>--port</code>：指定 MongoDB 要開啟的 Port</li><li><code>--config</code>：指定 MongoDB Config file</li></ul></li><li><code>volumes</code> 裡面的設定：<ul><li><code>./replica/config/mongod.yaml:/resource/mongod.yaml</code>：其格式為 <code>A:B</code>，A 為主機端的路徑；B 為容器內的路徑。當容器掛載完成，容器端就會有 <code>/resource/mongod.yaml</code> 檔案，達到路徑能共享資料的功能</li><li><code>./replica/data/rs3:/data/db</code>：與上方設定很像，資料共享與綁定。當目前的容器被刪除後，其資料都會被存放在本機端，等待下一個容器指向相同的位置，就可以繼續使用以前的資料</li></ul></li><li><code>extra_hosts</code> 設定解析的域名 <code>rs1.local</code>、<code>rs2.local</code> 與 <code>rs3.local</code> 都會解析 <code>127.0.0.1</code>，這樣就不用再打 <code>127.0.0.1</code></li></ul><p>接下來設定 MongoDB config file <code>replica/config/mongod.yaml</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>net</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>bindIpAll</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>storage</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>engine</span><span class=p>:</span><span class=w> </span><span class=l>wiredTiger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>wiredTiger</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>engineConfig</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cacheSizeGB</span><span class=p>:</span><span class=w> </span><span class=m>0.1</span><span class=w>
</span></span></span></code></pre></div><ul><li><a href=https://www.mongodb.com/docs/manual/reference/configuration-options/#net-options>net Option</a> 裡的 <code>bindIpAll</code>：設定那些 Client IP 可以連進 MongoDB，預設為 <code>localhost</code> 也就是只有本機。假設 Client IP 來自不同的主機，設定 <code>true</code> 就表示任何 Client IP 都可以連進來</li><li><a href=https://www.mongodb.com/docs/manual/reference/configuration-options/#storage-options>storage Option</a> 裡的 <code>engine</code>：有 <code>wiredTiger</code> 與 <code>inMemory</code> 兩種，不論選擇哪一個都要小心設定 <code>cacheSizeGB</code> 或 <code>inMemorySizeGB</code> 的大小。這是因為 Mongo 會依照硬體配置來計算<a href=https://www.mongodb.com/docs/manual/reference/configuration-options/#mongodb-setting-storage.wiredTiger.engineConfig.cacheSizeGB>內部緩存的預設值</a>，而 Mongo 並不會知道自己運行在 Docker 容器中，所以在同一個 Docker 上架設兩台以上的 Mongo，就有可能會出現問題，如：斷線或無法連線進去。所以使用 Docker 架設 Mongo <strong>一定要設定</strong></li></ul><p>以上只用使用幾個重要的設定，完整的 Mongo config 可以到 <a href=https://www.mongodb.com/docs/manual/reference/configuration-options/>Configuration File Options</a>。</p><p>都完成後，使用 <code>docker compose up -d</code> 來運行。</p><h2 id=replica-set-設定>Replica Set 設定<a hidden class=anchor aria-hidden=true href=#replica-set-設定>#</a></h2><h3 id=確認資料庫連線狀況>確認資料庫連線狀況<a hidden class=anchor aria-hidden=true href=#確認資料庫連線狀況>#</a></h3><p>進入 <strong>rs1</strong> 容器，來測試能否用域名連線到其他資料庫：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker <span class=nb>exec</span> -it rs1 bash
</span></span></code></pre></div><p>確認資料庫連線：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mongo rs1.local:27041 --eval <span class=s2>&#34;print(&#39;rs1 ok&#39;)&#34;</span>
</span></span><span class=line><span class=cl>mongo rs2.local:27042 --eval <span class=s2>&#34;print(&#39;rs2 ok&#39;)&#34;</span>
</span></span><span class=line><span class=cl>mongo rs3.local:27043 --eval <span class=s2>&#34;print(&#39;rs3 ok&#39;)&#34;</span>
</span></span></code></pre></div><p>如果都能顯示這些字串，就可以開始設定 Replica Set。</p><h3 id=設定-replica-set>設定 Replica Set<a hidden class=anchor aria-hidden=true href=#設定-replica-set>#</a></h3><p>隨便進入一個 member：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mongo rs1.local:27041
</span></span></code></pre></div><p>設定 Replica Set config：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>cfg</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;_id&#34;</span>: <span class=s2>&#34;RS&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;members&#34;</span>: <span class=o>[{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;_id&#34;</span>: 0,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;host&#34;</span>: <span class=s2>&#34;rs1.local:27041&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;_id&#34;</span>: 1,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;host&#34;</span>: <span class=s2>&#34;rs2.local:27042&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;_id&#34;</span>: 2,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;host&#34;</span>: <span class=s2>&#34;rs3.local:27043&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span><span class=p>;</span>
</span></span><span class=line><span class=cl>rs.initiate<span class=o>(</span>cfg<span class=o>)</span><span class=p>;</span>
</span></span></code></pre></div><p>顯示 <code>ok: 1</code> 就表示完成。</p><h3 id=確認-replica-set-狀態>確認 Replica Set 狀態<a hidden class=anchor aria-hidden=true href=#確認-replica-set-狀態>#</a></h3><p>當要增加或減少 member 時，或是要檢查 member 是否有連線，就要確認 member 的狀態。最常用的有三種：</p><ul><li><code>rs.status()</code>：members 的狀態<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rs.status<span class=o>()</span>.members.forEach<span class=o>(</span><span class=nv>m</span> <span class=o>=</span>&gt; print<span class=o>(</span><span class=sb>`</span><span class=si>${</span><span class=nv>m</span><span class=p>.name</span><span class=si>}</span> <span class=o>=</span>&gt;  <span class=si>${</span><span class=nv>m</span><span class=p>.stateStr</span><span class=si>}</span><span class=sb>`</span><span class=o>))</span>
</span></span></code></pre></div>會列出：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rs1.local:27041 <span class=o>=</span>&gt;  PRIMARY
</span></span><span class=line><span class=cl>rs2.local:27042 <span class=o>=</span>&gt;  SECONDARY
</span></span><span class=line><span class=cl>rs3.local:27043 <span class=o>=</span>&gt;  SECONDARY
</span></span></code></pre></div>當然也可以直接使用 <code>rs.status()</code> 來看更詳細的狀態。</li><li><code>rs.printSecondaryReplicationInfo()</code>：members 的同步狀態<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>source: rs2.local:27042
</span></span><span class=line><span class=cl>    syncedTo: Fri Mar <span class=m>03</span> <span class=m>2023</span> 11:50:04 GMT+0000 <span class=o>(</span>UTC<span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span> secs <span class=o>(</span><span class=m>0</span> hrs<span class=o>)</span> behind the primary
</span></span><span class=line><span class=cl>source: rs3.local:27043
</span></span><span class=line><span class=cl>    syncedTo: Fri Mar <span class=m>03</span> <span class=m>2023</span> 11:50:04 GMT+0000 <span class=o>(</span>UTC<span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span> secs <span class=o>(</span><span class=m>0</span> hrs<span class=o>)</span> behind the primary
</span></span></code></pre></div></li><li><code>rs.printReplicationInfo()</code>：members 的 <a href=https://www.mongodb.com/docs/manual/reference/glossary/#std-term-oplog>oplog</a> 狀態<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>configured oplog size:   6040.000781059265MB
</span></span><span class=line><span class=cl>log length start to end: 18735secs <span class=o>(</span>5.2hrs<span class=o>)</span>
</span></span><span class=line><span class=cl>oplog first event time:  Fri Mar <span class=m>03</span> <span class=m>2023</span> 06:33:09 GMT+0000 <span class=o>(</span>UTC<span class=o>)</span>
</span></span><span class=line><span class=cl>oplog last event time:   Fri Mar <span class=m>03</span> <span class=m>2023</span> 11:45:24 GMT+0000 <span class=o>(</span>UTC<span class=o>)</span>
</span></span><span class=line><span class=cl>now:                     Fri Mar <span class=m>03</span> <span class=m>2023</span> 11:45:31 GMT+0000 <span class=o>(</span>UTC<span class=o>)</span>
</span></span></code></pre></div></li></ul><h1 id=結語>結語<a hidden class=anchor aria-hidden=true href=#結語>#</a></h1><p>起初會接觸到 Replica Set 的原因，是出自於我想使用 Prisma 連接 local MongoDB。不過當連接時就會跳出錯誤：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>prisma needs to perform transactions, which requires your mongodb server to be run as a replica set.
</span></span></code></pre></div><p>這也讓我想了解一下這個 Replica Set 到底是什麼東西。</p><p>而看了該文章才知道，在 Docker 裡建立 MongoDB 時需要設定 <code>cacheSizeGB</code> 來設定緩存大小。可能是通常我也只會使用到一個的 MongoDB 資料庫，所以才沒有遇到那些問題。</p><hr><h1 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h1><ul><li><a href=https://ithelp.ithome.com.tw/articles/10227851>[資料庫]使用 Docker 構築不同 MongoDB 架構 (三) - Replica Set</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://et860525.github.io/tags/docker/>Docker</a></li><li><a href=https://et860525.github.io/tags/mongodb/>MongoDB</a></li><li><a href=https://et860525.github.io/tags/backend/>Backend</a></li></ul><nav class=paginav><a class=prev href=https://et860525.github.io/posts/restaurant-management-init/><span class=title>« Prev</span><br><span>Restaurant Management 專案(一) - 架構與初始化</span></a>
<a class=next href=https://et860525.github.io/posts/pnpm/><span class=title>Next »</span><br><span>Pnpm ( Performant Node Package Manager )</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Docker: 設定 MongoDB on twitter" href="https://twitter.com/intent/tweet/?text=Docker%3a%20%e8%a8%ad%e5%ae%9a%20MongoDB&amp;url=https%3a%2f%2fet860525.github.io%2fposts%2fdocker-mongodb%2f&amp;hashtags=Docker%2cMongoDB%2cBackend"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Docker: 設定 MongoDB on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fet860525.github.io%2fposts%2fdocker-mongodb%2f&amp;title=Docker%3a%20%e8%a8%ad%e5%ae%9a%20MongoDB&amp;summary=Docker%3a%20%e8%a8%ad%e5%ae%9a%20MongoDB&amp;source=https%3a%2f%2fet860525.github.io%2fposts%2fdocker-mongodb%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Docker: 設定 MongoDB on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fet860525.github.io%2fposts%2fdocker-mongodb%2f&title=Docker%3a%20%e8%a8%ad%e5%ae%9a%20MongoDB"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Docker: 設定 MongoDB on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fet860525.github.io%2fposts%2fdocker-mongodb%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Docker: 設定 MongoDB on whatsapp" href="https://api.whatsapp.com/send?text=Docker%3a%20%e8%a8%ad%e5%ae%9a%20MongoDB%20-%20https%3a%2f%2fet860525.github.io%2fposts%2fdocker-mongodb%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Docker: 設定 MongoDB on telegram" href="https://telegram.me/share/url?text=Docker%3a%20%e8%a8%ad%e5%ae%9a%20MongoDB&amp;url=https%3a%2f%2fet860525.github.io%2fposts%2fdocker-mongodb%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://et860525.github.io/>Mango Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>