[{"content":"é€™å€‹å°ˆæ¡ˆæœƒä½¿ç”¨ Node.js å’Œ TypeScript ä¾†å»ºæ§‹ REST API å¾Œç«¯ï¼Œä½¿ç”¨ JWT ä¾†å¯¦ä½œèº«åˆ†èªè­‰èˆ‡æˆæ¬Šã€‚\næ­¤å°ˆæ¡ˆæœƒéµå¾ªæˆ‘æ…£ç”¨çš„ OOP æ¶æ§‹ et860525/express-project-architectureï¼Œæœ‰é‘‘æ–¼ä¸Šä¸€æ¬¡å°ˆæ¡ˆçš„ç¶“é©—ï¼Œç”±æ–¼é€™äº›éƒ½åªæ˜¯å°å°ˆæ¡ˆï¼Œæˆ‘ä¸æœƒæŠŠæ‰€æœ‰æ±è¥¿éƒ½å…¨éƒ¨éƒ½åŒ…åœ¨ class è£¡é¢\nå»ºæ§‹æ­¤å°ˆæ¡ˆæœƒç”¨åˆ°çš„é‡è¦å¥—ä»¶ï¼š\nPackage Usage Express Web æ‡‰ç”¨æ¡†æ¶ TypeScript é–‹ç™¼å·¥å…· Mongoose è¨ªå•è³‡æ–™åº« Docker æ‡‰ç”¨å®¹å™¨åŒ– MongoDB å„²å­˜ä½¿ç”¨è€…çš„è³‡æ–™åº« Redis å„²å­˜ä½¿ç”¨è€…ç·©å­˜çš„ session è³‡æ–™åº« JsonWebToken ç”¢ç”Ÿ JWTs Bcryptjs å¯†ç¢¼åŠ å¯† Zod é©—è­‰ä½¿ç”¨è€…çš„è¼¸å…¥ Typegoose ä½¿ç”¨ TypeScript å„ªåŒ– Mongoose æ¨¡å‹ Dotenv è®€å–ç’°å¢ƒè®Šæ•¸ Cors å…è¨±è³‡æ–™èƒ½åœ¨å‰ç«¯èˆ‡å¾Œç«¯ä¹‹é–“åˆ†äº« lodash å° JavaScript çš„åŠŸèƒ½æ“´å…… ts-node-dev ç•¶æª”æ¡ˆè®Šæ›´æ™‚è‡ªå‹•é‡å•Ÿ JWT é©—è­‰æµç¨‹ ä½¿ç”¨è€…éœ€è¦æä¾›ç€è¦½å™¨å¸³è™Ÿå¯†ç¢¼ä¾†åšç™»å…¥ã€‚å‰ç«¯æœƒç™¼é€å¸¶æœ‰ä½¿ç”¨è€…æ†‘è­‰çš„è«‹æ±‚åˆ°å¾Œç«¯ï¼Œç•¶å¾Œç«¯é©—è­‰æˆåŠŸå¾Œï¼Œæœƒå‚³é€ä½¿ç”¨è€…ç›¸é—œçš„ cookies å›åˆ°å‰ç«¯ã€‚\nä½¿ç”¨è€…è¨»å†Šçš„æµç¨‹ï¼š\nä½¿ç”¨è€…ç™»å…¥çš„æµç¨‹ï¼š\nAPI è·¯ç”±è¨­ç½® HTTP Method Route Description GET /api/users å›å‚³æ‰€æœ‰ä½¿ç”¨è€…çš„è³‡è¨Š GET /api/users/me å›å‚³å·²ç™»å…¥è€…çš„è³‡è¨Š POST /api/auth/register è¨»å†Šæ–°ç”¨æˆ¶ POST /api/auth/login ç™»å…¥ åˆå§‹åŒ–å°ˆæ¡ˆ å»ºç«‹è³‡æ–™å¤¾ä¸¦åˆå§‹åŒ–ï¼š mkdir jwt-auth-node cd jwt-auth-node pnpm init å®‰è£å¥—ä»¶ å®‰è£ç›¸é—œå¥—ä»¶ï¼š pnpm install @typegoose/typegoose bcryptjs cookie-parser dotenv express jsonwebtoken lodash mongoose redis ts-node-dev zod cors å®‰è£é–‹ç™¼ç”¨å¥—ä»¶ï¼š pnpm install -D morgan typescript å®‰è£ Type Definition æª”æ¡ˆï¼š pnpm install -D @types/bcryptjs @types/cookie-parser @types/express @types/jsonwebtoken @types/lodash @types/morgan @types/node @types/cors TypeScript ç›¸é—œè¨­å®š ç”¢ç”Ÿ tsconfig.json æª”æ¡ˆï¼š tsc --init tsconfig.jsonï¼š { \u0026#34;compilerOptions\u0026#34;: { \u0026#34;target\u0026#34;: \u0026#34;es2017\u0026#34;, \u0026#34;experimentalDecorators\u0026#34;: true, \u0026#34;emitDecoratorMetadata\u0026#34;: true, \u0026#34;module\u0026#34;: \u0026#34;commonjs\u0026#34;, \u0026#34;rootDir\u0026#34;: \u0026#34;./src\u0026#34;, \u0026#34;outDir\u0026#34;: \u0026#34;./dist\u0026#34;, \u0026#34;esModuleInterop\u0026#34;: true, \u0026#34;forceConsistentCasingInFileNames\u0026#34;: true, \u0026#34;strict\u0026#34;: true, \u0026#34;skipLibCheck\u0026#34;: true } } åœ¨ How to Start using typegoose æœ‰èªªæ˜ï¼Œä»¥ä¸‹å…©å€‹è¨­å®šä¸€å®šè¦é–‹å•Ÿï¼š\nexperimentalDecorators: true emitDecoratorMetadata: true ç°¡å–®çš„ Express Server å»ºç«‹ ./.env æª”æ¡ˆï¼š PORT=3000 ./src/app.tsï¼š import dotenv from \u0026#39;dotenv\u0026#39;; import express, { Request, Response } from \u0026#39;express\u0026#39;; dotenv.config(); const env = process.env.NODE_ENV; const port = process.env.PORT; const app = express(); app.get(\u0026#39;/\u0026#39;, (req: Request, res: Response) =\u0026gt; { res.send(\u0026#39;JWT + Express + TypeScript Server\u0026#39;); }); app.listen(port, () =\u0026gt; { console.log( `[server]: Server is running at http://localhost:${port} in ${env}` ); ; åœ¨ ./package.json è£¡å¯«ä¸€å€‹å•Ÿå‹•è…³æœ¬ï¼š \u0026#34;scripts\u0026#34;: { \u0026#34;dev\u0026#34;: \u0026#34;NODE_ENV=development ts-node-dev --respawn src/app.ts\u0026#34; } å•Ÿå‹•ä¼ºæœå™¨ï¼š pnpm dev ä¸¦è¨ªå• http://localhost:3000 å°±å¯ä»¥çœ‹åˆ°æˆåŠŸç•«é¢ã€‚\nä½¿ç”¨ Docker Compose è¨­å®šè³‡æ–™åº« åœ¨å°ˆæ¡ˆç›®éŒ„ä¸‹æ–°å¢ä¸€å€‹æª”æ¡ˆ ./docker-compose.yamlï¼š services: mongo: image: mongo:4.4.19-focal container_name: mongo environment: MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USERNAME} MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD} MONGO_INITDB_DATABASE: ${MONGODB_DATABASE} env_file: - ./.env ports: - \u0026#39;6017:27017\u0026#39; volumes: - mongo:/data/db - ./init-mongo.sh:/docker-entrypoint-initdb.d/init-mongo.sh:ro redis: image: redis:latest container_name: redis ports: - \u0026#39;6379:6379\u0026#39; volumes: - redis:/data volumes: mongo: redis: docker-compose.yaml æª”æ¡ˆæœƒä½¿ç”¨å°ˆæ¡ˆä¸‹ .env è£¡çš„è¨­å®šï¼Œæ‰€ä»¥è¦æ–°å¢æ‰€éœ€è¦çš„ç›¸é—œè¨­å®šï¼š\n.env PORT=3000 MONGODB_USERNAME=jwtweb MONGODB_PASSWORD=pwd123 MONGODB_DATABASE=jwtAuth ç•¶ MongoDB å»ºç«‹å¾Œï¼Œå®ƒä¸¦ä¸æœƒè‡ªå‹•å»ºç«‹ databaseã€‚é€™å°±æ˜¯ ./init-mongo.sh:/docker-entrypoint-initdb.d/init-mongo.sh:ro çš„åŠŸç”¨ï¼Œå¯«ä¸€å€‹åˆå§‹åŒ–è³‡æ–™åº«çš„æª”æ¡ˆä¸¦æ›è¼‰åˆ°å®¹å™¨è£¡ã€‚\nåœ¨å°ˆæ¡ˆç›®éŒ„ä¸‹æ–°å¢ä¸€å€‹æª”æ¡ˆ ./init-mongo.shï¼š\nmongo \u0026lt;\u0026lt; EOF db = db.getSiblingDB(\u0026#39;jwtAuth\u0026#39;) db.createUser({ user: \u0026#39;${MONGODB_USERNAME}\u0026#39;, pwd: \u0026#39;${MONGODB_PASSWORD}\u0026#39;, roles: [ { role: \u0026#39;readWrite\u0026#39;, db: \u0026#39;${MONGODB_DATABASE}\u0026#39;, }, ], }); EOF å®Œæˆå¾Œä½¿ç”¨ä¸‹é¢æŒ‡ä»¤ä¾†é‹è¡Œï¼š\ndocker compose up -d å¦‚æœè¦åœæ­¢çš„è©±å¯ä»¥ä½¿ç”¨ï¼š\ndocker compose down # or docker compose down -v # åœæ­¢ä¸¦åˆªé™¤ volume é€£æ¥åˆ° MongoDB ./src/database/connectMongo import mongoose from \u0026#39;mongoose\u0026#39;; const db_user = process.env.MONGODB_USERNAME; const db_pwd = process.env.MONGODB_PASSWORD; const db_name = process.env.MONGODB_DATABASE; mongoose.set(\u0026#39;strictQuery\u0026#39;, false); const url = `mongodb://${db_user}:${db_pwd}@localhost:6017/${db_name}`; const connectDB = async () =\u0026gt; { try { await mongoose.connect(url); console.log(\u0026#39;Database connected...\u0026#39;); } catch (error: any) { console.log(error.message); setTimeout(connectDB, 5000); } }; export default connectDB; è®“ app.ts é€£æ¥ï¼š import connectDB from \u0026#39;./database/connectMongo\u0026#39;; //... app.listen(port, () =\u0026gt; { console.log( `[server]: Server is running at http://localhost:${port} in ${env}` ); connectDB(); }); é€£æ¥åˆ° Redis ./src/database/connectRedis import { createClient } from \u0026#39;redis\u0026#39;; const redisUrl = \u0026#39;redis://localhost:6379\u0026#39;; const redisClient = createClient({ url: redisUrl, }); const connectRedis = async () =\u0026gt; { try { await redisClient.connect(); console.log(\u0026#39;Redis client connect...\u0026#39;); } catch (err: any) { console.log(err.message); setTimeout(connectRedis, 5000); } }; connectRedis(); redisClient.on(\u0026#39;error\u0026#39;, (err) =\u0026gt; console.log(err)); export default redisClient; å› ç‚º Redis åªæœƒå„²å­˜ session ç‹€æ…‹ï¼Œæ‰€ä»¥ç›®å‰é‚„ä¸éœ€è¦å¥—ç”¨åœ¨ä»»ä½•åœ°æ–¹ã€‚\nå¯ä»¥åˆ°æˆ‘çš„ et860525/jwt-auth-node ä¾†æŸ¥çœ‹ç¨‹å¼ç¢¼\nçµèª è‡ªå¾ä¸Šä¸€æ¬¡ç™¼æ–‡å¾Œé¦¬ä¸Šå°±ç¢ºè¨ºäº†ï¼Œæ‰€ä»¥æ–°çš„å°ˆæ¡ˆå°±åœäº†ä¸€é™£å­ã€‚é€™æ¬¡çš„å°ˆæ¡ˆæ˜¯çµåˆä»¥å‰æ‰€å­¸éçš„æ±è¥¿ï¼Œä¾†å¯¦ä½œä¸€å€‹ç°¡å–®çš„ JWT (JSON Web Tokens) RESTful APIã€‚\nä¸‹ä¸€å€‹ç« ç¯€æœƒå¾å»ºç«‹è³‡æ–™åº«çš„ model é–‹å§‹ã€‚\n","permalink":"https://et860525.github.io/posts/jwt-authentication-init/","summary":"\u003cp\u003eé€™å€‹å°ˆæ¡ˆæœƒä½¿ç”¨ Node.js å’Œ TypeScript ä¾†å»ºæ§‹ REST API å¾Œç«¯ï¼Œä½¿ç”¨ \u003ca href=\"https://jwt.io/\"\u003eJWT\u003c/a\u003e ä¾†å¯¦ä½œèº«åˆ†èªè­‰èˆ‡æˆæ¬Šã€‚\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eæ­¤å°ˆæ¡ˆæœƒéµå¾ªæˆ‘æ…£ç”¨çš„ OOP æ¶æ§‹  \u003ca href=\"https://github.com/et860525/express-project-architecture\"\u003eet860525/express-project-architecture\u003c/a\u003eï¼Œæœ‰é‘‘æ–¼ä¸Šä¸€æ¬¡å°ˆæ¡ˆçš„ç¶“é©—ï¼Œç”±æ–¼é€™äº›éƒ½åªæ˜¯å°å°ˆæ¡ˆï¼Œæˆ‘ä¸æœƒæŠŠæ‰€æœ‰æ±è¥¿éƒ½å…¨éƒ¨éƒ½åŒ…åœ¨ class è£¡é¢\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eå»ºæ§‹æ­¤å°ˆæ¡ˆæœƒç”¨åˆ°çš„é‡è¦å¥—ä»¶ï¼š\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003ePackage\u003c/th\u003e\n\u003cth\u003eUsage\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ca href=\"https://expressjs.com/\"\u003eExpress\u003c/a\u003e\u003c/td\u003e\n\u003ctd\u003eWeb æ‡‰ç”¨æ¡†æ¶\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ca href=\"https://www.typescriptlang.org/\"\u003eTypeScript\u003c/a\u003e\u003c/td\u003e\n\u003ctd\u003eé–‹ç™¼å·¥å…·\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ca href=\"https://mongoosejs.com/\"\u003eMongoose\u003c/a\u003e\u003c/td\u003e\n\u003ctd\u003eè¨ªå•è³‡æ–™åº«\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ca href=\"https://www.docker.com/\"\u003eDocker\u003c/a\u003e\u003c/td\u003e\n\u003ctd\u003eæ‡‰ç”¨å®¹å™¨åŒ–\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ca href=\"https://www.mongodb.com/\"\u003eMongoDB\u003c/a\u003e\u003c/td\u003e\n\u003ctd\u003eå„²å­˜ä½¿ç”¨è€…çš„è³‡æ–™åº«\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ca href=\"https://www.npmjs.com/package/redis\"\u003eRedis\u003c/a\u003e\u003c/td\u003e\n\u003ctd\u003eå„²å­˜ä½¿ç”¨è€…ç·©å­˜çš„ session è³‡æ–™åº«\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ca href=\"https://github.com/auth0/node-jsonwebtoken\"\u003eJsonWebToken\u003c/a\u003e\u003c/td\u003e\n\u003ctd\u003eç”¢ç”Ÿ JWTs\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ca href=\"https://github.com/dcodeIO/bcrypt.js\"\u003eBcryptjs\u003c/a\u003e\u003c/td\u003e\n\u003ctd\u003eå¯†ç¢¼åŠ å¯†\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ca href=\"https://github.com/colinhacks/zod\"\u003eZod\u003c/a\u003e\u003c/td\u003e\n\u003ctd\u003eé©—è­‰ä½¿ç”¨è€…çš„è¼¸å…¥\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ca href=\"https://typegoose.github.io/typegoose/\"\u003eTypegoose\u003c/a\u003e\u003c/td\u003e\n\u003ctd\u003eä½¿ç”¨ TypeScript å„ªåŒ– Mongoose æ¨¡å‹\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ca href=\"https://github.com/motdotla/dotenv\"\u003eDotenv\u003c/a\u003e\u003c/td\u003e\n\u003ctd\u003eè®€å–ç’°å¢ƒè®Šæ•¸\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ca href=\"https://github.com/expressjs/cors\"\u003eCors\u003c/a\u003e\u003c/td\u003e\n\u003ctd\u003eå…è¨±è³‡æ–™èƒ½åœ¨å‰ç«¯èˆ‡å¾Œç«¯ä¹‹é–“åˆ†äº«\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ca href=\"https://lodash.com/\"\u003elodash\u003c/a\u003e\u003c/td\u003e\n\u003ctd\u003eå° JavaScript çš„åŠŸèƒ½æ“´å……\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ca href=\"https://github.com/wclr/ts-node-dev\"\u003ets-node-dev\u003c/a\u003e\u003c/td\u003e\n\u003ctd\u003eç•¶æª”æ¡ˆè®Šæ›´æ™‚è‡ªå‹•é‡å•Ÿ\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e","title":"Node.js + JWT Authentication å°ˆæ¡ˆ(ä¸€) - åˆå§‹åŒ–å°ˆæ¡ˆ"},{"content":" OAuth 2.0 æœ€å¤§çš„å„ªå‹¢æ˜¯å¯æ“´å±•æ€§èˆ‡æ¨¡å¡ŠåŒ–ï¼Œä½†é€™æ¨£çš„éˆæ´»æ€§ä¹Ÿå°è‡´æ–¼åœ¨ä¸åŒçš„å¯¦ç¾ä¹‹é–“ï¼Œæœƒå­˜åœ¨è‘—ç›¸å®¹æ€§å•é¡Œã€‚ç•¶é–‹ç™¼äººå“¡æƒ³åœ¨ä¸åŒçš„ç³»çµ±ä¸Šå¯¦ç¾ OAuth æ™‚ï¼Œå®ƒæä¾›å¾ˆå¤šçš„è‡ªå®šç¾©é¸é …å®¹æ˜“è®“äººå¾ˆå›°æƒ‘ã€‚\nOAuth 2.0 ä¸€å…±å®šç¾©äº† 7 ç¨®æˆæ¬Šé¡å‹ï¼Œå¯ä»¥æ ¹æ“šä¸åŒçš„æƒ…æ³èˆ‡ç’°å¢ƒä½¿ç”¨ä¸åŒçš„æ¨¡å¼ï¼š\nLegacy:Â å¯†ç¢¼æ¨¡å¼ ( Password Grant ) Legacy:Â éš±å«æ¨¡å¼ ( Implicit Flow ) æˆæ¬Šç¢¼ ( Authorization Code ) åˆ·æ–°ä»¤ç‰Œ ( Refresh Token ) å®¢æˆ¶æ†‘è­‰ ( Client Credentials ) PKCE ( Proof Key for Code Exchange ) è¨­å‚™ç¢¼ ( Device Code ) èµ·åˆï¼ŒOAuth è¨­è¨ˆæ˜¯åŸºæ–¼ HTTP çš„ï¼Œä½†å¯¦ç¾æ–¹æ³•çš„ç´°ç¯€å¯ä»¥æœ‰å¾ˆå¤šç¨®ã€‚\nåœ¨ä¸Šä¸€ç¯‡æœ‰æåˆ°ï¼ŒOAuth è£¡å®šç¾©çš„å››ç¨®è§’è‰²ã€‚å…¶ä¸­çš„å®¢æˆ¶ç«¯é‚„å¯ä»¥åˆ†ç‚ºå…©ç¨®ï¼š\nå‰ç«¯å®¢æˆ¶ç«¯ï¼šé€šå¸¸å‰ç«¯å®¢æˆ¶ç«¯æŒ‡çš„æ˜¯ç€è¦½å™¨ å¾Œç«¯å®¢æˆ¶ç«¯ï¼šå¾Œç«¯å®¢æˆ¶ç«¯æŒ‡çš„æ˜¯ï¼Œå¯¦éš›éœ€è¦å–å¾—å­˜å–æ¬Šæ– ( Access Token ) çš„æœå‹™ é€šå¸¸çš„æµç¨‹ç‚ºï¼š\nè³‡æºæ“æœ‰è€… é€éç€è¦½å™¨ç™»å…¥ ( æ­¤æ­¥é©Ÿæ„åŒç€è¦½å™¨å‘è³‡æºæ“æœ‰è€…æˆæ¬Šè«‹æ±‚ ) æˆæ¬Šä¼ºæœå™¨ é©—è­‰èº«åˆ†ä¸¦ç¢ºèªæˆæ¬Š æˆæ¬Šçµ¦å®¢æˆ¶ç«¯ ( ç²å¾—å­˜å–æ¬Šæ– ) å®¢æˆ¶ç«¯å–å¾—å—ä¿è­·çš„è³‡æº å®¢æˆ¶ç«¯æä¾›è³‡æºæ“æœ‰è€…æœå‹™ ä»¥ä¸Šæµç¨‹ç‚º 1.2. Protocol Flowã€‚\nLegacy: å¯†ç¢¼æ¨¡å¼ ( Password Grant ) +----------+ | Resource | | Owner | | | +----------+ v | Resource Owner (A) Password Credentials | v +---------+ +---------------+ | |\u0026gt;--(B)---- Resource Owner -------\u0026gt;| | | | Password Credentials | Authorization | | Client | | Server | | |\u0026lt;--(C)---- Access Token ---------\u0026lt;| | | | (w/ Optional Refresh Token) | | +---------+ +---------------+ Figure 5: Resource Owner Password Credentials Flow OAuth æœ‰ä¸€å€‹ç›´æ¥æ”¯æ´å¸³è™Ÿå¯†ç¢¼çš„æ–¹å¼ã€‚æˆæ¬Šçš„çµæœé‚„æ˜¯ç”±æˆæ¬Šä¼ºæœå™¨çš„æ¬Šæ–å’Œè³‡æºä¼ºæœå™¨æ±ºå®šï¼Œé€éä¸­å¤®æˆæ¬Šä¾†é™åˆ¶å­˜å–æ¬Šæ–å¯ä»¥åšä»€éº¼ï¼Œä½†æ˜¯ç›´æ¥ä½¿ç”¨å¸³è™Ÿå¯†ç¢¼é€™å€‹æ–¹å¼ä¸¦ä¸æ˜¯å¾ˆå¥½ã€‚\nä½¿ç”¨æ™‚æ©Ÿï¼šåœ¨å…¶ä»–æ¨¡å¼ä¸‹éƒ½ä¸å¤ªé©ç”¨æ™‚ï¼Œå†è€ƒæ…®é€™å€‹æ¨¡å¼ã€‚ Legacy:Â éš±å«æ¨¡å¼ ( Implicit Flow ) +----------+ | Resource | | Owner | | | +----------+ ^ | (B) +----|-----+ Client Identifier +---------------+ | -+----(A)-- \u0026amp; Redirection URI ---\u0026gt;| | | User- | | Authorization | | Agent -|----(B)-- User authenticates --\u0026gt;| Server | | | | | | |\u0026lt;---(C)--- Redirection URI ----\u0026lt;| | | | with Access Token +---------------+ | | in Fragment | | +---------------+ | |----(D)--- Redirection URI ----\u0026gt;| Web-Hosted | | | without Fragment | Client | | | | Resource | | (F) |\u0026lt;---(E)------- Script ---------\u0026lt;| | | | +---------------+ +-|--------+ | | (A) (G) Access Token | | ^ v +---------+ | | | Client | | | +---------+ Note: The lines illustrating steps (A) and (B) are broken into two parts as they pass through the user-agent. Figure 4: Implicit Grant Flow åœ¨å¯†ç¢¼æ¨¡å¼ ( Password Grant ) ä¸‹é©ç”¨æ–¼ç´”å‰ç«¯ç’°å¢ƒï¼›è€Œåœ¨éš±å«æ¨¡å¼ ( Implicit Flow ) ä¸‹å°±æ˜¯å‰å¾Œç«¯åˆ†é›¢ï¼Œè€Œå‰ç«¯çš„éƒ¨åˆ† ( User-agent ) å³å¯è¦–ç‚ºä¸€å€‹å®Œæ•´çš„æ‡‰ç”¨ã€‚\nOAuth Tools å¯¦ä½œ å¯ä»¥ä½¿ç”¨ OAuth.tools é€™å€‹ç·šä¸Šæœå‹™ä¾†å­¸ç¿’ï¼Œé»é¸ Demo: Implicit Flow å³å¯ã€‚\nå¯ä»¥çœ‹åˆ° Start Flow çš„ Start URL ç‚ºï¼š\nhttps://login-demo.curity.io/oauth/v2/oauth-authorize? \u0026amp;client_id=demo-web-client \u0026amp;response_type=token \u0026amp;redirect_uri=https://oauth.tools/callback/implicit \u0026amp;state=1599045172021-mww \u0026amp;scope=read%20phone%20email client_idã€response_typeã€redirect_uri æ˜¯å¿…é ˆçš„ã€‚\næŒ‰ä¸‹ Run å¾Œå¯èƒ½æœƒè¦æ±‚ç™»å…¥ ( éš¨ä¾¿æ‰“å³å¯ )ï¼Œç™»å…¥å¾Œå°±å¯ä»¥çœ‹åˆ° Server Response ( é€™å€‹ Server Response å°±æ˜¯å›å‚³çš„ URL åŠ ä¸Šç›¸é—œçš„è³‡è¨Š )ï¼š\nhttps://oauth.tools/callback/implicit #access_token=_0XBPWQQ_76c0d4ce-5424-4757-a0d1-0be0bc936d66 \u0026amp;scope=read+phone+email \u0026amp;iss=https%3A%2F%2Flogin-demo.curity.io%2Foauth%2Fv2%2Foauth-anonymous \u0026amp;state=1599045172021-mww \u0026amp;token_type=bearer \u0026amp;expires_in=299 token_type=bearer è¡¨ç¤ºæ¬Šæ–ç‚º bearer é¡å‹ã€‚\nåœ¨éš±å«æ¨¡å¼çš„è¨­è¨ˆä¸‹ï¼Œè³‡æºæ“æœ‰è€…ä½¿ç”¨çš„ç€è¦½å™¨æœƒèˆ‡æˆæ¬Šä¼ºæœå™¨ä¿æŒæœƒè©±éšæ®µã€‚ç°¡å–®ä¾†èªªï¼Œå°±æ˜¯ä½¿ç”¨è€…åœ¨ç™»å…¥ä¸­çš„æƒ…æ³ä¸‹ï¼Œå¯ä»¥éš¨æ™‚ç²å¾—æ–°çš„å­˜å–æ¬Šæ–ã€‚\nç‚ºä½•ç¨±ç‚ºéš±å«æ¨¡å¼ï¼Ÿ å¯ä»¥çœ‹åˆ° redirect_uri çš„ URL æŒ‡å‘çš„æ˜¯å®¢æˆ¶ç«¯ã€‚ç•¶ç€è¦½å™¨æ¥æ”¶åˆ°é€™å€‹è¨Šæ¯å¾Œï¼Œæœƒç™¼é€ä¸€å€‹è«‹æ±‚çµ¦ç”¨æˆ¶ç«¯ï¼Œä½†ä¸åŒçš„æ˜¯ï¼ŒçœŸæ­£çš„ç”¨æˆ¶ç«¯æ˜¯ç€è¦½å™¨æœ¬èº«çš„ Web Appï¼Œè€Œä¸æ˜¯æä¾› Web æœå‹™çš„ä¼ºæœå™¨è£¡ã€‚ä¹Ÿå› æ­¤å­˜å–æ¬Šæ–ä¸æœƒç™¼é€åˆ°ä¼ºæœå™¨ï¼Œè€Œæ˜¯ä¿ç•™åœ¨ç€è¦½å™¨è£¡é¢ï¼Œåœ¨ç€è¦½å™¨çš„ç¶²è·¯å·¥å…·ä¹Ÿå¹¾ä¹æ˜¯éš±è—çš„ã€‚\næ­¤æ¨¡å¼é›–ç„¶ç°¡å–®ï¼Œä½†å°‡å­˜å–æ¬Šæ–æš´éœ²åœ¨ä½¿ç”¨è€…é¢å‰ä¸¦ä¸æ˜¯éå¸¸å¥½çš„åšæ³•ï¼Œæœ€å¥½è¦å¿«é€Ÿæ¸…é™¤è¨Šæ¯æˆ–æ˜¯è½‰åˆ°å…¶ä»–é é¢ã€‚\nä¸æ‡‰è©²ä½¿ç”¨éš±å«æ¨¡å¼ é€šå¸¸åœ¨è™•ç†å®Œå­˜å–æ¬Šæ–å¾Œï¼Œæ‡‰è©²è¦è·³è½‰ç•«é¢æˆ–è‡³å°‘æŠŠè³‡è¨Šæ¸…é™¤ï¼Œå› ç‚ºæ¬Šæ–åœ¨ç¶²å€ä¸Šå¤ªå®¹æ˜“å–å¾—äº†ã€‚è€Œé€šå¸¸éœ€è¦æ³¨æ„çš„æ˜¯ XSS è·¨ç«™è…³æœ¬æ”»æ“Šã€‚\nå°±ç®—ä¸æ˜¯éš±å«æ¨¡å¼ï¼Œå¯èƒ½ä¹Ÿæœ‰è·³è½‰é é¢çš„éœ€è¦ï¼Œåœ¨è·³è½‰å¾Œï¼Œç¶²å€åˆ—ä¸Šé¢çš„ Token è‡ªç„¶æœƒæ¶ˆå¤±ã€‚ä½†æ˜¯ï¼Œç‚ºäº†è¦è®“è·³è½‰å¾Œçš„é é¢ä¹Ÿèƒ½å¤ çŸ¥é“å­˜å–æ¬Šæ–ï¼Œåœ¨é é¢è·³è½‰æ™‚ï¼Œå¯èƒ½æœƒå°‡å­˜å–æ¬Šæ–å„²å­˜åœ¨ localStorage æˆ– sessionStorage è£¡ã€‚\nçœ¾æ‰€çš†çŸ¥ï¼Œå°‡æ©Ÿæ•è³‡æ–™å„²å­˜åœ¨ localStorage æˆ– sessionStorage ä¸æ˜¯å®‰å…¨çš„ä½œæ³•ï¼Œå› ç‚º XSS æ”»æ“Šå¯ä»¥å¾ˆç°¡å–®çš„ç²å¾—è£¡é¢çš„è³‡æ–™ã€‚æˆ–è¨±å¯ä»¥ä½¿ç”¨ç‰¹åˆ¥çš„åŠ å¯†æ–¹å¼ï¼Œä¾†é™ä½å­˜å–æ¬Šæ–è¢«çŒœåˆ°çš„é¢¨éšªã€‚\næˆæ¬Šç¢¼ ( Authorization Code ) +----------+ | Resource | | Owner | | | +----------+ ^ | (B) +----|-----+ Client Identifier +---------------+ | -+----(A)-- \u0026amp; Redirection URI ----\u0026gt;| | | User- | | Authorization | | Agent -+----(B)-- User authenticates ---\u0026gt;| Server | | | | | | -+----(C)-- Authorization Code ---\u0026lt;| | +-|----|---+ +---------------+ | | ^ v (A) (C) | | | | | | ^ v | | +---------+ | | | |\u0026gt;---(D)-- Authorization Code ---------\u0026#39; | | Client | \u0026amp; Redirection URI | | | | | |\u0026lt;---(E)----- Access Token -------------------\u0026#39; +---------+ (w/ Optional Refresh Token) Note: The lines illustrating steps (A), (B), and (C) are broken into two parts as they pass through the user-agent. Figure 3: Authorization Code Flow Authorization Code æ˜¯ç¬¬ä¸€å€‹åœ¨ RFC 6749 è¢«æåˆ°çš„æµç¨‹ï¼Œæ‰€ä»¥æœ‰æ™‚å€™æœƒè¢«ç¨±ç‚º æ¨™æº–æµç¨‹ã€‚\nå®ƒåˆ†æˆå‰ç«¯é€šè¨Š ( Frontchannel ) å’Œ å¾Œç«¯é€šè¨Š ( Backchannel ) å…©å€‹éƒ¨åˆ†ã€‚èˆ‡å‰å…©å€‹ç›¸æ¯”ï¼Œåœ¨éš±å«æ¨¡å¼ä¸‹ï¼Œå¾Œç«¯é€šè¨Šèˆ‡å‰ç«¯é€šè¨Šæ˜¯ä½µåœ¨ä¸€èµ·çš„ï¼›å¯†ç¢¼æ¨¡å¼ä¸‹ï¼Œæ ¹æœ¬ä¸å­˜åœ¨å‰ç«¯é€šè¨Šï¼Œæ‰€ä»¥è³‡æºæ“æœ‰è€…éœ€è¦é«˜åº¦ä¿¡ä»»å®¢æˆ¶ç«¯ã€‚\nå†è¤‡ç¿’ä¸€ä¸‹å‰é¢çš„å››ç¨®è§’è‰²ï¼š\nè³‡æºæ“æœ‰è€… ( resource owner )ï¼šå°±æ˜¯ä½¿ç”¨è€… è³‡æºä¼ºæœå™¨ ( resource server )ï¼šå­˜æ”¾è³‡æ–™çš„ä¼ºæœå™¨ å®¢æˆ¶ç«¯ ( client ) å‰ç«¯å®¢æˆ¶ç«¯ï¼šç€è¦½å™¨æˆ– User-Agent å¾Œç«¯å®¢æˆ¶ç«¯ æˆæ¬Šä¼ºæœå™¨ ( authorization server )ï¼š é™¤äº†è³‡æºä¼ºæœå™¨ä»¥å¤–ï¼Œå…¶ä»–éƒ½æœƒåƒèˆ‡æˆæ¬Šæµç¨‹ï¼š\nå‰ç«¯é€šè¨Šï¼šæŒ‡çš„æ˜¯å‰ç«¯å®¢æˆ¶ç«¯èˆ‡æˆæ¬Šä¼ºæœå™¨ ( Authorization Server ) äº¤æ›è¨Šæ¯çš„éç¨‹ã€‚ å¾Œç«¯é€šè¨Šï¼šæŒ‡çš„æ˜¯å¾Œç«¯å®¢æˆ¶ç«¯ ( Client )Â èˆ‡Â æˆæ¬Šä¼ºæœå™¨ ( Authorization Server )Â äº¤æ›è¨Šæ¯çš„éç¨‹ã€‚ é€é OAuth.Tools å®Œæˆå‰ç«¯é€šè¨Š åœ¨ OAuth.Tools é é¢é»é¸ Demo: Code Flowã€‚\næŒ‰ä¸‹ Run ä¸€æ¨£æœƒé€²å…¥åˆ°ç™»å…¥ç•«é¢ã€‚æ­¤æ™‚çš„ Start Flowï¼š\nhttps://login-demo.curity.io/oauth/v2/oauth-authorize? \u0026amp;client_id=demo-web-client \u0026amp;response_type=code \u0026amp;redirect_uri=https://oauth.tools/callback/code \u0026amp;state=1599045135410-jFe \u0026amp;scope=openid%20profile%20read \u0026amp;ui_locales=en ç™»å…¥çµæŸå¾Œï¼Œä¸€æ¨£æœƒæ ¹æ“š redirect_uri å›åˆ°æŒ‡å®šçš„ URLã€‚é€™æ™‚å€™æœƒç™¼é€ä¸€å€‹ Request çµ¦ Web ä¼ºæœå™¨ï¼Œè€Œé€™å€‹ä¼ºæœå™¨å°±æ˜¯å®¢æˆ¶ç«¯ã€‚\næ¥è‘—å°±æ˜¯æœ€é‡è¦çš„å°±æ˜¯ query è£¡é¢çš„ codeï¼Œé€™å€‹ code æœƒçµ¦å®¢æˆ¶ç«¯ï¼Œä¸¦è®“å®¢æˆ¶ç«¯æ‹¿è‘— code å»å‘æˆæ¬Šä¼ºæœå™¨å…Œæ› ( redeem ) å­˜å–æ¬Šæ–ã€‚\né€™é‚Šå¯ä»¥é¸æ“‡æŒ‰ä¸‹ Redeem Code æŒ‰éˆ•ä¾†ç²å¾—å­˜å–æ¬Šæ–ï¼Œåˆæˆ–è€…ä½¿ç”¨å®ƒæ‰€æä¾›çš„ cURL ä¾†ç²å¾—ï¼Œåªèƒ½é¸æ“‡ä¸€ç¨®æ–¹æ³•ä½¿ç”¨ï¼Œå› ç‚ºä¸€å€‹ code åªèƒ½å…Œæ›ä¸€æ¬¡ã€‚\næµç¨‹ æœ€å¾Œä¾†æ•´ç†ä¸€ä¸‹æµç¨‹ï¼š\nåœ¨è³‡æºæ“æœ‰è€…ç™»å…¥å¾Œé©—è­‰èº«åˆ† è³‡æºæ“æœ‰è€…ä»£ç† ( User-Agent ) å‘ç³»çµ±ç”³è«‹ä¸€å€‹ code ( æœ‰æ™‚æ•ˆæ€§ã€åªèƒ½ä½¿ç”¨ä¸€æ¬¡ )ï¼Œä¸¦ä¸”å‘Šè¨´æˆæ¬Šä¼ºæœå™¨ï¼Œæœ‰äººæœƒåœ¨é™å®šçš„æ™‚é–“å…§ä½¿ç”¨é€™å€‹ç‰¹æ®Šå¯†ç¢¼ä¾†ç²å¾—ç‰¹å®šæˆ¿é–“çš„é‘°åŒ™ è³‡æºæ“æœ‰è€…ä»£ç† ( User-Agent ) æŠŠé€™å€‹ç‰¹æ®Šå¯†ç¢¼çµ¦æƒ³è¦æˆæ¬Šçš„å°è±¡ ( å®¢æˆ¶ç«¯ ) å®¢æˆ¶ç«¯ä½¿ç”¨ codeï¼Œå‘æˆæ¬Šä¼ºæœå™¨å…Œæ›å­˜å–æ¬Šæ– é€™å€‹æ¨¡å¼èˆ‡ç‰¹æ®Šå¯†ç¢¼å¾ˆåƒã€‚\nåˆ·æ–°ä»¤ç‰Œ ( Refresh Token ) +--------+ +---------------+ | |--(A)------- Authorization Grant ---------\u0026gt;| | | | | | | |\u0026lt;-(B)----------- Access Token -------------| | | | \u0026amp; Refresh Token | | | | | | | | +----------+ | | | |--(C)---- Access Token ----\u0026gt;| | | | | | | | | | | |\u0026lt;-(D)- Protected Resource --| Resource | | Authorization | | Client | | Server | | Server | | |--(E)---- Access Token ----\u0026gt;| | | | | | | | | | | |\u0026lt;-(F)- Invalid Token Error -| | | | | | +----------+ | | | | | | | |--(G)----------- Refresh Token -----------\u0026gt;| | | | | | | |\u0026lt;-(H)----------- Access Token -------------| | +--------+ \u0026amp; Optional Refresh Token +---------------+ Figure 2: Refreshing an Expired Access Token ä½¿ç”¨ refresh_token ä¾†å–å¾— access_token é€™æ˜¯æœ€ç°¡å–®çš„ä¸€å€‹æ¨¡å¼äº†ã€‚ä¹Ÿå› ç‚ºå…ˆæ±ºæ¢ä»¶æ˜¯å¿…é ˆè¦æœ‰ Refresh Tokenï¼Œæ‰€ä»¥ç„¡æ³•å–®ç¨å­˜åœ¨ã€‚\nä¸Šé¢çš„æµç¨‹åœ–æœ€é‡è¦çš„æ˜¯æ­¥é©Ÿ (G) å’Œ (H)ï¼Œå› ç‚ºå¦‚ä½•å–å¾— Refresh Token çš„æ–¹å¼æœ‰å¾ˆå¤šç¨®ï¼Œä¸è«–æ˜¯å¯†ç¢¼æ¨¡å¼æˆ–æ˜¯ Authorization Code æ¨¡å¼ä¸‹éƒ½æœ‰å¯èƒ½è¿”å› refresh_token äº†ã€‚\nå»¶çºŒä¸Šé¢æˆæ¬Šç¢¼ ( Authorization Code ) æ‰€ç²å¾—çš„ Tokenï¼š\nä¹‹å¾Œé»é¸ OAuth.Tools è£¡çš„ Demo: Refresh Tokens ä¾†ä½¿ç”¨å‰›å‰› Authorization Code çš„ Refresh Tokenï¼š\næˆ‘å€‘å¯ä»¥é¸æ“‡è¦ä½¿ç”¨å“ªå€‹ Demo çš„ refresh_tokenï¼Œä¹‹å¾ŒæŒ‰ä¸‹ Refresh Token å°±å¯ä»¥çœ‹åˆ°æ–°ç”¢ç”Ÿçš„å­˜å–æ¬Šæ–ã€‚\nrefresh_token çš„ä½œç”¨ Qï¼šæ—¢ç„¶éƒ½é€éå¯†ç¢¼æ¨¡å¼èˆ‡ Authorization Code æ¨¡å¼å–å¾—å­˜å–æ¬Šæ–äº†ï¼Œé‚£ç‚ºä½•é‚„éœ€è¦ refresh_token å‘¢ï¼Ÿ\nAï¼šé€™æ˜¯å› ç‚ºå­˜å–æ¬Šæ–æ˜¯æœƒéæœŸçš„ï¼Œå¦‚æœæ¯æ¬¡éæœŸéƒ½éœ€è¦è³‡æºæ“æœ‰è€…å†ç™»å…¥ä¸€æ¬¡ï¼Œé‚£æ˜¯ä¸æ˜¯è¶…éº»ç…©çš„ï¼Œæ‰€ä»¥æ‰æœ‰é€™å€‹ refresh_tokenï¼Œé€™åŒæ¨£ä¹Ÿåƒç‰¹æ®Šå¯†ç¢¼ã€‚ä½†æ˜¯èˆ‡ Authorization Code æ¨¡å¼ä¸‹ç²å¾—çš„é‚£å€‹ code çš„ç‰¹æ®Šå¯†ç¢¼ä¸åŒçš„æ˜¯ï¼Œåœ¨é™å®šçš„æ™‚é–“å…§ï¼Œå¯ä»¥é€é refresh_token ç²å–å¤šæ¬¡çš„å­˜å–æ¬Šæ– (code åªèƒ½ä½¿ç”¨ä¸€æ¬¡)ã€‚è€Œä¸”ä¹Ÿèˆ‡ access_token ä¸åŒï¼Œrefresh_token ä½¿ç”¨çš„åœ°æ–¹æ˜¯åœ¨å®¢æˆ¶ç«¯èˆ‡æˆæ¬Šä¼ºæœå™¨ï¼›access_token ä½¿ç”¨çš„åœ°æ–¹æ˜¯åœ¨å®¢æˆ¶ç«¯èˆ‡è³‡æºä¼ºæœå™¨ã€‚\nèˆ‡ access_token ç›¸æ¯”ï¼Œrefresh_token ä½¿ç”¨çš„é »ç‡æ²’æœ‰é‚£éº¼é«˜ï¼Œç›¸å°ä¹Ÿå°±ä¸å®¹æ˜“è¢«ç«Šå–ï¼Œå­˜æ´»çš„æ™‚é–“ä¹Ÿæ¯”è¼ƒä¹…ï¼Œè—‰ç”±å›ºå®šä¸€æ®µæ™‚é–“æ›´æ–° access_token çš„æ–¹å¼ï¼Œä¹Ÿèƒ½é™ä½ä¸€äº›å®‰å…¨å•é¡Œã€‚\næœ€å¾Œï¼Œrefresh_token å¯ä»¥ä½¿ç”¨å¹¾æ¬¡ã€å¤šé•·æ™‚é–“ã€æ˜¯å¦æœƒè¿”å› refresh_tokenï¼Œå…¨éƒ¨éƒ½æ˜¯ç”±æˆæ¬Šä¼ºæœå™¨æ±ºå®šçš„ï¼Œä¹Ÿå°±æ˜¯ä¾ç…§æ‰€éœ€è¦çš„æ‡‰ç”¨ç’°å¢ƒã€å­˜åœ¨çš„å®‰å…¨é¢¨éšªã€ä½¿ç”¨ä¸åŒçš„ç­–ç•¥ã€‚ä½ å¯èƒ½é »ç¹çš„æ›´æ› access_token å’Œ refresh_tokenï¼Œä¹Ÿå¯èƒ½ä¸€ç”¨å°±æ˜¯ä¸€å¹´ã€‚\nå®¢æˆ¶æ†‘è­‰ ( Client Credentials ) +---------+ +---------------+ | | | | | |\u0026gt;--(A)- Client Authentication ---\u0026gt;| Authorization | | Client | | Server | | |\u0026lt;--(B)---- Access Token ---------\u0026lt;| | | | | | +---------+ +---------------+ Figure 6: Client Credentials Flow é€™å€‹æ¨¡å¼å¾ˆç‰¹åˆ¥ï¼Œå®ƒå¯èƒ½æœƒèˆ‡å…¶ä»–æ¨¡å¼ä¸¦ç”¨ä»¥å¤–ï¼Œæœ€ç‰¹åˆ¥çš„æ˜¯ï¼Œå¦‚æœåªæ˜¯å–®ç´”ä½¿ç”¨å®ƒï¼Œæ˜¯å®Œå…¨ä¸éœ€è¦è³‡æºæ“æœ‰è€…åƒèˆ‡çš„ã€‚\nåœ¨ OAuth.Tools é é¢é»é¸ Demo: Client Credentials Flowã€‚\nç›´æ¥æŒ‰ä¸‹ Run å¾Œå¯ä»¥çœ‹åˆ°å›å‚³çš„çµæœï¼š\nå¯ä»¥ç™¼ç¾å®ƒèˆ‡éš±å«æ¨¡å¼ä¸€æ¨£éƒ½æ²’æœ‰ refresh_tokenï¼Œé€™æ˜¯å› ç‚º client_secret åªæœ‰å®¢æˆ¶ç«¯æ“æœ‰ï¼Œä¸æœƒé€åˆ°ç€è¦½å™¨å»åƒèˆ‡å‰ç«¯é€šè¨Šã€‚ä¹Ÿå› ç‚ºä¸å­˜åœ¨å‰ç«¯é€šè¨Šï¼Œè‡ªç„¶å°±ä¸æœƒçŸ¥é“è³‡æºæ“æœ‰è€…æ˜¯èª°äº†ã€‚\nä¹Ÿå› ç‚º client_secret åªæœ‰å®¢æˆ¶ç«¯æ“æœ‰ï¼Œæ‰€ä»¥å®¢æˆ¶ç«¯å¯ä»¥éš¨æ™‚å–å¾— access_tokenã€‚é€™å°±åƒå®¢æˆ¶ç«¯å»ºç«‹äº†ä¸€å€‹å¸³è™Ÿç³»çµ±ï¼Œclient_id å°±æ˜¯å¸³è™Ÿï¼›client_secretå°±æ˜¯å¯†ç¢¼ã€‚\nPKCE ( Proof Key for Code Exchange ) +-------------------+ | Authz Server | +--------+ | +---------------+ | | |--(A)- Authorization Request ----\u0026gt;| | | | | + t(code_verifier), t_m | | Authorization | | | | | | Endpoint | | | |\u0026lt;-(B)---- Authorization Code -----| | | | | | +---------------+ | | Client | | | | | | +---------------+ | | |--(C)-- Access Token Request ----\u0026gt;| | | | | + code_verifier | | Token | | | | | | Endpoint | | | |\u0026lt;-(D)------ Access Token ---------| | | +--------+ | +---------------+ | +-------------------+ Figure 2: Abstract Protocol Flow PKCE æ˜¯ Authorization Code çš„å®‰å…¨å¼·åŒ–ç‰ˆã€‚\nåœ¨æ•´å€‹éç¨‹æ·»åŠ äº†å…©å€‹å‹•ä½œï¼šç”¢ç”Ÿ code_verifier å’Œ code_challengeï¼Œä¸¦ä¸”åœ¨æœ€å¾Œé€é code_challenge é©—è­‰ code_verifierã€‚æœ€å¤§çš„ç›®çš„å°±æ˜¯å»ºç«‹å‰ç«¯é€šè¨Šèˆ‡å¾Œç«¯é€šè¨Šçš„é—œè¯ã€‚\nåŸå§‹çš„é¢¨éšª Authorization Code çš„æµç¨‹æ˜¯ï¼š\nåœ¨è³‡æºæ“æœ‰è€…ç™»å…¥å¾Œé©—è­‰èº«åˆ† è³‡æºæ“æœ‰è€…ä»£ç† ( User-Agent ) å‘ç³»çµ±ç”³è«‹ä¸€å€‹ code è³‡æºæ“æœ‰è€…ä»£ç† ( User-Agent ) å°‡ code è½‰çµ¦å®¢æˆ¶ç«¯ å®¢æˆ¶ç«¯ä½¿ç”¨ codeï¼Œå‘æˆæ¬Šä¼ºæœå™¨å…Œæ›å­˜å–æ¬Šæ– å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„æµç¨‹ï¼Œcode å¯èƒ½é€éç¶²è·¯å‚³éäº†å¾ˆå¤šæ¬¡ã€‚å‚³éè¶Šå¤šæ¬¡å°±ä»£è¡¨æ´©æ¼çš„é¢¨éšªå°±è¶Šé«˜ï¼Œæ”»æ“Šè€…å°±æœ‰å¯èƒ½åœ¨é€™ä¸­é–“å–å¾—å­˜å–æ¬Šæ–ã€‚\nä»¥ä¸‹æ˜¯æƒ¡æ„æ‡‰ç”¨ç«Šå– code çš„æ–¹å¼ï¼š\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~+ | End Device (e.g., Smartphone) | | | | +-------------+ +----------+ | (6) Access Token +----------+ | |Legitimate | | Malicious|\u0026lt;--------------------| | | |OAuth 2.0 App| | App |--------------------\u0026gt;| | | +-------------+ +----------+ | (5) Authorization | | | | ^ ^ | Grant | | | | \\ | | | | | | \\ (4) | | | | | (1) | \\ Authz| | | | | Authz| \\ Code | | | Authz | | Request| \\ | | | Server | | | \\ | | | | | | \\ | | | | | v \\ | | | | | +----------------------------+ | | | | | | | (3) Authz Code | | | | Operating System/ |\u0026lt;--------------------| | | | Browser |--------------------\u0026gt;| | | | | | (2) Authz Request | | | +----------------------------+ | +----------+ åœ¨ (4) é€™å€‹æ­¥é©Ÿï¼Œæƒ¡æ„æ‡‰ç”¨ ( Malicious App ) å°±å¯èƒ½æˆªå–åˆ° codeã€‚å°±ç®—ä¸æ˜¯ç›´æ¥æˆªå–ï¼Œä¹Ÿå¯èƒ½é€šéé€™ç¨®æ–¹å¼ä¾†çŒœæ¸¬åˆ° codeã€‚\næ‰€ä»¥ï¼Œç‚ºäº†é™ä½è¢«æ”»æ“Šçš„æ©Ÿæœƒï¼Œå¯ä»¥æ·»åŠ ä¸€äº›åŠ å¯†æ–¹å¼ï¼Œä¾†æå‡æ”»æ“Šçš„é›£åº¦ã€‚é…åˆä½¿ç”¨ Client Credentials Flow æˆ–è¨±æ˜¯ä¸€å€‹æ–¹æ³•ï¼Œå› ç‚ºä¾ç…§è¨­è¨ˆ client_secret åªæœ‰å®¢æˆ¶ç«¯æ“æœ‰ï¼Œä¸¦ä¸”åªåœ¨å®¢æˆ¶ç«¯èˆ‡æˆæ¬Šä¼ºæœå™¨é–“æµé€šã€‚ä½†é€™æ¨£åšçš„å‰æç‚ºå®¢æˆ¶ç«¯æ˜¯å·²ç¶“è¢«èªå¯çš„å®¢æˆ¶ç«¯ï¼Œé€™é‚„æ˜¯æ²’è¾¦æ³•è­‰æ˜å®¢æˆ¶ç«¯ã€è³‡æºæ“æœ‰è€…ã€ä½¿ç”¨ code å…Œæ›å­˜å–æ¬Šæ– éƒ½æ˜¯åŒä¸€å€‹äººã€‚\nè§£æ±ºæ–¹æ³• é‚£è¦å¦‚ä½•è®“å‰ç«¯é€šè¨Šèˆ‡å¾Œç«¯é€šè¨Šå»ºç«‹æ›´æ˜ç¢ºçš„é—œä¿‚ï¼Ÿå®¢æˆ¶ç«¯èƒ½ç”¨ä»€éº¼æ–¹å¼ä¾†è­‰æ˜æ˜¯è‡ªå·±æ˜¯æˆæ¬Šçš„é‚£ä¸€å€‹ï¼Ÿ\nä»¥ä¸‹æ˜¯æµç¨‹ï¼š\nå®¢æˆ¶ç«¯å‘Šè¨´ç€è¦½å™¨è­‰æ˜è‡ªå·±çš„æ–¹å¼ï¼Œä¸¦è®“ç€è¦½å™¨å°‡é€™å€‹è¨Šæ¯å‘Šè¨´æˆæ¬Šä¼ºæœå™¨ã€‚ ç€è¦½å™¨å–å¾—ç‰¹æ®Šå¯†ç¢¼ codeï¼Œä¸¦èˆ‡æˆæ¬Šä¼ºæœå™¨ç´„å®šå¥½ï¼Œåœ¨æœªä¾†ï¼Œæœƒæœ‰ä¸€å€‹äººå¸¶è‘—é€™å€‹ code èˆ‡ä¸€å€‹èƒ½è­‰æ˜è‡ªå·±å°±æ˜¯é€™å€‹äººçš„æ–¹æ³•ä¾†æ‰¾ä½ ã€‚ ç€è¦½å™¨å°‡ code äº¤çµ¦å®¢æˆ¶ç«¯ã€‚ å®¢æˆ¶ç«¯å¸¶è‘— code èˆ‡è­‰æ˜è‡ªå·±çš„æ–¹å¼è¨ªå•æˆæ¬Šä¼ºæœå™¨ã€‚ æˆæ¬Šä¼ºæœå™¨æœƒæª¢æŸ¥ code èˆ‡è­‰æ˜çš„æ–¹å¼ï¼Œå¦‚æœç¬¦åˆï¼Œå°±æœƒå°‡å­˜å–æ¬Šæ–äº¤çµ¦å®¢æˆ¶ç«¯ã€‚ é‚£è¦å¦‚ä½•è­‰æ˜è‡ªå·±çš„èº«åˆ†å‘¢ï¼Ÿé‚£å°±æ˜¯æœ‰ä¸€å€‹å¾ˆå›°é›£çš„å•é¡Œï¼Œé€™å€‹å•é¡Œçš„ç­”æ¡ˆåªæœ‰è‡ªå·±çŸ¥é“ã€‚è€Œä¸”é€™å€‹é¡Œç›®çš„ç­”æ¡ˆå¾ˆé›£æ¨æ•²å‡ºä¾†ï¼Œå¾é¡Œç›®è­‰æ˜ç­”æ¡ˆæ˜¯å¦æ­£ç¢ºå¾ˆå®¹æ˜“ã€‚\né€™å€‹æ–¹å¼å°±æ˜¯å–®å‘é›œæ¹Šå‡½æ•¸( One-way Hash Function )ã€‚å¾ä¸€å€‹æ–¹å‘é‹ç®—å¾ˆç°¡å–®ï¼Œä½†åéä¾†å¾ˆé›£ã€‚åœ¨ RFC 7636 ï¼ 4.6 å°±è¨­å®šäº† code_challenge æ˜¯ç”± SHA-256 ä¾†çµ„æˆé€™å€‹é›£é¡Œï¼Œåªè¦ code_verifier æ­£ç¢ºï¼Œå°±èƒ½å¤ è­‰æ˜è‡ªå·±çš„èº«åˆ†äº†ã€‚\nä½¿ç”¨ OAuth Tools å¯¦ä½œ åœ¨ OAuth.Tools é é¢é»é¸ Demo: Code Flowï¼Œä¸¦å‹¾é¸ Use PKCE çš„é¸é …ã€‚\næ¥è‘—ï¼Œå¯ä»¥çœ‹åˆ° Start Flow å¤šå‡º code_challenge èˆ‡ code_challenge_methodï¼š\nhttps://login-demo.curity.io/oauth/v2/oauth-authorize? \u0026amp;client_id=demo-web-client \u0026amp;response_type=code \u0026amp;redirect_uri=https://oauth.tools/callback/code \u0026amp;state=1599045135410-jFe \u0026amp;scope=openid%20profile%20read --- \u0026amp;code_challenge=mSrwhFdk8l_oSJvSdiyLtVe2SLf5o0hvH4h4xOnLpAU \u0026amp;code_challenge_method=S256 --- \u0026amp;prompt=login \u0026amp;ui_locales=en \u0026amp;nonce=1599046102647-dv4 ä¸¦ä¸”åœ¨å¾Œç«¯é€šè¨Š ( ä¹Ÿå°±æ˜¯å…Œæ›å­˜å–æ¬Šæ–æ™‚ ) å°‡ç­”æ¡ˆå‘Šè¨´æˆæ¬Šä¼ºæœå™¨ï¼š\ncurl -Ss -X POST \\ https://login-demo.curity.io/oauth/v2/oauth-token \\ -H \u0026#39;Authorization: Basic ZGVtby13ZWItY2xpZW50OjZrb3luOUtwUnVvZll0MlU=\u0026#39; \\ -H \u0026#39;Content-Type: application/x-www-form-urlencoded\u0026#39; \\ -d \u0026#39;grant_type=authorization_code\u0026amp;redirect_uri=https%3A%2F%2Foauth.tools%2Fcallback%2Fcode\u0026amp;code=rtNEXkJGpsiaiPd198FK8teHJsjOAYWm\u0026amp; code_verifier=1Ex9PnVFClsom1mlAKVyRSTKmXpKi26a8qXfK8KSBdNJgh3hNxdrwtDq4uj01Rt3\u0026#39; å¦‚æœé©—è­‰å¤±æ•—ï¼Œä¸æœƒé€šéæˆæ¬Šä¸¦ä¸” code æœƒè¢«èªæœƒå¯èƒ½å·²æ´©æ¼ï¼Œæ‰€ä»¥å°±ä¸èƒ½å†ä½¿ç”¨ã€‚å¦‚æœé€šéï¼Œå°±èƒ½ç²å¾—å­˜å–æ¬Šæ–ã€‚\nè¨­å‚™ç¢¼ ( Device Code ) +----------+ +----------------+ | |\u0026gt;---(A)-- Client Identifier ---\u0026gt;| | | | | | | |\u0026lt;---(B)-- Device Code, ---\u0026lt;| | | | User Code, | | | Device | \u0026amp; Verification URI | | | Client | | | | | [polling] | | | |\u0026gt;---(E)-- Device Code ---\u0026gt;| | | | \u0026amp; Client Identifier | | | | | Authorization | | |\u0026lt;---(F)-- Access Token ---\u0026lt;| Server | +----------+ (\u0026amp; Optional Refresh Token) | | v | | : | | (C) User Code \u0026amp; Verification URI | | : | | v | | +----------+ | | | End User | | | | at |\u0026lt;---(D)-- End user reviews ---\u0026gt;| | | Browser | authorization request | | +----------+ +----------------+ Figure 1: Device Authorization Flow Device Code çš„æµç¨‹èˆ‡å‰é¢å¹¾å€‹éƒ½ä¸ç›¸åŒã€‚ä»¥å¾€éƒ½æ˜¯å¾ç™»å…¥é–‹å§‹ï¼Œç„¶å¾Œè·³è½‰é é¢å›åˆ° App ( å®¢æˆ¶ç«¯ )ã€‚ä¹Ÿå°±æ˜¯å…ˆæœ‰å‰ç«¯é€šè¨Šï¼Œå†æœ‰å¾Œç«¯é€šè¨Šã€‚\nä½† Device Code ä¸æ˜¯ç”±è³‡æºæ“æœ‰è€…ç™¼èµ·ï¼Œè€Œæ˜¯å®¢æˆ¶ç«¯ç™¼èµ·ã€‚å¤§è‡´æµç¨‹ç‚ºï¼š\nå®¢æˆ¶ç«¯ç™¼èµ·ï¼Œå‘æˆæ¬Šä¼ºæœå™¨å–å¾— device_code å’Œ user_codeã€‚ å®¢æˆ¶ç«¯å°‡ user_code äº¤çµ¦è³‡æºæ“æœ‰è€…ï¼Œè‡ªå·±å‰‡ä¿ç•™ device_codeã€‚ è³‡æºæ“æœ‰è€…é€é Endpoint èˆ‡ user_code é€²è¡Œæˆæ¬Šã€‚ å®¢æˆ¶ç«¯ä½¿ç”¨ device_code è¨ªå•æˆæ¬Šä¼ºæœå™¨æ˜¯å¦æœ‰äººæˆæ¬Šçµ¦å®ƒã€‚ user_code åƒæ˜¯ä¹‹å‰çš„ç‰¹æ®Šå¯†ç¢¼ï¼›device_code æ›´åƒæ˜¯ sessionã€‚\nå¯ä»¥åˆ° OAuth 2.0 Playground å˜—è©¦ã€‚\né¦–å…ˆï¼Œç²å¾—ä¾†è‡ªæˆæ¬Šä¼ºæœå™¨çš„æ‰€æœ‰è³‡è¨Šï¼š\n{ \u0026#34;device_code\u0026#34;: \u0026#34;NGU5OWFiNjQ5YmQwNGY3YTdmZTEyNzQ3YzQ1YSA\u0026#34;, \u0026#34;user_code\u0026#34;: \u0026#34;BDWD-HQPK\u0026#34;, \u0026#34;verification_uri\u0026#34;: \u0026#34;https://example.okta.com/device\u0026#34;, \u0026#34;interval\u0026#34;: 5, \u0026#34;expires_in\u0026#34;: 1800 } ç•¶ç¬¬ä¸€æ¬¡é» poll æ™‚ï¼Œæœƒçœ‹åˆ°ï¼š\nHTTP/1.1 400 Bad Request { \u0026#34;error\u0026#34;: \u0026#34;authorization_pending\u0026#34; } é€™è¡¨ç¤ºè³‡æºæ“æœ‰è€…é‚„æ²’æœ‰å®Œæˆç™»å…¥æˆæ¬Šçš„è«‹æ±‚ï¼Œæ‰€ä»¥æˆæ¬Šä¼ºæœå™¨æœƒå›å‚³ç­‰å¾…æˆæ¬Šã€‚ç•¶è³‡æºæ“æœ‰è€…å®Œæˆè«‹æ±‚å¾Œï¼Œå®¢æˆ¶ç«¯å°±å¯ä»¥æ‹¿åˆ°å­˜å–æ¬Šæ–äº†ï¼š\nHTTP/1.1 200 OK { \u0026#34;token_type\u0026#34;: \u0026#34;Bearer\u0026#34;, \u0026#34;access_token\u0026#34;: \u0026#34;RsT5OjbzRn430zqMLgV3Ia\u0026#34;, \u0026#34;expires_in\u0026#34;: 3600, \u0026#34;refresh_token\u0026#34;: \u0026#34;b7a3fac6b10e13bb3a276c2aab35e97298a060e0ede5b43ed1f720a8\u0026#34; } ä½¿ç”¨ä¾‹å­ ä½¿ç”¨ Device Code çš„æ–¹å¼éš¨è™•å¯è¦‹ï¼š\nä½¿ç”¨ QR Code ç™»å…¥çš„æ‡‰ç”¨ ( ç‰¹æ®Šé€£æ¥ç™»å…¥çš„æ‡‰ç”¨ ) QR Code åŒæ¨£æ˜¯ä¸€å€‹ç‰¹æ®Šé€£çµã€‚ çµèª å°æˆ‘ä¾†èªªï¼Œè¦å¼„æ¸…æ¥šå…¶ä¸­é‹ä½œçš„æµç¨‹æ˜¯éœ€è¦ä¸€é»æƒ³åƒåŠ›çš„ï¼Œä¹Ÿå¤šè™§æœ‰ ç”¨Keycloakå­¸ç¿’èº«ä»½é©—è­‰èˆ‡æˆæ¬Š é€™ä¸€ç³»åˆ—çš„æ–‡ç« å¹«åŠ©æˆ‘ç†è§£ã€‚\nReference ç”¨Keycloakå­¸ç¿’èº«ä»½é©—è­‰èˆ‡æˆæ¬Š ğŸ‘ RFC 6749 RFC 7637 RFC 8628 OAuth Tools OAuth2 Playground ","permalink":"https://et860525.github.io/posts/oauth-grant/","summary":"OAuth 2.0 æœ€å¤§çš„å„ªå‹¢æ˜¯å¯æ“´å±•æ€§èˆ‡æ¨¡å¡ŠåŒ–ï¼Œä½†é€™æ¨£çš„éˆæ´»æ€§ä¹Ÿå°è‡´æ–¼åœ¨ä¸åŒçš„å¯¦ç¾ä¹‹é–“ï¼Œæœƒå­˜åœ¨è‘—ç›¸å®¹æ€§å•é¡Œã€‚ç•¶é–‹ç™¼äººå“¡æƒ³åœ¨ä¸åŒçš„ç³»çµ±ä¸Šå¯¦ç¾ OAuth æ™‚ï¼Œå®ƒæä¾›å¾ˆå¤šçš„è‡ªå®šç¾©é¸é …å®¹æ˜“è®“äººå¾ˆå›°æƒ‘ã€‚\nOAuth 2.0 ä¸€å…±å®šç¾©äº† 7 ç¨®æˆæ¬Šé¡å‹ï¼Œå¯ä»¥æ ¹æ“šä¸åŒçš„æƒ…æ³èˆ‡ç’°å¢ƒä½¿ç”¨ä¸åŒçš„æ¨¡å¼ï¼š\nLegacy:Â å¯†ç¢¼æ¨¡å¼ ( Password Grant ) Legacy:Â éš±å«æ¨¡å¼ ( Implicit Flow ) æˆæ¬Šç¢¼ ( Authorization Code ) åˆ·æ–°ä»¤ç‰Œ ( Refresh Token ) å®¢æˆ¶æ†‘è­‰ ( Client Credentials ) PKCE ( Proof Key for Code Exchange ) è¨­å‚™ç¢¼ ( Device Code ) èµ·åˆï¼ŒOAuth è¨­è¨ˆæ˜¯åŸºæ–¼ HTTP çš„ï¼Œä½†å¯¦ç¾æ–¹æ³•çš„ç´°ç¯€å¯ä»¥æœ‰å¾ˆå¤šç¨®ã€‚\nåœ¨ä¸Šä¸€ç¯‡æœ‰æåˆ°ï¼ŒOAuth è£¡å®šç¾©çš„å››ç¨®è§’è‰²ã€‚å…¶ä¸­çš„å®¢æˆ¶ç«¯é‚„å¯ä»¥åˆ†ç‚ºå…©ç¨®ï¼š\nå‰ç«¯å®¢æˆ¶ç«¯ï¼šé€šå¸¸å‰ç«¯å®¢æˆ¶ç«¯æŒ‡çš„æ˜¯ç€è¦½å™¨ å¾Œç«¯å®¢æˆ¶ç«¯ï¼šå¾Œç«¯å®¢æˆ¶ç«¯æŒ‡çš„æ˜¯ï¼Œå¯¦éš›éœ€è¦å–å¾—å­˜å–æ¬Šæ– ( Access Token ) çš„æœå‹™ é€šå¸¸çš„æµç¨‹ç‚ºï¼š\nè³‡æºæ“æœ‰è€… é€éç€è¦½å™¨ç™»å…¥ ( æ­¤æ­¥é©Ÿæ„åŒç€è¦½å™¨å‘è³‡æºæ“æœ‰è€…æˆæ¬Šè«‹æ±‚ ) æˆæ¬Šä¼ºæœå™¨ é©—è­‰èº«åˆ†ä¸¦ç¢ºèªæˆæ¬Š æˆæ¬Šçµ¦å®¢æˆ¶ç«¯ ( ç²å¾—å­˜å–æ¬Šæ– ) å®¢æˆ¶ç«¯å–å¾—å—ä¿è­·çš„è³‡æº å®¢æˆ¶ç«¯æä¾›è³‡æºæ“æœ‰è€…æœå‹™ ä»¥ä¸Šæµç¨‹ç‚º 1.","title":"OAuth Grant"},{"content":" OAuth æ˜¯ä¸€å€‹é–‹æ”¾æ¨™æº–çš„æˆæ¬Šå”è­°ï¼Œå®ƒå…è¨±ä½¿ç”¨è€…è®“ç¬¬ä¸‰æ–¹æ‡‰ç”¨å­˜å–è©²ä½¿ç”¨è€…åœ¨æŸç¶²ç«™å„²å­˜çš„ç§å¯†è³‡æºã€‚\nè©¦æƒ³æœ‰ä¸€æ£Ÿæˆ¿å­ï¼Œè£¡é¢æœ‰å¾ˆå¤šå€‹æˆ¿é–“ï¼Œè£¡é¢æœ‰ä¸€ä½æˆ¿æ± ( ä½¿ç”¨è€… ) æ“æœ‰ä¸€æŠŠè¬èƒ½é‘°åŒ™ï¼Œå¯ä»¥é–‹å•Ÿæ‰€æœ‰çš„æˆ¿é–“é–€ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œé€™æŠŠè¬èƒ½é‘°åŒ™é‚„æœ‰ä¸€å€‹ä½œç”¨ï¼Œå°±æ˜¯å¯ä»¥ç”¢å‡ºç‰¹å®šé–€çš„é‘°åŒ™ï¼Œè€Œç”¢ç”Ÿå‡ºä¾†çš„é‘°åŒ™å¯ä»¥äº¤çµ¦å…¶ä»–äººï¼Œé€™æ¨£å…¶ä»–äººå°±å¯ä»¥é€²å‡ºç‰¹å®šçš„æˆ¿é–“ï¼Œé€™å€‹å‹•ä½œå°±æ˜¯ã€Œæˆæ¬Šã€ã€‚\nOAuth 2.0 æ˜¯ OAuth çš„é€²åŒ–ç‰ˆï¼Œå®ƒæ˜¯æˆæ¬Šæ¡†æ¶ ( authorization framework )ï¼Œå…è¨±æ‡‰ç”¨å‘ä½¿ç”¨è€…è«‹æ±‚æˆæ¬Šï¼Œç„¶å¾Œå–å¾— Tokenï¼Œä¸¦ä¸”ç”¨å®ƒä¾†è¨ªå•è³‡æºã€‚\nThe OAuth 2.0 authorization framework enables a third-party application to obtain limited access to an HTTP service, either on behalf of a resource owner by orchestrating an approval interaction between the resource owner and the HTTP service, or by allowing the third-party application to obtain access on its own behalf. ï¼ RFC 6749\nOAuth 2.0 æˆæ¬Šæ¡†æ¶èƒ½è®“ç¬¬ä¸‰æ–¹æ‡‰ç”¨ä»¥æœ‰é™çš„æ–¹å¼è¨ªå• HTTP æœå‹™ï¼Œå»ºæ§‹è³‡æºæ“æœ‰è€…èˆ‡ HTTP æœå‹™ä¹‹é–“çš„è¨±å¯äº¤äº’æ©Ÿåˆ¶ï¼Œæˆ–æ˜¯é€šéç¬¬ä¸‰æ–¹æ‡‰ç”¨ä»£è¡¨è‡ªå·±è¨ªå•æœå‹™ã€‚\nä½œç‚ºä¸€å€‹æˆæ¬Šæ¡†æ¶ï¼Œé¦–å…ˆè¦å…ˆäº†è§£å„å€‹åœ¨ OAuth è£¡å®šç¾©çš„å››ç¨®è§’è‰² ( RFC 6794 - Roles )ï¼š\nè³‡æºæ“æœ‰è€… ( resource owner )ï¼šèƒ½å°‡è¨ªå•æˆæ¬Šå§”è¨—çµ¦å‡ºå»ï¼Œè³‡æºæ“æœ‰è€…æŒ‡çš„æ˜¯ä½¿ç”¨è€…æœ¬èº«ï¼Œåˆæˆ–æ˜¯ç³»çµ±ä¸­çš„å¸³è™Ÿã€‚ è³‡æºä¼ºæœå™¨ ( resource server )ï¼šè¨—ç®¡å—ä¿è­·è³‡æºçš„ä¼ºæœå™¨ï¼Œæ¥å—è¨ªå• Token ä¸¦å›æ‡‰å—ä¿è­·çš„è³‡æºã€‚ å®¢æˆ¶ç«¯ ( client )ï¼šæŒ‡çš„å°±æ˜¯ä»£è¡¨è³‡æºæ“æœ‰è€…è¨ªå•è³‡æºä¼ºæœå™¨çš„æ‡‰ç”¨ã€‚ æˆæ¬Šä¼ºæœå™¨ ( authorization server )ï¼šé©—è­‰è³‡æºæ‰€æœ‰è€…çš„èº«åˆ†ä¸¦ç™¼æ”¾è¨ªå• Tokenã€‚ OAuth ä¸æ˜¯ä»€éº¼ OAuth ä¸æ˜¯èº«åˆ†é©—è­‰å”è­°ï¼šOAuth é‡é»æ˜¯æˆæ¬Šè€Œä¸æ˜¯é€²è¡Œèº«åˆ†é©—è­‰ã€‚ OAuth æ²’æœ‰å®šç¾©ç”¨æˆ¶å°ç”¨æˆ¶çš„æˆæ¬Šæ©Ÿåˆ¶ OAuth æ²’æœ‰å®šç¾©æˆæ¬Šè™•ç†æ©Ÿåˆ¶ï¼šOAuth å®šç¾©ä¸€äº›æˆæ¬Šæ¡†æ¶æˆ–æµç¨‹ï¼Œä½†ä¸å®šç¾©æˆæ¬Šçš„å…§å®¹ã€‚ OAuth æ²’æœ‰å®šç¾©æ¬Šæ–æ ¼å¼ï¼šOAuth å”è­°æ˜ç¢ºç”³æ˜äº†æ¬Šæ–çš„å…§å®¹ï¼Œå°æ–¼å®¢æˆ¶ç«¯æ˜¯å®Œå…¨ä¸é€æ˜çš„ã€‚ä½†æ¥å—æ¬Šæ–è™•ç†çš„æœå‹™ï¼Œå°±å¿…é ˆè¦ç†è§£æ¬Šæ–ï¼Œé€™è¡¨ç¤ºæˆæ¬Šä¼ºæœå™¨åƒ…ç”¢ç”Ÿæ¬Šæ–ï¼Œç†è§£æ¬Šæ–çš„é€™ä»¶äº‹æƒ…éƒ½ä¾è³´æ–¼è³‡æºä¼ºæœå™¨ã€‚ä½¿ç”¨ä¸Šé¢çš„ä¾‹å­ï¼šè¬èƒ½é‘°åŒ™ç”¢ç”Ÿæ–°çš„é‘°åŒ™ï¼Œä½†é€™æŠŠé‘°åŒ™èƒ½ä¸èƒ½ä½¿ç”¨å…¨éƒ¨éƒ½ç”±é–€é–æ±ºå®šï¼Œèˆ‡ç²å¾—é‘°åŒ™çš„äººã€æˆ¿æ±éƒ½æ²’æœ‰é—œä¿‚ã€‚ OAuth 2.0 ä¸å®šç¾©åŠ å¯†æ–¹æ³•ï¼šè¨±å¤šæœå‹™éƒ½æœƒè¦æ±‚å®¢æˆ¶ç«¯æ”¯æ´ HTTPSï¼Œä½†æ¡†æ¶æœ¬èº«æ˜¯ä¸é—œå¿ƒé€™å€‹éƒ¨åˆ†ï¼Œä¹Ÿä¸ç®¡æ¬Šæ–å¦‚ä½•ç°½åã€åŠ å¯†ã€é©—è­‰ã€‚ OAuth 2.0 ä¸æ˜¯å–®é«”å”è­°ï¼šåˆ†æˆå¤šå€‹å®šç¾©å’Œæµç¨‹ï¼Œæ¯å€‹å®šç¾©å’Œæµç¨‹éƒ½æœ‰å„è‡ªçš„å ´æ™¯ã€‚ OAuth 1.0 OAuth 2.0 ä¸¦ä¸ç›¸å®¹æ–¼ OAuth 1.0ï¼Œç¾åœ¨çœ‹åˆ°çš„ OAuth å¤§å¤šéƒ½æ˜¯ç›´æ¥æŒ‡ OAuth 2.0ã€‚2009å¹´4æœˆ23æ—¥ï¼ŒOAuth å®£å‘Šäº†ä¸€å€‹1.0å”å®šçš„å®‰å…¨æ¼æ´ã€‚\nOAuth 2.0 æ¦‚å¿µ å‡è£è‡ªå·±æ˜¯ç”¨æˆ¶ ä½¿ç”¨å¸³è™Ÿå¯†ç¢¼ æœ‰ä¸€æ”¯ç¨‹å¼èƒ½å¹«ä½ æ”¶ç™¼ä¿¡ä»¶ï¼Œåªéœ€è¦å‘Šè¨´å®ƒä½ ä¿¡ç®±çš„å¸³è™Ÿå¯†ç¢¼ï¼Œé€™è¡¨ç¤ºä½ å®Œå…¨ä¿¡ä»»å®ƒã€‚ä¹Ÿä¸ç”¨è‡ªå·±å¯«ç¨‹å¼ï¼ŒGmail å°±æœ‰é€™ä¸€å€‹æœå‹™äº†ï¼Œå‡å¦‚ä½ æƒ³è¦è®“ Gmail æ”¶ç™¼ä¾†è‡ª Yahoo çš„ä¿¡ä»¶ï¼Œåªè¦å‘Šè¨´å®ƒä½ çš„ Yahoo å¸³è™Ÿå¯†ç¢¼å°±è¡Œï¼Œé€™ä¹Ÿè¡¨ç¤ºä½ ä¿¡ä»» Google çš„æœå‹™ã€‚\nç‰¹æ®Šå¯†ç¢¼ å¦‚æœé€™ç¨®ä»£ç†( proxy ) çš„æ–¹å¼ä¸åªæ˜¯åœ¨ä¸€èˆ¬çš„è»Ÿé«”ï¼Œè€Œæ˜¯ä½œæ¥­ç³»çµ±æˆ–æ˜¯ç¡¬é«”è£¡ã€‚\nå¦‚æœéœ€è¦åœ¨å…¬å¸é›»è…¦æˆ–å…¬å…±é›»è…¦ç™»å…¥ï¼Œæˆ–è¨±é‚„æ˜¯ä½¿ç”¨ Google çš„æœå‹™ï¼Œä½†å¯¦éš›ä¸Šä¸­é–“é‚„é€šéå¥½å¹¾å±¤çš„ä»£ç†ã€‚é¦–å…ˆï¼Œåœ¨ç¡¬é«”ã€ä½œæ¥­ç³»çµ±ä¸Šå¯èƒ½æœƒæœ‰å®‰è£éµç›¤ç´€éŒ„å™¨ä¹‹é¡çš„æ±è¥¿ï¼Œç€è¦½å™¨ä¹Ÿæ˜¯ä¸€å€‹ä»£ç†ï¼Œä½†ä½¿ç”¨çš„æ˜¯å¯ä¿¡ä»»çš„ç€è¦½å™¨å—ï¼Ÿ\né€™æ™‚å€™å°±å¯ä»¥èˆ‡æœå‹™ç´„å®šä¸€ç¨®ã€Œç‰¹æ®Šå¯†ç¢¼ã€ï¼Œåªèƒ½ä½¿ç”¨ä¸€æ¬¡çš„å¯†ç¢¼ ( OTP, One Time Password )ã€‚ç›®å‰æ›´å¸¸è¦‹çš„æ˜¯é›™é‡èªè­‰ ( 2FA, Two Factor Authentication )ï¼Œå¯¦éš›ä¸Šçš„å½¢å¼ç‚ºï¼š\nç°¡è¨Šæˆ–ä¿¡ç®±é©—è­‰ï¼šä¸€çµ„é™æ™‚ä¸”åªèƒ½ä½¿ç”¨ä¸€æ¬¡çš„å¯†ç¢¼ ç‰¹æ®Šé€£æ¥é©—è­‰ï¼šä¸€å€‹ç‰¹æ®Šçš„é€£æ¥ï¼Œè©²é€£æ¥æœ‰æ™‚æ•ˆæ€§ï¼Œä¸”åªèƒ½å­˜å–ä¸€æ¬¡ é€éæ™‚é–“ç”¢ç”Ÿç‰¹æ®Šå¯†ç¢¼ï¼šTOTP, Time-base One Time Password é€éé›œæ¹Šç”¢ç”Ÿç‰¹æ®Šå¯†ç¢¼ï¼šHOTP, HMAC-based One Time Password èˆ‡ç³»çµ±æœå‹™ç´„å®šå¥½æ•¸çµ„ä¸€æ¬¡æ€§å¯†ç¢¼ï¼šä¾‹å¦‚æ•‘æ´ç¢¼ é–‹ç™¼è€…æ¬Šæ– åœ¨é–‹ç™¼çš„æ‡‰ç”¨ä¸‹ï¼Œä½ æœ¬èº«å°±æ˜¯é–‹ç™¼è€…ä¹‹ä¸€ï¼Œä½†æ˜¯åœ¨å…§éƒ¨å¯èƒ½æœƒæœ‰æ§åˆ¶çš„å•é¡Œï¼Œæ‰€ä»¥é‚„éœ€è¦ä¸€å€‹çœ‹é–€äºº ( gatekeeper ) ä¾†æª¢æŸ¥æ˜¯å¦æœ‰æ¬Šé™æ“ä½œã€‚\nå§”è¨—æˆæ¬Š ä»¥ä¸Šéƒ½æ˜¯æ•´ä»½æˆæ¬Šï¼Œéƒ½é‚„æ²’æœ‰æŠŠæ¬Šé™æ‹†åˆ†æ›´å°çš„éƒ¨åˆ†ä¸¦åˆ†é–‹æˆæ¬Šï¼Œä¾‹å¦‚åªæˆæ¬Šå­˜å–è§’è‰²ã€Email åœ°å€ã€ä½¿ç”¨è€…è³‡è¨Šï¼Œä¸¦ä¸”ç”¢ç”Ÿä¸€çµ„ç‰¹æ®Šå¯†ç¢¼ã€‚\nçµèª éå»ï¼Œåœ¨ä½¿ç”¨ Passport.js å¯«å°ˆæ¡ˆæ™‚ï¼Œå…¶å¯¦éƒ½æ²’æœ‰çœŸæ­£çš„äº†è§£å®ƒå¯¦éš›çš„æ¦‚å¿µã€‚çœ‹åˆ°ç¾åœ¨ï¼Œåªè¦èƒ½é‡æ¸…å„å€‹è§’è‰²åœ¨ä¹‹ä¸­åšçš„äº‹æƒ…ï¼Œå°æ–¼ç†è§£ä¸Šå°±ä¸æœƒå¤ªéè¤‡é›œäº†ã€‚\nReference ç”¨Keycloakå­¸ç¿’èº«ä»½é©—è­‰èˆ‡æˆæ¬Š ","permalink":"https://et860525.github.io/posts/oauth-first-look/","summary":"OAuth æ˜¯ä¸€å€‹é–‹æ”¾æ¨™æº–çš„æˆæ¬Šå”è­°ï¼Œå®ƒå…è¨±ä½¿ç”¨è€…è®“ç¬¬ä¸‰æ–¹æ‡‰ç”¨å­˜å–è©²ä½¿ç”¨è€…åœ¨æŸç¶²ç«™å„²å­˜çš„ç§å¯†è³‡æºã€‚\nè©¦æƒ³æœ‰ä¸€æ£Ÿæˆ¿å­ï¼Œè£¡é¢æœ‰å¾ˆå¤šå€‹æˆ¿é–“ï¼Œè£¡é¢æœ‰ä¸€ä½æˆ¿æ± ( ä½¿ç”¨è€… ) æ“æœ‰ä¸€æŠŠè¬èƒ½é‘°åŒ™ï¼Œå¯ä»¥é–‹å•Ÿæ‰€æœ‰çš„æˆ¿é–“é–€ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œé€™æŠŠè¬èƒ½é‘°åŒ™é‚„æœ‰ä¸€å€‹ä½œç”¨ï¼Œå°±æ˜¯å¯ä»¥ç”¢å‡ºç‰¹å®šé–€çš„é‘°åŒ™ï¼Œè€Œç”¢ç”Ÿå‡ºä¾†çš„é‘°åŒ™å¯ä»¥äº¤çµ¦å…¶ä»–äººï¼Œé€™æ¨£å…¶ä»–äººå°±å¯ä»¥é€²å‡ºç‰¹å®šçš„æˆ¿é–“ï¼Œé€™å€‹å‹•ä½œå°±æ˜¯ã€Œæˆæ¬Šã€ã€‚\nOAuth 2.0 æ˜¯ OAuth çš„é€²åŒ–ç‰ˆï¼Œå®ƒæ˜¯æˆæ¬Šæ¡†æ¶ ( authorization framework )ï¼Œå…è¨±æ‡‰ç”¨å‘ä½¿ç”¨è€…è«‹æ±‚æˆæ¬Šï¼Œç„¶å¾Œå–å¾— Tokenï¼Œä¸¦ä¸”ç”¨å®ƒä¾†è¨ªå•è³‡æºã€‚\nThe OAuth 2.0 authorization framework enables a third-party application to obtain limited access to an HTTP service, either on behalf of a resource owner by orchestrating an approval interaction between the resource owner and the HTTP service, or by allowing the third-party application to obtain access on its own behalf. ï¼ RFC 6749","title":"ç†è§£ OAuth"},{"content":"WebSocket æ˜¯ç”± HTML 5 æ‰€æä¾›ç”¨æ–¼è®“ç€è¦½å™¨èˆ‡ä¼ºæœå™¨é€²è¡Œäº’å‹•é€šè¨Šçš„æŠ€è¡“ã€‚\nWebSocket åªéœ€è¦é€£ç·šä¸€æ¬¡ï¼Œå°±èƒ½ä¿æŒèˆ‡ä¼ºæœå™¨çš„é›™å‘æºé€šï¼Œç„¡é ˆé‡æ–°ç™¼é€ Requestï¼Œé€™ä¹Ÿè®“å›æ‡‰æ›´å³æ™‚èˆ‡å¿«é€Ÿã€‚\næ­·å² åœ¨æ—©æœŸï¼Œç¶²ç«™ç‚ºäº†å¯¦ç¾æ¨æ’­çš„æŠ€è¡“ï¼Œéƒ½æ˜¯ä½¿ç”¨è¼ªè©¢ ( polling )ã€‚æ‰€è¬‚çš„è¼ªè©¢å°±æ˜¯ç€è¦½å™¨æ¯éš”ä¸€æ®µæ™‚é–“ ( å¦‚æ¯ç§’ ) åƒä¼ºæœå™¨ç™¼å‡º HTTP Requestï¼Œä¼ºæœå™¨ä¾¿æœƒå›å‚³æœ€æ–°çš„è³‡æ–™çµ¦å®¢æˆ¶ç«¯ï¼Œå¾ˆæ˜é¡¯çš„ç¼ºé»å°±æ˜¯ç€è¦½å™¨å¿…é ˆä¸æ–·çš„ç™¼å‡º Requestã€‚\nWhy WebSocket ? é›™å‘æºé€šï¼šå¾ä»¥ä¸Šå¯ä»¥å¾—çŸ¥ï¼Œåœ¨ä»¥å‰éƒ½æ˜¯ç”± Client ç«¯é€²è¡Œã€Œå–®å‘ã€ç™¼é€ Requestï¼Œè€Œç„¡æ³•ç”± Server ä¸»å‹•ç™¼å‡º Requestã€‚è€Œ WebSocket å”å®šå¯ä»¥è®“ Server ç«¯ä¸»å‹•å‘ Client æ¨æ’­è³‡æ–™ï¼Œä»¥æ­¤å¯¦ç¾ã€Œé›™å‘æºé€šã€ å¯¦éš›ä½¿ç”¨ï¼šæ¨æ’­ã€å³æ™‚èŠå¤©å®¤ã€å…±åŒç·¨è¼¯ ä½¿ç”¨ WebSocket WebSocket æ˜¯ç”±ç€è¦½å™¨ä½¿ç”¨ JavaScript ä¾†å»ºç«‹çš„ï¼Œç™¼èµ·ä¸€å€‹ HTTP Requestã€‚ä¸€èˆ¬ WebSocket è«‹æ±‚ç¶²å€ç‚ºï¼š\nws://example.com/wsapi ç¶“é SSL åŠ å¯†å¾Œå°±æœƒè®Šæˆï¼š\nwss://secure.example.com/wsapi äº¤æ¡ ( Handshaking ) Websocket é€šé HTTP/1.1 å”å®šé€²è¡Œäº¤æ¡ã€‚\nå®¢æˆ¶ç«¯ ( Client ) Requestï¼š\nGET /chat HTTP/1.1 Host: server.example.com Upgrade: websocket Connection: Upgrade Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ== Origin: http://example.com Sec-WebSocket-Protocol: chat, superchat Sec-WebSocket-Version: 13 GET /chat HTTP/1.1 ä½¿ç”¨ HTTP/1.1 å”å®šé€²è¡Œäº¤æ¡ Upgrade: websocket è¡¨ç¤ºå®¢æˆ¶ç«¯æƒ³å‡ç´šç‚º websocket å”å®š Connection: Upgrade è¡¨ç¤ºå®¢æˆ¶ç«¯æƒ³é€£æ¥å‡ç´š Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ== è¨ˆç®— SHA-1 æ‘˜è¦ï¼Œä¹‹å¾Œé€²è¡Œ Base64 ç·¨ç¢¼ï¼Œè©²çµæœæœƒæˆç‚ºä¼ºæœå™¨å›å‚³ã€ŒSec-WebSocket-Acceptã€é ­çš„å€¼ä¸¦è¿”å›çµ¦å®¢æˆ¶ç«¯ï¼Œä»¥é¿å…æ™®é€š HTTP è¢«èª¤èªç‚º WebSocket å”å®š ( æ¯ä¸€æ¬¡æ¡æ‰‹éš¨æ©Ÿç”¢ç”Ÿ ) Origin: http://example.com å®¢æˆ¶ç«¯çš„ URL Sec-WebSocket-Protocol: chat, superchat URL ä¸‹ä¸åŒ Server éœ€è¦çš„å”è­° Sec-WebSocket-Version: 13 æ”¯æ´çš„Websocketç‰ˆæœ¬ ä¼ºæœå™¨ ( Server ) Responseï¼š\nHTTP/1.1 101 Switching Protocols Upgrade: websocket Connection: Upgrade Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo= Sec-WebSocket-Protocol: chat HTTP/1.1 101 Switching Protocols å»ºç«‹æˆåŠŸ Sec-WebSocket-Protocol: chat ä¼ºæœå™¨ç«¯ä½¿ç”¨çš„å”è­° Server ç«¯ï¼šå»ºç«‹ WebSocket ç’°å¢ƒ å…ˆå®‰è£å…©å€‹å¥—ä»¶ï¼š\npnpm install express pnpm install ws å®‰è£å¾Œï¼Œå»ºç«‹ server.js æª”æ¡ˆï¼š\nconst express = require(\u0026#39;express\u0026#39;) const ServerSocket = require(\u0026#39;ws\u0026#39;).Server // å¼•ç”¨ Server // æŒ‡å®šä¸€å€‹ port const PORT = 8080 // å»ºç«‹ express ç‰©ä»¶ä¸¦ç”¨ä¾†ç›£è½ 8080 port const server = express() .listen(PORT, () =\u0026gt; console.log(`[Server] Listening on https://localhost:${PORT}`)) // é€é ServerSocket é–‹å•Ÿ WebSocket çš„æœå‹™ const wss = new ServerSocket({ server }) // Connection opened wss.on(\u0026#39;connection\u0026#39;, ws =\u0026gt; { console.log(\u0026#39;Client connected\u0026#39;) // Connection closed ws.on(\u0026#39;close\u0026#39;, () =\u0026gt; { console.log(\u0026#39;Close connected\u0026#39;) }) }) ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤åŸ·è¡Œ Serverï¼š\nnode server.js Client ç«¯ï¼šé€£ç·šåˆ° WebSocket Server å»ºç«‹å®Œ Server å¾Œï¼Œæ¥ä¸‹ä¾†è¦å»ºç«‹ Client ä¾†é€£ç·šåˆ° WebSocket Serverã€‚å»ºç«‹ä¸€å€‹æ–°çš„å°ˆæ¡ˆï¼Œè£¡é¢æœƒæœ‰ index.html èˆ‡ index.js å…©å€‹æª”æ¡ˆã€‚\né¦–å…ˆï¼Œå…ˆå»ºç«‹ index.htmlï¼š\n\u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;!-- Connect or Disconnect WebSocket Server --\u0026gt; \u0026lt;button id=\u0026#34;connect\u0026#34;\u0026gt;Connect\u0026lt;/button\u0026gt; \u0026lt;button id=\u0026#34;disconnect\u0026#34;\u0026gt;Disconnect\u0026lt;/button\u0026gt; \u0026lt;!-- Send Message to Server --\u0026gt; \u0026lt;div\u0026gt; Message: \u0026lt;input type=\u0026#34;text\u0026#34; id=\u0026#34;sendMsg\u0026#34; \u0026gt;\u0026lt;button id=\u0026#34;sendBtn\u0026#34;\u0026gt;Send\u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;!-- Import index.js after UI rendered --\u0026gt; \u0026lt;script src=\u0026#39;./index.js\u0026#39;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; æ–°å¢ä¸€å€‹ index.js æª”æ¡ˆä¾†è™•ç†é‚è¼¯ï¼š\nvar ws // ç›£è½ click äº‹ä»¶ document.querySelector(\u0026#39;#connect\u0026#39;)?.addEventListener(\u0026#39;click\u0026#39;, (e) =\u0026gt; { console.log(\u0026#39;[click connect]\u0026#39;) connect() }) document.querySelector(\u0026#39;#disconnect\u0026#39;)?.addEventListener(\u0026#39;click\u0026#39;, (e) =\u0026gt; { console.log(\u0026#39;[click disconnect]\u0026#39;) disconnect() }) document.querySelector(\u0026#39;#sendBtn\u0026#39;)?.addEventListener(\u0026#39;click\u0026#39;, (e) =\u0026gt; { const msg = document.querySelector(\u0026#39;#sendMsg\u0026#39;) sendMessage(msg?.value) }) function connect() { // Create WebSocket connection ws = new WebSocket(\u0026#39;ws://localhost:8080\u0026#39;) // åœ¨é–‹å•Ÿé€£ç·šæ™‚åŸ·è¡Œ ws.onopen = () =\u0026gt; console.log(\u0026#39;[open connection]\u0026#39;) } function disconnect() { ws.close() // åœ¨é—œé–‰é€£ç·šæ™‚åŸ·è¡Œ ws.onclose = () =\u0026gt; console.log(\u0026#39;[close connection]\u0026#39;) } å¦‚æœä½¿ç”¨ console.log(ws) å¯ä»¥çœ‹åˆ°ç‰©ä»¶ï¼š\nreadyState æœ‰å››ç¨® codeï¼š\n0ï¼šé€£æ¥å°šæœªå»ºç«‹ 1ï¼šé€£æ¥å»ºç«‹ï¼Œå¯ä»¥é€²è¡Œé€šè¨Š 2ï¼šé€£æ¥æ­£åœ¨é€²è¡Œé—œé–‰ 3ï¼šé€£æ¥å·²ç¶“é—œé–‰æˆ–é€£æ¥æ‰“ä¸é–‹ é€™è£¡å¯ä»¥çœ‹åˆ° WebSocket æœ‰å››å€‹äº‹ä»¶ï¼š\nonopen onerror onclose onmessage ç›£è½ WebSocket äº‹ä»¶ open èˆ‡ WebSocket Server é€£æ¥å»ºç«‹æ™‚æœƒè§¸ç™¼ï¼š\nws.addEventListener(\u0026#39;open\u0026#39;, function() { console.log(\u0026#39;é€£çµå»ºç«‹æˆåŠŸã€‚\u0026#39;) }) error é€šä¿¡éŒ¯èª¤æ™‚è§¸ç™¼\nclose é—œé–‰ WebSocket Server é€£ç·šæ™‚è§¸ç™¼ï¼š\nws.addEventListener(\u0026#39;close\u0026#39;, function() { console.log(\u0026#39;é€£çµé—œé–‰ã€‚\u0026#39;) }) message ç›£è½ç”± Server ä¸»å‹•ç™¼ä¾†çš„è¨Šæ¯ï¼š\nws.addEventListener(\u0026#39;message\u0026#39;, function(e) { var msg = JSON.parse(e.data); console.log(msg) }) ä»¥ä¸‹æœ‰æ›´è©³ç´°çš„ Message è™•ç†ã€‚\nè™•ç† Message å› ç‚º WebSocket å¯ä»¥é›™å‘æºé€šï¼Œæ‰€ä»¥ Server ç«¯å¯ä»¥ç™¼é€è¨Šæ¯çµ¦ Client ç«¯ï¼ŒClient ç«¯ä¹Ÿå¯ä»¥ç™¼é€è¨Šæ¯çµ¦ Server ç«¯ã€‚\nServer ç«¯ Server ç«¯ä½¿ç”¨ send ç™¼é€è¨Šæ¯ï¼ŒClient é€éç›£è½ message äº‹ä»¶ä¾†æ¥æ”¶è¨Šæ¯ï¼š\n// Connection opened wss.on(\u0026#39;connection\u0026#39;, ws =\u0026gt; { console.log(\u0026#39;Client connected\u0026#39;) // Listen for messages from client ws.on(\u0026#39;message\u0026#39;, data =\u0026gt; { console.log(\u0026#39;[Message from client]: \u0026#39;, data) // Send message to client ws.send(\u0026#39;[Get message from server]\u0026#39;) }) // ... }) Client ç«¯ Clinet ç«¯ä½¿ç”¨ send ç™¼é€è¨Šæ¯ï¼ŒServer ç«¯ä½¿ç”¨ onmessage æ¥æ”¶è¨Šæ¯ï¼š\n// Client: ç›£è½ click äº‹ä»¶ document.querySelector(\u0026#39;#sendBtn\u0026#39;)?.addEventListener(\u0026#39;click\u0026#39;, (e) =\u0026gt; { const msg = document.querySelector(\u0026#39;#sendMsg\u0026#39;) sendMessage(msg?.value) }) // Server: Listen for messages function sendMessage(msg) { // Send messages to Server ws.send(msg) // Listen for messages from Server ws.onmessage = event =\u0026gt; console.log(\u0026#39;[send message]\u0026#39;, event) } ä¸€å€‹ç°¡å–®çš„å³æ™‚èŠå¤©å®¤ ä»¥ä¸‹çš„ç¨‹å¼ç¢¼å¯¦ä½œæœƒæ”¾åœ¨ et860525/websocket-test\nWebSocket å¯ä»¥é‹ç”¨åœ¨èŠå¤©å®¤ç­‰åŠŸèƒ½ï¼Œå¯¦ç¾ä¸€å€‹ Server åŒæ™‚è®“å¤šå€‹ Client é€£ç·šï¼Œä¸¦è®“ Client A å‚³é€è¨Šæ¯çµ¦ Server çš„åŒæ™‚ï¼Œè®“ Client B æ¥æ”¶ä¾†è‡ª Server çš„è¨Šæ¯ã€‚\né€™æ™‚å€™å°±è¦ä½¿ç”¨å»£æ’­åŠŸèƒ½ï¼Œé¦–å…ˆé€é ws æä¾›çš„æ–¹æ³•ä¾†è®“ Client å–å¾—ç›®å‰æ‰€æœ‰å…¶ä»– Clients çš„è³‡è¨Šï¼Œå†ä½¿ç”¨ forEach è¿´åœˆé€å‡ºè¨Šæ¯çµ¦æ¯ä¸€å€‹ Clientï¼š\n// Connection opened wss.on(\u0026#39;connection\u0026#39;, ws =\u0026gt; { console.log(\u0026#39;Client connected\u0026#39;) // Listen for messages from client ws.on(\u0026#39;message\u0026#39;, data =\u0026gt; { console.log(\u0026#39;[Message from client]: \u0026#39;, data) // Get clients who connected let clients = wss.clients // Use loop for sending messages to each client clients.forEach(client =\u0026gt; { client.send(\u0026#39;[Broadcast][Get message from server]\u0026#39;) }) }) // ... }) é‚£è¦å¦‚ä½•çµ¦ä¸åŒçš„ Client ä¸€å€‹ç¨ä¸€ç„¡äºŒçš„ ID å‘¢ï¼Ÿ\næ ¹æ“š unique identifier for each client request to websocket serverï¼Œé€™è£¡å¯ä»¥ç›´æ¥å–å¾— request header ä¸­çš„ sec-websocket-key çµ¦æ¯å€‹ Client ä¸åŒçš„ IDï¼š\nwss.on(\u0026#39;connection\u0026#39;, (ws, req) =\u0026gt; { var id = req.headers[\u0026#39;sec-websocket-key\u0026#39;] // Do something... }) ä»¥ä¸‹ç‚ºå®Œæ•´çš„ç¨‹å¼ç¢¼ï¼š\nServer ç«¯ server.js\n// import library const express = require(\u0026#39;express\u0026#39;) const ServerSocket = require(\u0026#39;ws\u0026#39;).Server // å¼•ç”¨ Server const PORT = 8080 // å»ºç«‹ express ç‰©ä»¶ä¸¦ç”¨ä¾†ç›£è½ 8080 port const server = express() .listen(PORT, () =\u0026gt; console.log(`[Server] Listening on https://localhost:${PORT}`)) // å»ºç«‹å¯¦é«”ï¼Œé€é ServerSocket é–‹å•Ÿ WebSocket çš„æœå‹™ const wss = new ServerSocket({ server }) // Connection opened wss.on(\u0026#39;connection\u0026#39;, (ws, req) =\u0026gt; { ws.id = req.headers[\u0026#39;sec-websocket-key\u0026#39;].substring(0, 8) ws.send(`[Client ${ws.id} is connected!]`) // Listen for messages from client ws.on(\u0026#39;message\u0026#39;, data =\u0026gt; { console.log(\u0026#39;[Message from client] data: \u0026#39;, data) // Get clients who has connected let clients = wss.clients // Use loop for sending messages to each client clients.forEach(client =\u0026gt; { client.send(`${ws.id}: ` + data) }) }) // Connection closed ws.on(\u0026#39;close\u0026#39;, () =\u0026gt; { console.log(\u0026#39;[Close connected]\u0026#39;) }) }) å˜—è©¦ä½¿ç”¨ TypeScript ä¾†å»ºæ§‹ Server ç«¯ ( server.ts )ï¼š\nimport express from \u0026#39;express\u0026#39;; import WebSocket, { Server } from \u0026#39;ws\u0026#39;; const PORT = 8080; // å»ºç«‹ express ç‰©ä»¶ä¸¦ç”¨ä¾†ç›£è½ 8080 port const server = express().listen(PORT, () =\u0026gt; console.log(`[Server] Listening on https://localhost:${PORT}`) ); // é€é Server é–‹å•Ÿ WebSocket çš„æœå‹™ const wss = new Server({ server: server }); // Connection opened wss.on(\u0026#39;connection\u0026#39;, (ws: WebSocket, req) =\u0026gt; { let id = req.headers[\u0026#39;sec-websocket-key\u0026#39;]; if (id) id = id.substring(0, 8); ws.send(`[Client ${id} is connected!]`); // Listen for messages from client ws.on(\u0026#39;message\u0026#39;, (data) =\u0026gt; { console.log(\u0026#39;[Message from client] data: \u0026#39;, data); // Get clients who has connected let clients = wss.clients; // Use loop for sending messages to each client clients.forEach((client) =\u0026gt; { client.send(`${id}: ` + data); }); }); // Connection closed ws.on(\u0026#39;close\u0026#39;, () =\u0026gt; { console.log(\u0026#39;[Close connected]\u0026#39;); }); }); Client ç«¯ index.js\nvar ws // ç›£è½ click äº‹ä»¶ document.querySelector(\u0026#39;#connect\u0026#39;)?.addEventListener(\u0026#39;click\u0026#39;, (e) =\u0026gt; { connect() }) document.querySelector(\u0026#39;#disconnect\u0026#39;)?.addEventListener(\u0026#39;click\u0026#39;, (e) =\u0026gt; { disconnect() }) document.querySelector(\u0026#39;#sendBtn\u0026#39;)?.addEventListener(\u0026#39;click\u0026#39;, (e) =\u0026gt; { const msg = document.querySelector(\u0026#39;#sendMsg\u0026#39;) sendMessage(msg?.value) }) function connect() { // Create WebSocket connection ws = new WebSocket(\u0026#39;ws://localhost:8080\u0026#39;) // ä¹Ÿå¯ä»¥é€£ç·šåˆ°æŒ‡å®šçš„ IP // ws = new WebSocket(\u0026#39;ws://192.168.17.35:58095\u0026#39;) // åœ¨é–‹å•Ÿé€£ç·šæ™‚åŸ·è¡Œ ws.onopen = () =\u0026gt; { console.log(\u0026#39;[open connection]\u0026#39;) // Listen for messages from Server ws.onmessage = event =\u0026gt; { console.log(`[Message from server]:\\n %c${event.data}` , \u0026#39;color: blue\u0026#39;) } } } function sendMessage(msg) { // Send messages to Server ws.send(msg) } function disconnect() { ws.close() // åœ¨é—œé–‰é€£ç·šæ™‚åŸ·è¡Œ ws.onclose = () =\u0026gt; console.log(\u0026#39;[close connection]\u0026#39;) } Socket vs WebSocket vs Socket.io Socket ä½¿ç”¨è€…å¯ä»¥é€é Socket ä¾†æ“ä½œ TCP/IP å”è­° å®šç¾©åœ¨ å‚³è¼¸å±¤è·Ÿæ‡‰ç”¨å±¤ä¹‹é–“ å‚³è¼¸æ–¹å¼ç‚º stream å‚³è¼¸è¼‰é«”ç‚º binary WebSocket ç‚ºäº†è®“ Web å³æ™‚é›™å‘é€šè¨Šè€Œå‰µé€ çš„å”è­° å±¬æ–¼æ‡‰ç”¨å±¤ ç€è¦½å™¨åº•å±¤ä½¿ç”¨ socket ç•¶ä½œé€šè¨Šç•Œé¢ è¼‰é«”æœ‰å…©ç¨®ï¼šbinaryæˆ–textï¼Œåªèƒ½æ“‡ä¸€ä½¿ç”¨ Socket.io Socket.io æ˜¯ä¸€å€‹æ¡†æ¶ä¸€å€‹å¥—ä»¶ å»ºç«‹åœ¨ WebSocket ä¸Šçš„å¥—ä»¶ï¼Œæ”¯æŒä»£ç†å’Œè² è¼‰å¹³è¡¡å™¨ å…©éƒ¨åˆ†çµ„æˆï¼šServer ç«¯ç‚º Node.jsï¼›Client ç«¯ç‚º JavaScript socket.ioä¸¦æ²’æœ‰ä»»ä½•é€£ç·šåŠŸèƒ½ï¼Œä¸»è¦æ˜¯é æ ¸å¿ƒ engine.io ä¾†é€£æ¥ä¼ºæœå™¨èˆ‡å®¢æˆ¶ç«¯ çµèª ç ”ç©¶äº†ä¸€ä¸‹ WebSocket æŠ€è¡“ï¼Œå…¶é‡é»ç‚ºï¼šå®¢æˆ¶ç«¯å¯ä»¥ä¸ç”¨ç‚ºäº†ç¢ºèªè³‡æ–™åœ¨ä¼ºæœå™¨è£¡çš„ç‹€æ…‹ï¼Œè€Œä¸æ–·çš„é€å‡º Requestï¼Œè€Œæ˜¯ç•¶ä¼ºæœå™¨è£¡çš„è³‡æ–™ç‹€æ…‹æ›´æ–°æ™‚ï¼Œä¼ºæœå™¨å¯ä»¥ä¸»å‹•çš„å°‡è³‡æ–™æ¨æ’­çµ¦å®¢æˆ¶ç«¯ã€‚\nReference æ·ºè«‡ WebSocket å”å®šï¼šå¯¦ä½œä¸€å€‹ç°¡å–®çš„å³æ™‚èŠå¤©å®¤å§ï¼ JavaScript | WebSocket è®“å‰å¾Œç«¯æ²’æœ‰è·é›¢ Socketï¼ŒWebsocketï¼ŒSocket.ioçš„å·®ç•° WebSocket åŸºæœ¬ä»‹ç´¹åŠä½¿ç”¨ç­†è¨˜ ","permalink":"https://et860525.github.io/posts/websocket-first-look/","summary":"\u003cp\u003e\u003ca href=\"https://zh.wikipedia.org/zh-tw/WebSocket\"\u003eWebSocket\u003c/a\u003e æ˜¯ç”± \u003ca href=\"https://zh.wikipedia.org/zh-tw/HTML5\"\u003eHTML 5\u003c/a\u003e æ‰€æä¾›ç”¨æ–¼è®“ç€è¦½å™¨èˆ‡ä¼ºæœå™¨é€²è¡Œäº’å‹•é€šè¨Šçš„æŠ€è¡“ã€‚\u003c/p\u003e\n\u003cp\u003eWebSocket åªéœ€è¦é€£ç·šä¸€æ¬¡ï¼Œå°±èƒ½ä¿æŒèˆ‡ä¼ºæœå™¨çš„\u003cstrong\u003eé›™å‘æºé€š\u003c/strong\u003eï¼Œç„¡é ˆé‡æ–°ç™¼é€ Requestï¼Œé€™ä¹Ÿè®“å›æ‡‰æ›´å³æ™‚èˆ‡å¿«é€Ÿã€‚\u003c/p\u003e","title":"åˆè©¦ WebSocket"},{"content":"ç•¶æˆ‘é–‹å§‹å®Œå–„å„å€‹åŠŸèƒ½æ™‚ï¼Œå°±ç™¼ç¾å›å‚³ view æ‰€éœ€è¦çš„å‡½å¼ä¸åªæœ‰ renderï¼Œåœ¨æŸäº›æ™‚å€™é‚„æ˜¯è¦ä½¿ç”¨ redirectï¼Œè€Œç•¶é€™æ¨£æœƒæœ‰å…©ç¨®æ ¼å¼è¦å›å‚³æ™‚ï¼Œæˆ‘å°±æœƒå»ºç«‹ Response Object ä¾†åˆ¶å®šå›å‚³çš„æ ¼å¼ï¼Œä¸¦ä¸”åœ¨ route.base ä¸­å°±è¦å¤šä¸€å€‹å°ˆé–€è™•ç† redirect çš„å‡½å¼ã€‚\nç•¶é€™äº›éƒ½å®Œæˆå¾Œï¼Œå°±å¯ä»¥é–‹å§‹å¯¦ä½œç¶²é çš„åŠŸèƒ½äº†ï¼Œåœ¨é€™ç¯‡æ–‡ç« è£¡æˆ‘æœƒå¯¦ä½œ MenuItem çš„ CRUDã€‚\nGithubï¼šet860525/restaurant-management\nResponse Object é¦–å…ˆï¼ŒResponse object æœƒå°‡ Contoller æ‰€å›å‚³çš„è³‡æ–™åšæˆçµ±ä¸€çš„æ ¼å¼ï¼Œä¸¦èƒ½è®“ Route ä½¿ç”¨ã€‚ä»¥ä¸‹å°‡å…©å€‹ Response object æ”¾åˆ° src/commom/response/response.object.tsï¼š\nexport class renderResponseObject { public readonly view: string = \u0026#39;index\u0026#39;; public readonly data: any = null; constructor(options: { view: string; data?: any }) { this.view = options.view || this.view; this.data = options.data || this.data; } } export class redirectResponseObject { public readonly status: number = 302; public readonly url: string = \u0026#39;/\u0026#39;; constructor(options: { url: string; status?: number }) { this.url = options.url || this.url; this.status = options.status || this.status; } } æ ¹æ“š render èˆ‡ redirect æœƒä½¿ç”¨åˆ°çš„åƒæ•¸è£½ä½œæˆ obejctï¼Œå®Œæˆå¾Œå†åˆ° controller.base æ–°å¢ç›¸å°æ‡‰çš„å‡½å¼ä¾†å»ºç«‹ Response object ä¸¦å›å‚³ï¼š\nimport { renderResponseObject, redirectResponseObject, } from \u0026#39;../common/response/response.object\u0026#39;; export abstract class ControllerBase { public formatResponse(view: string, data?: any) { const responseObject = new renderResponseObject({ view, data }); return responseObject; } public formatRedirectResponse(url: string, status?: number) { const responseObject = new redirectResponseObject({ url, status }); return responseObject; } } ç”± Route æœƒç²å¾—å¾ Controll å›å‚³ä¾†çš„ Response objectï¼Œæ‰€ä»¥è¦æ›´æ”¹ route.base çš„ç¨‹å¼ç¢¼ï¼š\nimport { renderResponseObject, redirectResponseObject } from \u0026#39;../common/response/response.object\u0026#39;; export abstract class RouteBase { // ç•¥... protected responseHandler( method: ( req: Request, res: Response, next: NextFunction ) =\u0026gt; Promise\u0026lt;renderResponseObject\u0026gt; ) { return (req: Request, res: Response, next: NextFunction) =\u0026gt; { method .call(this.controller, req, res, next) .then((obj) =\u0026gt; res.render(obj.view, obj.data)) .catch((err) =\u0026gt; next(err)); }; } protected responseRedirectHandler( method: ( req: Request, res: Response, next: NextFunction ) =\u0026gt; Promise\u0026lt;redirectResponseObject\u0026gt; ) { return (req: Request, res: Response, next: NextFunction) =\u0026gt; { method .call(this.controller, req, res, next) .then((obj) =\u0026gt; res.redirect(obj.status, obj.url)) .catch((err) =\u0026gt; next(err)); }; } } æ¥ä¸‹ä¾†å°±è¦é–‹å§‹å®Œå–„ MenuItem çš„å„ç¨®åŠŸèƒ½ã€‚\nMenuItem Route ä»¥ä¸‹æ˜¯è®“ä½¿ç”¨è€…å¯ä»¥å°èœå–®é€²è¡Œ CRUD çš„å‹•ä½œï¼Œé¦–å…ˆå…ˆæ–°å¢è·¯ç”±ï¼Œåˆ° main/menu/menuItem.routing.tsï¼š\nimport express from \u0026#39;express\u0026#39;; import { RouteBase } from \u0026#39;../../base/route.base\u0026#39;; import { MenuItemController } from \u0026#39;./menuItem.controller\u0026#39;; export class MenuItemRoute extends RouteBase { protected controller!: MenuItemController; constructor() { super(); } protected initial(): void { this.controller = new MenuItemController(); super.initial(); } protected registerRoute(): void { this.router.get( \u0026#39;/menuItems\u0026#39;, this.responseHandler(this.controller.get_many) ); this.router .route(\u0026#39;/menuItems/create\u0026#39;) .get(this.responseHandler(this.controller.form)) .post( express.json(), this.responseRedirectHandler(this.controller.create) ); this.router.get( \u0026#39;/menuItems/:id\u0026#39;, this.responseHandler(this.controller.get) ); this.router .route(\u0026#39;/menuItems/:id/delete\u0026#39;) .get(this.responseHandler(this.controller.delete_get)) .post(this.responseRedirectHandler(this.controller.delete)); this.router .route(\u0026#39;/menuItems/:id/update\u0026#39;) .get(this.responseHandler(this.controller.update_get)) .post( express.json(), this.responseRedirectHandler(this.controller.update) ); } } /menuItemsï¼šMenuItem çš„ä¸»é é¢ '/menuItems/:id'ï¼šè®€å–æŒ‡å®š ID çš„ MenuItem '/menuItems/create'ï¼šæ–°å¢ '/menuItems/update'ï¼šæ›´æ–° '/menuItems/delete'ï¼šåˆªé™¤ MenuItem Controller æ¥è‘—é–‹å§‹å¯¦ä½œå„å€‹è·¯ç”±çš„åŠŸèƒ½ï¼Œåˆ° main/menu/menuItem.controller.tsã€‚\nå‰ç½® import { MenuItem } from \u0026#39;@prisma/client\u0026#39;; import { Request } from \u0026#39;express\u0026#39;; import { ControllerBase } from \u0026#39;../../base/controller.base\u0026#39;; import { MenuItemService } from \u0026#39;./menuItem.service\u0026#39;; export class MenuItemController extends ControllerBase { private readonly menuService = new MenuItemService(); // å¯¦ä½œçš„å…¶ä»–åŠŸèƒ½ } menuServiceï¼šController æœƒæŠŠè³‡æ–™å‚³çµ¦ Serviceï¼Œä¸¦ç­‰å¾… Service å‚³å›å¾ Database è®€å–ä¾†çš„è³‡æ–™ æœ‰äº›åŠŸèƒ½æœƒåœ¨é–‹å§‹åŸ·è¡Œå‰ï¼Œæœƒå…ˆç¢ºå®šè©²ç­†è³‡æ–™æ˜¯å¦å­˜åœ¨æ–¼è³‡æ–™åº«ï¼Œå¦‚æœæ²’æœ‰å°±æœƒå‡ºç¾éŒ¯èª¤ï¼Œæ‰€ä»¥æŒæ¡éŒ¯èª¤å°±å¾ˆé‡è¦ã€‚å»ºç«‹ä¸€å€‹æª¢æŸ¥å¾è³‡æ–™åº«å›å‚³å›ä¾†çš„è³‡æ–™æ˜¯å¦ç‚ºç©ºçš„ï¼Œå¦‚æœæ˜¯ç©ºçš„é‚£å°±é¡¯ç¤ºéŒ¯èª¤çš„è³‡è¨Šï¼š\nprivate checkMenuItem = async (id: string, menuItem: MenuItem | null) =\u0026gt; { if (menuItem === null) { return this.formatResponse(\u0026#39;error\u0026#39;, { error: new Error(`MenuItem ${id} is not exist`), }); } else { return menuItem; } }; Create public async form() { return this.formatResponse(\u0026#39;menuItem_form\u0026#39;); } public async create(req: Request) { const { name, description, price } = req.body; const menuItem = await this.menuService.create(name, description, price); return this.formatRedirectResponse(`/menuItems/${menuItem.id}`); } Read one public async get(req: Request) { const { id } = req.params; const menuItem = await this.menuService.get(Number(id)); this.checkMenuItem(id, menuItem); return this.formatResponse(\u0026#39;menuItem_detail\u0026#39;, { menuItem: menuItem }); } Read many public async get_many(req: Request) { const skip = req.query.skip || 0; const take = req.query.take || 10; const menuItems = await this.menuService.get_many( Number(skip), Number(take) ); return this.formatResponse(\u0026#39;menuItem\u0026#39;, { menuItems: menuItems, }); } Update public async update_get(req: Request) { const { id } = req.params; const menuItem = await this.menuService.get(Number(id)); this.checkMenuItem(id, menuItem); return this.formatResponse(\u0026#39;menuItem_form\u0026#39;, { data: menuItem }); } public async update(req: Request) { const { id } = req.params; const { name, description, price } = req.body; const menuItem = await this.menuService.update(Number(id), { name: name, description: description, price: Number(price), }); return this.formatRedirectResponse(`/menuItems/${menuItem.id}`); } Delete public async delete_get(req: Request) { const { id } = req.params; const deleteUrl = req.path.split(\u0026#39;/\u0026#39;)[1]; const menuItem = await this.menuService.get(Number(id)); this.checkMenuItem(id, menuItem); return this.formatResponse(\u0026#39;delete\u0026#39;, { deleteItem: menuItem, deleteUrl: deleteUrl, }); } public async delete(req: Request) { const { id } = req.params; await this.menuService.delete(Number(id)); return this.formatRedirectResponse(\u0026#39;/menuItems\u0026#39;); } MenuItem Views View çš„éƒ¨åˆ†å°±å¾ˆç°¡å–®ï¼Œåªè¦æŠŠå¾Œç«¯å‚³ä¾†çš„è³‡æ–™ä¾æ“šè‡ªå·±å–œæ­¡çš„æ–¹å¼æ”¾ç½®å³å¯ï¼Œå¦‚éœ€è¦åƒè€ƒå¯ä»¥åˆ° et860525/restaurant-management/viewsã€‚\nçµèª æ•´å€‹å°ˆæ¡ˆåˆ°é€™è£¡å°±å‘Šä¸€æ®µè½äº†ï¼Œå‰©ä¸‹çš„å…¶ä»– table çš„åŠŸèƒ½åŸºæœ¬ä¸Šå»ºç«‹çš„æ–¹å¼éƒ½å¤§è‡´ç›¸åŒã€‚é€™æ¨£ç”¨ OOP æ–¹å¼åˆ†é–‹å„å€‹å…ƒä»¶æœ‰å¹¾å€‹å¥½è™•ï¼š\nå°ˆè²¬åˆ†é¡ï¼šæ ¹æ“šåŠŸç”¨åˆ†é–‹æ‰ä¸æœƒè®“å–®ä¸€æ”¯ç¨‹å¼è² æ“”å¤ªå¤§ æ¸…æ¥šæ¨™ç¤ºï¼šåˆ†é¡å¾Œå°±èƒ½çŸ¥é“å“ªä¸€å€‹å…ƒä»¶åšå“ªä¸€ä»¶äº‹æƒ…ï¼Œå°±ä¸æœƒ controller é‚„è¦ç²å¾—è³‡æ–™åº«è³‡æ–™ æ¸¬è©¦æ–¹ä¾¿ï¼šå¯ä»¥å°å–®ä¸€å€‹å…ƒä»¶é€²è¡Œæ¸¬è©¦ ","permalink":"https://et860525.github.io/posts/restaurant-management-modify-base-code/","summary":"\u003cp\u003eç•¶æˆ‘é–‹å§‹å®Œå–„å„å€‹åŠŸèƒ½æ™‚ï¼Œå°±ç™¼ç¾å›å‚³ view æ‰€éœ€è¦çš„å‡½å¼ä¸åªæœ‰ \u003ccode\u003erender\u003c/code\u003eï¼Œåœ¨æŸäº›æ™‚å€™é‚„æ˜¯è¦ä½¿ç”¨ \u003ccode\u003eredirect\u003c/code\u003eï¼Œè€Œç•¶é€™æ¨£æœƒæœ‰å…©ç¨®æ ¼å¼è¦å›å‚³æ™‚ï¼Œæˆ‘å°±æœƒå»ºç«‹ \u003cstrong\u003eResponse Object\u003c/strong\u003e ä¾†åˆ¶å®šå›å‚³çš„æ ¼å¼ï¼Œä¸¦ä¸”åœ¨ \u003ccode\u003eroute.base\u003c/code\u003e ä¸­å°±è¦å¤šä¸€å€‹å°ˆé–€è™•ç† \u003ccode\u003eredirect\u003c/code\u003e çš„å‡½å¼ã€‚\u003c/p\u003e\n\u003cp\u003eç•¶é€™äº›éƒ½å®Œæˆå¾Œï¼Œå°±å¯ä»¥é–‹å§‹å¯¦ä½œç¶²é çš„åŠŸèƒ½äº†ï¼Œåœ¨é€™ç¯‡æ–‡ç« è£¡æˆ‘æœƒå¯¦ä½œ \u003ccode\u003eMenuItem\u003c/code\u003e çš„ CRUDã€‚\u003c/p\u003e\n\u003cp\u003eGithubï¼š\u003ca href=\"https://github.com/et860525/restaurant-management\"\u003eet860525/restaurant-management\u003c/a\u003e\u003c/p\u003e","title":"Restaurant Management å°ˆæ¡ˆ(ä¸‰) - æ–°å¢ Response Object èˆ‡å®Œæˆ MenuItem"},{"content":"æ¥ä¸‹ä¾†å°±è¦è¨­è¨ˆ Model èˆ‡å»ºç«‹ Repository ä¾†è·Ÿè³‡æ–™åº«é€²è¡Œäº¤äº’ã€‚\né¦–å…ˆï¼Œè¨­è¨ˆ Model çš„ç¯„æœ¬æ˜¯ä¾†è‡ª Cheseto Restaurant POS App - Full Previewï¼Œæ­¤ç¯„æœ¬åŒ…å«å››å€‹ tableï¼š\nTableï¼šé¤å»³è£¡çš„æ¡Œå­ MenuItemï¼šèœå–®å“é … Orderï¼šè¨‚å–® Customerï¼šå®¢äººçš„è³‡è¨Š å®Œæˆ Model å¾Œï¼Œå…ˆå¯«å‡º repository.base å†å¥—ç”¨åˆ°å„è‡ªçš„ table ä¸Šï¼Œä»¥ä¸Šã€‚\nGithubï¼šet860525/restaurant-management\nè¨­è¨ˆ Model ä»¥ä¸Šè³‡æ–™åº«çš„é‡é»ç‚ºï¼š\nä¸€å€‹é¡§å®¢ (Customer) å¯ä»¥æœ‰å¤šå¼µè¨‚å–® (Order) ä¸€å¼µæ¡Œå­ (Table) å¯ä»¥æœ‰å¤šå¼µè¨‚å–® (Order) è¨‚å–® (Order) èˆ‡ èœå–®å“é … (MenuItem) æ˜¯å¤šå°å¤š (many-to-many) çš„é—œä¿‚ï¼Œè€Œé€™è£¡ä½¿ç”¨ Explicit many-to-many relationsï¼ŒåŸå› æ˜¯æˆ‘æƒ³å°‡èœå–®å“é …çš„æ•¸é‡æ”¾åœ¨è£¡é¢ ä»¥ä¸‹æ˜¯ Prisma çš„ç¨‹å¼ç¢¼ï¼š\ngenerator client { provider = \u0026#34;prisma-client-js\u0026#34; } datasource db { provider = \u0026#34;postgresql\u0026#34; url = env(\u0026#34;DATABASE_URL\u0026#34;) } model Customer { id Int @id @default(autoincrement()) name String phone String email String @unique address String orders Order[] } model MenuItem { id Int @id @default(autoincrement()) name String description String? price Float orders OrderItem[] } model Order { id Int @id @default(autoincrement()) customer Customer @relation(fields: [customerId], references: [id]) customerId Int table Table @relation(fields: [tableId], references: [id]) tableId Int items OrderItem[] tag String @default(dbgenerated(\u0026#34;lpad(nextval(\u0026#39;order_tag_seq\u0026#39;)::text, 6, \u0026#39;0\u0026#39;)\u0026#34;)) status Order_status @default(PLACED) payment_method Payment @default(Cash) createdAt DateTime @default(now()) } model OrderItem { order Order @relation(fields: [orderId], references: [id]) orderId Int menuItem MenuItem @relation(fields: [menuItemId], references: [id]) menuItemId Int quantity Int @@id([orderId, menuItemId]) } model Table { id Int @id @default(autoincrement()) number Int capacity Int status Table_status @default(Free) orders Order[] } enum Order_status { PLACED IN_PROGRESS COMPLETED CANCELLED } enum Table_status { Free Checked_in Reserved } enum Payment { Cash Debit E_wallet } é¦–å…ˆè¦æ³¨æ„çš„æ˜¯ Order è£¡é¢çš„ tag æ¬„ä½ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°‡ tag é¡¯ç¤ºæˆ 000001ã€‚ @default(dbgenerated(\u0026quot;lpad(nextval('order_tag_seq')::text, 6, '0')\u0026quot;))ï¼š\ndbgenerated()ï¼šè¡¨ç¤ºæœ‰äº›åŠŸèƒ½æ²’è¾¦æ³•å† Primsa ä½¿ç”¨ï¼Œä½†æ˜¯åœ¨è³‡æ–™åº«è£¡å¯ä»¥ lpad(string, length[, fill])ï¼šå°‡æŒ‡å®šå­—ä¸²çš„å·¦é‚Šå¡«å……æŒ‡å®šå­—ä¸²åˆ°æŒ‡å®šé•·åº¦ nextvalï¼šæ ¹æ“š Sequences çš„ INCREMENT ä¾†ç²å¾—ä¸‹ä¸€å€‹å€¼ ç”±æ–¼ order_tag_seq å®ƒçš„æ¬„ä½å‹åˆ¥æ˜¯ SEQUENCEï¼Œä½†æ˜¯åœ¨ Primsa æ˜¯ç„¡æ³•åŠ å…¥é€™å€‹å‹åˆ¥çš„æ¬„ä½ï¼Œæ‰€ä»¥é€™è£¡å¿…é ˆè¦å…ˆå°‡ migrate æª”æ¡ˆç”¢ç”Ÿå‡ºä¾†å¾Œï¼Œå†ä¾†æ”¹è£¡é¢çš„ SQL èªæ³•ã€‚å…¶æ­¥é©Ÿç‚ºï¼š\nå…ˆè¼¸å…¥ prisma migrate dev --create-only ( åƒè€ƒä¾†æº Customizing migrations ) åˆ°å‰›å‰›ç”¢ç”Ÿçš„ migrate æª”æ¡ˆ (prisma/migrations/20230310190516_test/migration.sql) ä¸‹æ–°å¢ CREATE SEQUENCE order_tag_seq START 1; å†ä½¿ç”¨ prisma migrate dev å³å¯å®Œæˆ å¦‚æœæ²’æœ‰ä¸Šé¢çš„æ­¥é©Ÿï¼Œè€Œæ˜¯ç›´æ¥ migrate å°±æœƒå‡ºç¾éŒ¯èª¤ï¼Œå› ç‚ºæ‰¾ä¸åˆ° order_tag_seq é€™å€‹æ¬„ä½ã€‚\nRepository å¦‚æœæ˜¯ä½¿ç”¨ Mongoose çš„å°ˆæ¡ˆï¼Œç‚ºäº†æ»¿è¶³Layered Architecture å°±è¦å…ˆå»ºç«‹ä¸€å€‹ Repository ä¾†å­˜æ”¾èˆ‡è³‡æ–™åº«äº¤äº’çš„ç¨‹å¼ç¢¼ï¼Œå†ç”±éœ€è¦è³‡æ–™åº«è³‡æ–™çš„ç›¸é—œç¨‹å¼ç¢¼ä¾†å‘¼å«ï¼Œå¦‚ï¼šServiceã€‚ä½†åœ¨ Prisma è£¡å°±æœƒæ¯”è¼ƒç°¡å–®ï¼Œé€™æ˜¯å› ç‚º Prisma Client æœ¬èº«å°±æ˜¯ä¸€å€‹ Object ç›´æ¥ä½¿ç”¨å³å¯ï¼Œç›¸é—œçš„è³‡æ–™æ ¼å¼å¯ä»¥åœ¨ Service æª”æ¡ˆè£¡åšèª¿æ•´ã€‚\nå˜—è©¦å¯«ä¸€å€‹ Repository Base åœ¨ä½¿ç”¨ Prisma Client æ™‚ï¼Œæˆ‘ä¸€ç›´åœ¨å˜—è©¦è®“ç¨‹å¼ç¢¼æ›´ç°¡æ½”ã€‚å› ç‚ºæˆ‘æœ‰å››å€‹ tables å°±è¦å»ºç«‹å››å€‹ Repository çš„æª”æ¡ˆï¼Œæˆ‘æœ‰æƒ³éè®“æ¯ä¸€å€‹ table éƒ½ç¹¼æ‰¿ä¸€å€‹ Repository Base ç‰©ä»¶ï¼Œä¸¦è®“é€™å€‹ Repository Base ç›´æ¥å¯¦ä½œæ‰€æœ‰ç²å–è³‡æ–™çš„æ–¹å¼ï¼Œä»¥ä¸‹åªæ˜¯æ€è€ƒçš„ç¨‹å¼ç¢¼ä¸¦ä¸èƒ½åŸ·è¡Œï¼š\nimport { PrismaClient, MenuItem, Order, Customer, Table } from \u0026#39;@prisma/client\u0026#39;; export abstract class RepositoryBase { protected modelName: string = \u0026#39;\u0026#39;; private prisma = new PrismaClient(); public async get(id: number): Promise\u0026lt;MenuItem | Order | Customer | Table | null\u0026gt; { return await this.[modelName].findUnique({ where: { id: id }, }) } } é›–ç„¶é€™å€‹æ¨£å­å¯ä»¥å°‘å¯«ç¨‹å¼ç¢¼ï¼Œä½†æ˜¯åœ¨æœ‰äº› table æœ‰ relations æ™‚ï¼Œå¯èƒ½å°±æœƒéœ€è¦ä½¿ç”¨åˆ° includeã€‚å¦‚æœæ˜¯åœ¨ create çš„æƒ…æ³ä¸‹ï¼Œå°±è¦åœ¨ç›¸æ‡‰çš„ Repository ä¸‹é‡å¯«æ•´å€‹ create ç¨‹å¼ç¢¼ï¼Œé‚£é€™æ¨£é‚„ä¸å¦‚å°±ç›´æ¥æ ¹æ“šç›¸å°æ‡‰çš„ tableï¼Œä¾†å¯«ç›¸å°æ‡‰çš„ç¨‹å¼ç¢¼å°±å¥½äº†ã€‚\næˆ‘æœ‰è©¦éä½¿ç”¨ switchï¼Œä½†æ˜¯é‚£å€‹å¯è®€æ€§é‚„ä¸å¦‚å¯«åœ¨å„è‡ªçš„ Repository æª”æ¡ˆè£¡\nå¯¦ä½œ ä¸Šé¢æœ‰èªªåˆ°ï¼Œç›´æ¥ä½¿ç”¨ Prisma Client ç‰©ä»¶å°±å¯ä»¥äº†ï¼Œæ‰€ä»¥é€™è£¡æˆ‘æœƒç›´æ¥åœ¨ Service æª”æ¡ˆè£¡ç›´æ¥ä½¿ç”¨ Prisma Clientï¼š\nimport { Prisma, PrismaClient, MenuItem } from \u0026#39;@prisma/client\u0026#39;; export class MenuItemService { private readonly prisma = new PrismaClient(); public async get(id: number): Promise\u0026lt;MenuItem | null\u0026gt; { return await this.prisma.menuItem.findUnique({ where: { id: id }, }); } public async get_many( skip: number, take: number ): Promise\u0026lt;MenuItem[] | null\u0026gt; { return await this.prisma.menuItem.findMany({ skip: skip, take: take, }); } public async create( name: string, description: string, price: string ): Promise\u0026lt;MenuItem\u0026gt; { return await this.prisma.menuItem.create({ data: { name: name, description: description, price: Number(price), }, }); } public async delete(id: number): Promise\u0026lt;MenuItem\u0026gt; { return await this.prisma.menuItem.delete({ where: { id: id }, }); } } Controller æœƒå°‡ç²å¾—çš„åƒæ•¸ ( req æˆ– Controller æœ¬èº«çš„åƒæ•¸ ) é€åˆ° Service è£¡ï¼ŒService æœƒä½¿ç”¨ Prisma Client ä¾†è·Ÿè³‡æ–™åº«äº¤äº’ï¼Œæœ€å¾Œç²å¾—çš„çµæœå†å›å‚³çµ¦ Controllerã€‚\nç›®å‰æˆ‘åªå®Œæˆ MenuItem tableï¼Œå¾Œé¢ä¸‰å€‹åƒæ•¸æˆ‘æœƒæ…¢æ…¢å®Œæˆï¼Œå®Œæˆå¾Œï¼Œå°±æœƒé–‹å§‹æŠŠå‰ç«¯çš„éƒ¨åˆ†å®Œæˆ\nçµèª å› ç‚ºå®˜ç¶²æ–‡ä»¶å¾ˆå®Œæ•´ï¼Œæ‰€ä»¥è¨­è¨ˆ Model çš„éƒ¨åˆ†å°±æ²’æœ‰é‚£éº¼å¤šçš„å•é¡Œã€‚ä½†æ˜¯åœ¨è¨­è¨ˆ Repository çš„éƒ¨åˆ†å°±å¡çš„æ¯”è¼ƒä¹…ä¸€é»ï¼Œå°±åƒä¸Šé¢å˜—è©¦çš„éƒ¨åˆ†æ’°å¯«çš„ä¸€æ¨£ï¼Œæˆ‘ä¸€ç›´å¾ˆæƒ³å°‘å¯«é€™äº›è¿‘ä¹é‡è¤‡çš„ç¨‹å¼ç¢¼ï¼Œä½†ä¹Ÿå°±æ˜¯é€™äº›å¾®çš„ä¸åŒå°±æœƒå½±éŸ¿è³‡æ–™é¡¯ç¤ºçš„ä¸åŒï¼Œä½†æˆ‘é‚„æ˜¯æƒ³å…ˆæŠŠå®ƒå€‘éƒ½å¯«å‡ºä¾†å¾Œï¼Œå†ä¾†æ…¢æ…¢çš„ä¿®æ”¹ã€‚\n","permalink":"https://et860525.github.io/posts/restaurant-management-model-repository/","summary":"\u003cp\u003eæ¥ä¸‹ä¾†å°±è¦è¨­è¨ˆ \u003ccode\u003eModel\u003c/code\u003e èˆ‡å»ºç«‹ \u003ccode\u003eRepository\u003c/code\u003e ä¾†è·Ÿè³‡æ–™åº«é€²è¡Œäº¤äº’ã€‚\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆï¼Œè¨­è¨ˆ \u003ccode\u003eModel\u003c/code\u003e çš„ç¯„æœ¬æ˜¯ä¾†è‡ª \u003ca href=\"https://dribbble.com/shots/20762377-Cheseto-Restaurant-POS-App-Full-Preview\"\u003eCheseto Restaurant POS App - Full Preview\u003c/a\u003eï¼Œæ­¤ç¯„æœ¬åŒ…å«å››å€‹ tableï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eTable\u003c/strong\u003eï¼šé¤å»³è£¡çš„æ¡Œå­\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eMenuItem\u003c/strong\u003eï¼šèœå–®å“é …\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eOrder\u003c/strong\u003eï¼šè¨‚å–®\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eCustomer\u003c/strong\u003eï¼šå®¢äººçš„è³‡è¨Š\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eå®Œæˆ \u003ccode\u003eModel\u003c/code\u003e å¾Œï¼Œå…ˆå¯«å‡º \u003ccode\u003erepository.base\u003c/code\u003e å†å¥—ç”¨åˆ°å„è‡ªçš„ table ä¸Šï¼Œä»¥ä¸Šã€‚\u003c/p\u003e\n\u003cp\u003eGithubï¼š\u003ca href=\"https://github.com/et860525/restaurant-management\"\u003eet860525/restaurant-management\u003c/a\u003e\u003c/p\u003e","title":"Restaurant Management å°ˆæ¡ˆ(äºŒ) - å»ºç«‹ Model èˆ‡ Repository"},{"content":"é€™å€‹å°ˆæ¡ˆæœƒä½¿ç”¨ OOP çš„æ–¹å¼ä¾†å»ºæ§‹ï¼Œå‰ç«¯éƒ¨åˆ†æœƒä»¥ç°¡å–®çš„æ–¹å¼å‘ˆç¾ã€‚\næ•´å€‹æ¶æ§‹æœƒç”¨åˆ°çš„é‡è¦å¥—ä»¶ï¼š\nPackage Usage Express Web æ‡‰ç”¨æ¡†æ¶ TypeScript é–‹ç™¼å·¥å…· Prisma è¨ªå•è³‡æ–™åº« Docker æ‡‰ç”¨å®¹å™¨åŒ– PostgreSQL è³‡æ–™åº« æ­¤å°ˆæ¡ˆçš„ç›®çš„æ˜¯è¦è®“ Express ä½¿ç”¨ Prisma ä¾†è¨ªå•è³‡æ–™åº«ï¼Œä¸¦ä¸”ä½¿ç”¨ Docker ä¾†å»ºç«‹ PostgreSQL è³‡æ–™åº«ã€‚\nGithubï¼šet860525/restaurant-management\nå°ˆæ¡ˆæ¶æ§‹ æ•´å€‹å°ˆæ¡ˆçš„æ¶æ§‹å¤§è‡´æœƒéµå¾ª et860525/express-project-architectureã€‚\næœ€å¤§çš„ä¸åŒå°±æ˜¯è³‡æ–™åº«çš„éƒ¨åˆ†ï¼Œå› ç‚ºé€™ä¸€å€‹å°ˆæ¡ˆä½¿ç”¨çš„æ˜¯ Prismaï¼Œæ‰€ä»¥æˆ‘ä¸éœ€è¦å…ˆåšé€£æ¥è³‡æ–™åº«çš„å‹•ä½œã€‚å»ºç«‹ model çš„åœ°æ–¹æœƒæ”¹æˆ prisma/schema.prismaã€‚\né€™è£¡æˆ‘æœƒå…ˆå»ºç«‹ä¸€å€‹ç°¡å–®çš„ model ä¾†åšæ¸¬è©¦ï¼š\ngenerator client { provider = \u0026#34;prisma-client-js\u0026#34; } datasource db { provider = \u0026#34;postgresql\u0026#34; url = env(\u0026#34;DATABASE_URL\u0026#34;) } model Restaurant { id Int @id @default(autoincrement()) name String address String? phone String? createdAt DateTime @default(now()) updatedAt DateTime @updatedAt } å®Œæˆå¾Œä½¿ç”¨ pnpx prisma migrate dev --name init ä¾†å°‡ model migrate é€²è³‡æ–™åº«ã€‚\nè¨ªå•è³‡æ–™åº« å°‡è³‡æ–™åº«éƒ¨å±¬åœ¨ Docker è£¡ï¼Œè¼¸å…¥ docker compose up -dã€‚å› ç‚ºæˆ‘æœ‰åœ¨è¨­å®šè£¡å¯« restart: alwaysï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡éƒ¨å±¬å¾Œï¼Œå¾€å¾Œåªè¦é‡æ–°é‹è¡Œ Docker å°±æœƒè‡ªå‹•å•Ÿå‹•ã€‚\nPrisma æä¾› Prisma Client ä¾†è¨ªå•è³‡æ–™åº«é€²è€Œç²å–è³‡æ–™ã€‚\næˆ‘æŠŠè¨ªå•è³‡æ–™åº«çš„ç¨‹å¼ç¢¼å¯«åœ¨ src/repositories/restaurant.repository.tsï¼š\nimport { PrismaClient } from \u0026#39;@prisma/client\u0026#39;; export class RestaurantRepository { private prisma = new PrismaClient(); public async addRestaurant(name: string, address: string, phone: string) { const result = await this.prisma.restaurant.create({ data: { name, address, phone, }, }); return result; } public async getRestaurant(id: string) { const restaurant = await this.prisma.restaurant.findUnique({ where: { id: Number(id), }, }); return restaurant; } public async getRestaurants(skip: number = 0, take: number = 10) { const take_og = 10; const restaurants = await this.prisma.restaurant.findMany({ skip: skip, take: Math.min(take, take_og), }); return restaurants; } } é€™è£¡å¾ˆå¤šæ±è¥¿éƒ½æ²’æœ‰å¯«å¾—å¾ˆå®Œæ•´ï¼Œåƒæ˜¯å›å‚³å‹åˆ¥ã€å‘½åæœ‰å†—è©ä¹‹é¡çš„ï¼Œä¸éç›®å‰åªæ˜¯ç‚ºäº†æ–¹ä¾¿æ¸¬è©¦æˆ‘å°±æ²’æœ‰å¯«å¾—å¤ªè©³ç´°ï¼Œå¾€å¾Œæœƒå¯«çš„æ›´åŠ å®Œæ•´ã€‚\nController èˆ‡ Route é€šå¸¸åªè¦èƒ½æŠŠè¨ªå•è³‡æ–™åº«çš„éƒ¨åˆ†åšå‡ºä¾†ï¼Œåœ¨ Controller èˆ‡ Route çš„éƒ¨åˆ†æˆ‘è¦ºå¾—å°±æ¯”è¼ƒè¼•é¬†äº†ã€‚ä¸éé€™è·Ÿä¸Šä¸€å€‹ API å°ˆæ¡ˆä¸åŒï¼Œé€™æ¬¡æœ‰ç”¨åˆ° view ä¾†é¡¯ç¤ºå‰ç«¯ï¼Œæ‰€ä»¥æˆ‘å¿…é ˆè¦å…ˆæ›´æ”¹ src/base/controller.base.ts èˆ‡ src/base/route.base.tsï¼š\nsrc/base/route.base.ts import { Router, Request, Response, NextFunction } from \u0026#39;express\u0026#39;; import { ControllerBase } from \u0026#39;./controller.base\u0026#39;; export abstract class RouteBase { public router: Router = Router(); protected controller!: ControllerBase; constructor() { this.initial(); } protected initial(): void { this.registerRoute(); } protected abstract registerRoute(): void; protected responseHandler( method: (req: Request, res: Response, next: NextFunction) =\u0026gt; Promise\u0026lt;any\u0026gt; ) { return (req: Request, res: Response, next: NextFunction) =\u0026gt; { method .call(this.controller, req, res, next) .then((obj) =\u0026gt; res.render(obj.template, obj.data)) .catch((err) =\u0026gt; next(err)); }; } } responseHandler æœƒå‘¼å« controller ä¸Ÿé€²å»çš„ methodï¼Œç•¶ä»–å®Œæˆå¾Œæœƒå›å‚³ template çš„åå­—èˆ‡ template è¦ä½¿ç”¨çš„è³‡æ–™ã€‚ src/base/controller.base.ts export abstract class ControllerBase { public formatResponse(template: string, data?: any) { const responseObject = { template: template, data: data }; return responseObject; } } åªéœ€è¦å°‡ template çš„åå­—èˆ‡çµ¦ template ä½¿ç”¨çš„è³‡æ–™ä¸Ÿå›å³å¯ã€‚ å¯¦åš src/main/restaurant/restaurant.controller.ts import { Request } from \u0026#39;express\u0026#39;; import { ControllerBase } from \u0026#39;../../base/controller.base\u0026#39;; import { RestaurantRepository } from \u0026#39;../../repositories/restaurant.repository\u0026#39;; export class RestaurantController extends ControllerBase { private readonly restaurantRepo = new RestaurantRepository(); public async addRestaurant_get() { return this.formatResponse(\u0026#39;restaurant_form\u0026#39;); } public async addRestaurant(req: Request) { const { name, address, phone } = req.body; console.log(req.body); const result = await this.restaurantRepo.addRestaurant( name, address, phone ); console.log(result); return this.formatResponse(\u0026#39;restaurant_form\u0026#39;, { result: result }); } public async getRestaurant(req: Request) { const { id } = req.params; const restaurant = await this.restaurantRepo.getRestaurant(id); return this.formatResponse(\u0026#39;restaurant\u0026#39;, { restaurant: restaurant }); } public async getRestaurants(req: Request) { const skip = req.query.skip || 0; const take = req.query.take || 10; const restaurants = await this.restaurantRepo.getRestaurants( Number(skip), Number(take) ); return this.formatResponse(\u0026#39;restaurant_list\u0026#39;, { restaurants: restaurants, }); } } src/main/restaurant/restaurant.routing.ts import express, { Request, Response, NextFunction } from \u0026#39;express\u0026#39;; import { RouteBase } from \u0026#39;../../base/route.base\u0026#39;; import { RestaurantController } from \u0026#39;./restaurant.controller\u0026#39;; export class RestaurantRoute extends RouteBase { protected controller!: RestaurantController; constructor() { super(); } protected initial(): void { this.controller = new RestaurantController(); super.initial(); } protected registerRoute(): void { this.router.get(\u0026#39;/\u0026#39;, (req: Request, res: Response, next: NextFunction) =\u0026gt; { res.render(\u0026#39;index\u0026#39;); }); this.router.get( \u0026#39;/restaurant\u0026#39;, this.responseHandler(this.controller.getRestaurants) ); this.router .route(\u0026#39;/restaurant/create\u0026#39;) .get(this.responseHandler(this.controller.addRestaurant_get)) .post( express.json(), this.responseHandler(this.controller.addRestaurant) ); this.router.get( \u0026#39;/restaurant/:id\u0026#39;, this.responseHandler(this.controller.getRestaurant) ); } } ç›®å‰åªæœ‰å¯¦ä½œï¼š\næ–°å¢ (add) GET é¡¯ç¤ºè¡¨æ ¼ POST æ–°å¢è³‡æ–™ å–®å€‹æŸ¥è©¢ (getRestaurant) å¤šå€‹æŸ¥è©¢ (getRestaurants) é€™æ¨£æ•´å€‹æ¸¬è©¦çš„å°ˆæ¡ˆå°±å®Œæˆäº†ã€‚\nçµèª æˆ‘æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ Prisma ä¾†è¨ªå•è³‡æ–™åº«ï¼Œä»¥å‰éƒ½æ˜¯ä½¿ç”¨ Mongoose ODM ä¾†æ“ä½œè³‡æ–™åº«çš„éƒ¨åˆ†ã€‚\næ¥ä¸‹ä¾†æˆ‘æœƒé–‹å§‹å°‡å°ˆæ¡ˆæ”¹æˆå¯¦éš›ä½¿ç”¨ç‹€æ…‹ï¼Œæ‰€ä»¥ç¾åœ¨çš„ model æˆ‘é‚„æœƒå†åšä¿®æ”¹ã€‚\n","permalink":"https://et860525.github.io/posts/restaurant-management-init/","summary":"\u003cp\u003eé€™å€‹å°ˆæ¡ˆæœƒä½¿ç”¨ OOP çš„æ–¹å¼ä¾†å»ºæ§‹ï¼Œå‰ç«¯éƒ¨åˆ†æœƒä»¥ç°¡å–®çš„æ–¹å¼å‘ˆç¾ã€‚\u003c/p\u003e\n\u003cp\u003eæ•´å€‹æ¶æ§‹æœƒç”¨åˆ°çš„é‡è¦å¥—ä»¶ï¼š\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003ePackage\u003c/th\u003e\n\u003cth\u003eUsage\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ca href=\"https://expressjs.com/\"\u003eExpress\u003c/a\u003e\u003c/td\u003e\n\u003ctd\u003eWeb æ‡‰ç”¨æ¡†æ¶\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ca href=\"https://www.typescriptlang.org/\"\u003eTypeScript\u003c/a\u003e\u003c/td\u003e\n\u003ctd\u003eé–‹ç™¼å·¥å…·\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ca href=\"https://www.prisma.io/\"\u003ePrisma\u003c/a\u003e\u003c/td\u003e\n\u003ctd\u003eè¨ªå•è³‡æ–™åº«\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ca href=\"https://www.docker.com/\"\u003eDocker\u003c/a\u003e\u003c/td\u003e\n\u003ctd\u003eæ‡‰ç”¨å®¹å™¨åŒ–\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ca href=\"https://www.postgresql.org/\"\u003ePostgreSQL\u003c/a\u003e\u003c/td\u003e\n\u003ctd\u003eè³‡æ–™åº«\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003eæ­¤å°ˆæ¡ˆçš„ç›®çš„æ˜¯è¦è®“ Express ä½¿ç”¨ Prisma ä¾†è¨ªå•è³‡æ–™åº«ï¼Œä¸¦ä¸”ä½¿ç”¨ Docker ä¾†å»ºç«‹ PostgreSQL è³‡æ–™åº«ã€‚\u003c/p\u003e\n\u003cp\u003eGithubï¼š\u003ca href=\"https://github.com/et860525/restaurant-management\"\u003eet860525/restaurant-management\u003c/a\u003e\u003c/p\u003e","title":"Restaurant Management å°ˆæ¡ˆ(ä¸€) - æ¶æ§‹èˆ‡åˆå§‹åŒ–"},{"content":"ä½¿ç”¨ Docker ä¾†å»ºç½® MongoDBï¼Œå¯ä»¥å…ˆåˆ° docker mongo ä¾†é¸æ“‡ç‰ˆæœ¬ã€‚\nMongoDB æœƒæœ‰å¹¾ç¨®æ¶æ§‹ï¼š\nStandalone å»ºç«‹é›£åº¦ ä½ å–®ä¸€ MongoDB è³‡æ–™åº« Replica Set å»ºç«‹é›£åº¦ ä¸­ è³‡æ–™æœƒæœ‰å¤šå€‹å‰¯æœ¬æä¾›å®¹éŒ¯ç©ºé–“ Sharded Cluster å»ºç«‹é›£åº¦ é«˜ è³‡æ–™æ”¾ç½®åœ¨ä¸åŒçš„ shardï¼Œæ¯å€‹ shard æˆ– config servers éƒ½æ˜¯ Replica Set Standalone Standalone è¡¨ç¤ºåªæœ‰ä¸€å€‹ MongoDB å¯¦é«”ï¼ŒMongo Client åªè¦ç›´æ¥é€£æ¥å®ƒå°±å¯ä»¥ä½¿ç”¨ã€‚\næ ¹æ“š Docker compose file æ‰€é¡¯ç¤ºï¼Œ2023å¹´å…­æœˆå¾Œå°±ä¸æœƒæ”¯æ´ Compose V1 ï¼Œæ‰€ä»¥é™¤äº†åœ¨ Standalone æœƒè©¦åšä¸€å€‹ V1ï¼Œå…¶ä»–éƒ½æœƒæ›æˆ Compose V2 çš„æ ¼å¼\nDocker compose V1 ä½¿ç”¨ docker-compose ä¾†å»ºç«‹ MongoDBï¼š\n# docker-compose.yml versio: \u0026#39;3.1\u0026#39; services: mongo: image: mongo:latest container_name: mongodb environment: MONGO_INITDB_ROOT_USERNAME: root MONGO_INITDB_ROOT_PASSWORD: example ports: - \u0026#39;27017:27017\u0026#39; volumes: - mongo-mount-data:/data/db é‹è¡Œ docker-composeï¼š\n# Start docker-compose up -d # Close docker-compose down Docker compose V2 # docker-compose.yaml services: mongo: image: mongo:latest container_name: mongodb-test environment: MONGO_INITDB_ROOT_USERNAME: root MONGO_INITDB_ROOT_PASSWORD: example ports: - \u0026#39;27017:27017\u0026#39; volumes: - mongo-mount-data:/data/db é‹è¡Œ docker composeï¼š\n# Start docker compose up -d # Close docker compose down é€²å…¥ mongoDB docker exec -it \u0026lt;mongo-name\u0026gt; bash è¼¸å…¥å¾Œæœƒçœ‹åˆ°å‘½ä»¤åˆ—æœƒç”± root é–‹é ­ï¼Œæ¥è‘—å†è¼¸å…¥ï¼š\n# 5.0+ mongosh -u root -p # 4.0 mongo -u root -p è¼¸å…¥å¯†ç¢¼å¾Œï¼Œå°±å¯ä»¥é€²å…¥ MongoDB äº†ã€‚\nä½¿ç”¨ VM æœƒé‡åˆ°çš„å•é¡Œ å¦‚æœåœ¨ VM ä¸‹ä½¿ç”¨ MongoDB 5.0+ ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œæœ‰å¯èƒ½æœƒçœ‹åˆ°ï¼š\nWARNING: MongoDB 5.0+ requires a CPU with AVX support, and your current system does not appear to have that! æ ¹æ“š Mongo DB deployment not working in kubernetes because processor doesn\u0026rsquo;t have AVX support\nå¦‚æœæ˜¯ Windows + VirtualBox å¯ä»¥åœ¨ CMD è¼¸å…¥ï¼š\nbcdedit /set hypervisorlaunchtype off DISM /Online /Disable-Feature:Microsoft-Hyper-V é‡é–‹æ©Ÿå¾Œå°±å¯ä»¥è§£æ±ºã€‚\nç›®å‰æˆ‘é€™è£¡é‚„æ˜¯æœ‰ä½¿ç”¨ WSL2ï¼Œå¦‚æœè¼¸å…¥ä»¥ä¸ŠæŒ‡ä»¤å¯èƒ½æœƒé€ æˆ WSL2 ç„¡æ³•ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘é¸æ“‡ä½¿ç”¨èˆŠç‰ˆæœ¬ï¼Œæš«ä¸”ä¸ä½¿ç”¨ mongo:5.0+ã€‚\nReplica Set MongoDB Replication å¯ä»¥å»ºç«‹ä¸€ä»½è³‡æ–™åº«å‰¯æœ¬ï¼Œåœ¨ä¸»è¦çš„è³‡æ–™åº«ç™¼ç”Ÿå•é¡Œæ™‚ï¼Œå‰¯æœ¬å¯ä»¥ç›´æ¥æ¥æ‰‹ä¸»è¦è³‡æ–™åº«çš„å·¥ä½œã€‚\nä½¿ç”¨ Replica Set çš„é‡é»ï¼š\nReplica Set æœƒæä¾› High availability ä¾ç…§ç¡¬é«”è¦æ ¼ä¾†èª¿æ•´ Replica Setï¼Œä¾‹å¦‚ï¼šæ›´å¤§æ›´å¿«çš„ç¡¬ç¢Ÿ ä¸æœƒå½±éŸ¿ Primaryï¼Œä½¿ç”¨ Read Preference ä¾†è®€å–æ›´å¿«æ›´è¿‘çš„å‰¯æœ¬ MongoDB Replication çš„æ¶æ§‹ MongoDB Replication ä¸»è¦çš„æ¶æ§‹çš„æ§‹æˆï¼š\nReplica Set Member æœ‰å…©ç¨®ï¼š\nPrimaryï¼šæ¥å—æ‰€æœ‰è®€å¯«çš„æ“ä½œ Secondariesï¼šè¤‡è£½ Primary çš„è³‡æ–™ æœ€åŸºæœ¬çš„ Replica Set éœ€è¦æœ‰ä¸‰å€‹æ•¸æ“šæ‰¿è¼‰æˆå“¡ ( data-bearing members )ï¼šä¸€å€‹ Primary èˆ‡äºŒå€‹ Secondaryï¼š\nåœ¨æŸäº›æƒ…æ³ä¸‹ ( ä¾‹å¦‚ï¼šç¡¬é«”é™åˆ¶ ) å¯ä»¥å°‡æŸå€‹ member æ”¹ç‚º arbiterï¼Œå®ƒåªæœƒåƒèˆ‡ æŠ•ç¥¨ ( elections ) ä¸¦ä¸æœƒæ“æœ‰ä»»ä½•è³‡æ–™ï¼Œæ›´ä¸æœƒæˆç‚º Primaryï¼š\nä»¥ä¸‹ä½¿ç”¨ Docker compose ä¾†å»ºæ§‹ Replica Setã€‚\nDocker compose ä½¿ç”¨ Docker compose ä¾†å»ºç«‹ä¸‹æ–¹çš„æ¶æ§‹ï¼š\né€™ä¸€å€‹ Replica Set å‘½åç‚º RSï¼Œéœ€è¦ä½¿ç”¨ --replSet RS å»ºç«‹ä¸‰å€‹ container ä¾†æ»¿è¶³æœ€åŸºæœ¬çš„ Replica Setï¼š container (rs1/rs2/rs3) ï¼›port (Â 27041/27042/27043) docker-compose-replica-set.yamlï¼š\nservices: rs1: image: mongo:4.4.19-focal container_name: rs1 network_mode: host command: mongod --replSet RS --port 27041 --dbpath /data/db --config /resource/mongod.yaml volumes: - ./replica/config/mongod.yaml:/resource/mongod.yaml - ./replica/data/rs1:/data/db extra_hosts: - \u0026#34;rs1.local:127.0.0.1\u0026#34; - \u0026#34;rs2.local:127.0.0.1\u0026#34; - \u0026#34;rs3.local:127.0.0.1\u0026#34; rs2: image: mongo:4.4.19-focal container_name: rs2 network_mode: host command: mongod --replSet RS --port 27042 --dbpath /data/db --config /resource/mongod.yaml volumes: - ./replica/config/mongod.yaml:/resource/mongod.yaml - ./replica/data/rs2:/data/db extra_hosts: - \u0026#34;rs1.local:127.0.0.1\u0026#34; - \u0026#34;rs2.local:127.0.0.1\u0026#34; - \u0026#34;rs3.local:127.0.0.1\u0026#34; rs3: image: mongo:4.4.19-focal container_name: rs3 network_mode: host command: mongod --replSet RS --port 27043 --dbpath /data/db --config /resource/mongod.yaml volumes: - ./replica/config/mongod.yaml:/resource/mongod.yaml - ./replica/data/rs3:/data/db extra_hosts: - \u0026#34;rs1.local:127.0.0.1\u0026#34; - \u0026#34;rs2.local:127.0.0.1\u0026#34; - \u0026#34;rs3.local:127.0.0.1\u0026#34; network_mode è¨­å®šç‚º hostï¼Œè³‡æ–™åº«æœƒå¦‚åŒæ¶è¨­åœ¨æœ¬æ©Ÿä¸€æ¨£ï¼Œè®“ rs1.localã€rs2.local èˆ‡ rs3.local éƒ½æœƒå°æ‡‰åˆ° 127.0.0.1 command è£¡é¢çš„è¨­å®šï¼š --dbpathï¼šæŒ‡å®š MongoDB å­˜æ”¾è³‡æ–™çš„è³‡æ–™å¤¾ --portï¼šæŒ‡å®š MongoDB è¦é–‹å•Ÿçš„ Port --configï¼šæŒ‡å®š MongoDB Config file volumes è£¡é¢çš„è¨­å®šï¼š ./replica/config/mongod.yaml:/resource/mongod.yamlï¼šå…¶æ ¼å¼ç‚º A:Bï¼ŒA ç‚ºä¸»æ©Ÿç«¯çš„è·¯å¾‘ï¼›B ç‚ºå®¹å™¨å…§çš„è·¯å¾‘ã€‚ç•¶å®¹å™¨æ›è¼‰å®Œæˆï¼Œå®¹å™¨ç«¯å°±æœƒæœ‰ /resource/mongod.yaml æª”æ¡ˆï¼Œé”åˆ°è·¯å¾‘èƒ½å…±äº«è³‡æ–™çš„åŠŸèƒ½ ./replica/data/rs3:/data/dbï¼šèˆ‡ä¸Šæ–¹è¨­å®šå¾ˆåƒï¼Œè³‡æ–™å…±äº«èˆ‡ç¶å®šã€‚ç•¶ç›®å‰çš„å®¹å™¨è¢«åˆªé™¤å¾Œï¼Œå…¶è³‡æ–™éƒ½æœƒè¢«å­˜æ”¾åœ¨æœ¬æ©Ÿç«¯ï¼Œç­‰å¾…ä¸‹ä¸€å€‹å®¹å™¨æŒ‡å‘ç›¸åŒçš„ä½ç½®ï¼Œå°±å¯ä»¥ç¹¼çºŒä½¿ç”¨ä»¥å‰çš„è³‡æ–™ extra_hosts è¨­å®šè§£æçš„åŸŸå rs1.localã€rs2.local èˆ‡ rs3.local éƒ½æœƒè§£æ 127.0.0.1ï¼Œé€™æ¨£å°±ä¸ç”¨å†æ‰“ 127.0.0.1 æ¥ä¸‹ä¾†è¨­å®š MongoDB config file replica/config/mongod.yamlï¼š\nnet: bindIpAll: true storage: engine: wiredTiger wiredTiger: engineConfig: cacheSizeGB: 0.1 net Option è£¡çš„ bindIpAllï¼šè¨­å®šé‚£äº› Client IP å¯ä»¥é€£é€² MongoDBï¼Œé è¨­ç‚º localhost ä¹Ÿå°±æ˜¯åªæœ‰æœ¬æ©Ÿã€‚å‡è¨­ Client IP ä¾†è‡ªä¸åŒçš„ä¸»æ©Ÿï¼Œè¨­å®š true å°±è¡¨ç¤ºä»»ä½• Client IP éƒ½å¯ä»¥é€£é€²ä¾† storage Option è£¡çš„ engineï¼šæœ‰ wiredTigerÂ èˆ‡ inMemory å…©ç¨®ï¼Œä¸è«–é¸æ“‡å“ªä¸€å€‹éƒ½è¦å°å¿ƒè¨­å®š cacheSizeGB æˆ– inMemorySizeGB çš„å¤§å°ã€‚é€™æ˜¯å› ç‚º Mongo æœƒä¾ç…§ç¡¬é«”é…ç½®ä¾†è¨ˆç®—å…§éƒ¨ç·©å­˜çš„é è¨­å€¼ï¼Œè€Œ Mongo ä¸¦ä¸æœƒçŸ¥é“è‡ªå·±é‹è¡Œåœ¨ Docker å®¹å™¨ä¸­ï¼Œæ‰€ä»¥åœ¨åŒä¸€å€‹ Docker ä¸Šæ¶è¨­å…©å°ä»¥ä¸Šçš„ Mongoï¼Œå°±æœ‰å¯èƒ½æœƒå‡ºç¾å•é¡Œï¼Œå¦‚ï¼šæ–·ç·šæˆ–ç„¡æ³•é€£ç·šé€²å»ã€‚æ‰€ä»¥ä½¿ç”¨ Docker æ¶è¨­ Mongo ä¸€å®šè¦è¨­å®š ä»¥ä¸Šåªç”¨ä½¿ç”¨å¹¾å€‹é‡è¦çš„è¨­å®šï¼Œå®Œæ•´çš„ Mongo config å¯ä»¥åˆ° Configuration File Optionsã€‚\néƒ½å®Œæˆå¾Œï¼Œä½¿ç”¨ docker compose up -d ä¾†é‹è¡Œã€‚\nReplica Set è¨­å®š ç¢ºèªè³‡æ–™åº«é€£ç·šç‹€æ³ é€²å…¥ rs1 å®¹å™¨ï¼Œä¾†æ¸¬è©¦èƒ½å¦ç”¨åŸŸåé€£ç·šåˆ°å…¶ä»–è³‡æ–™åº«ï¼š\ndocker exec -it rs1 bash ç¢ºèªè³‡æ–™åº«é€£ç·šï¼š\nmongo rs1.local:27041 --eval \u0026#34;print(\u0026#39;rs1 ok\u0026#39;)\u0026#34; mongo rs2.local:27042 --eval \u0026#34;print(\u0026#39;rs2 ok\u0026#39;)\u0026#34; mongo rs3.local:27043 --eval \u0026#34;print(\u0026#39;rs3 ok\u0026#39;)\u0026#34; å¦‚æœéƒ½èƒ½é¡¯ç¤ºé€™äº›å­—ä¸²ï¼Œå°±å¯ä»¥é–‹å§‹è¨­å®š Replica Setã€‚\nè¨­å®š Replica Set éš¨ä¾¿é€²å…¥ä¸€å€‹ memberï¼š\nmongo rs1.local:27041 è¨­å®š Replica Set configï¼š\ncfg = { \u0026#34;_id\u0026#34;: \u0026#34;RS\u0026#34;, \u0026#34;members\u0026#34;: [{ \u0026#34;_id\u0026#34;: 0, \u0026#34;host\u0026#34;: \u0026#34;rs1.local:27041\u0026#34; }, { \u0026#34;_id\u0026#34;: 1, \u0026#34;host\u0026#34;: \u0026#34;rs2.local:27042\u0026#34; }, { \u0026#34;_id\u0026#34;: 2, \u0026#34;host\u0026#34;: \u0026#34;rs3.local:27043\u0026#34; } ] }; rs.initiate(cfg); é¡¯ç¤º ok: 1 å°±è¡¨ç¤ºå®Œæˆã€‚\nç¢ºèª Replica Set ç‹€æ…‹ ç•¶è¦å¢åŠ æˆ–æ¸›å°‘ member æ™‚ï¼Œæˆ–æ˜¯è¦æª¢æŸ¥ member æ˜¯å¦æœ‰é€£ç·šï¼Œå°±è¦ç¢ºèª member çš„ç‹€æ…‹ã€‚æœ€å¸¸ç”¨çš„æœ‰ä¸‰ç¨®ï¼š\nrs.status()ï¼šmembers çš„ç‹€æ…‹ rs.status().members.forEach(m =\u0026gt; print(`${m.name} =\u0026gt; ${m.stateStr}`)) æœƒåˆ—å‡ºï¼š rs1.local:27041 =\u0026gt; PRIMARY rs2.local:27042 =\u0026gt; SECONDARY rs3.local:27043 =\u0026gt; SECONDARY ç•¶ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ rs.status() ä¾†çœ‹æ›´è©³ç´°çš„ç‹€æ…‹ã€‚ rs.printSecondaryReplicationInfo()ï¼šmembers çš„åŒæ­¥ç‹€æ…‹ source: rs2.local:27042 syncedTo: Fri Mar 03 2023 11:50:04 GMT+0000 (UTC) 0 secs (0 hrs) behind the primary source: rs3.local:27043 syncedTo: Fri Mar 03 2023 11:50:04 GMT+0000 (UTC) 0 secs (0 hrs) behind the primary rs.printReplicationInfo()ï¼šmembers çš„ oplog ç‹€æ…‹ configured oplog size: 6040.000781059265MB log length start to end: 18735secs (5.2hrs) oplog first event time: Fri Mar 03 2023 06:33:09 GMT+0000 (UTC) oplog last event time: Fri Mar 03 2023 11:45:24 GMT+0000 (UTC) now: Fri Mar 03 2023 11:45:31 GMT+0000 (UTC) çµèª èµ·åˆæœƒæ¥è§¸åˆ° Replica Set çš„åŸå› ï¼Œæ˜¯å‡ºè‡ªæ–¼æˆ‘æƒ³ä½¿ç”¨ Prisma é€£æ¥ local MongoDBã€‚ä¸éç•¶é€£æ¥æ™‚å°±æœƒè·³å‡ºéŒ¯èª¤ï¼š\nprisma needs to perform transactions, which requires your mongodb server to be run as a replica set. é€™ä¹Ÿè®“æˆ‘æƒ³äº†è§£ä¸€ä¸‹é€™å€‹ Replica Set åˆ°åº•æ˜¯ä»€éº¼æ±è¥¿ã€‚\nè€Œçœ‹äº†è©²æ–‡ç« æ‰çŸ¥é“ï¼Œåœ¨ Docker è£¡å»ºç«‹ MongoDB æ™‚éœ€è¦è¨­å®š cacheSizeGB ä¾†è¨­å®šç·©å­˜å¤§å°ã€‚å¯èƒ½æ˜¯é€šå¸¸æˆ‘ä¹Ÿåªæœƒä½¿ç”¨åˆ°ä¸€å€‹çš„ MongoDB è³‡æ–™åº«ï¼Œæ‰€ä»¥æ‰æ²’æœ‰é‡åˆ°é‚£äº›å•é¡Œã€‚\nReference [è³‡æ–™åº«]ä½¿ç”¨ Docker æ§‹ç¯‰ä¸åŒ MongoDB æ¶æ§‹ (ä¸‰) - Replica Set ","permalink":"https://et860525.github.io/posts/docker-mongodb/","summary":"\u003cp\u003eä½¿ç”¨ Docker ä¾†å»ºç½® MongoDBï¼Œå¯ä»¥å…ˆåˆ° \u003ca href=\"https://hub.docker.com/_/mongo\"\u003edocker mongo\u003c/a\u003e ä¾†é¸æ“‡ç‰ˆæœ¬ã€‚\u003c/p\u003e\n\u003cp\u003eMongoDB æœƒæœ‰å¹¾ç¨®æ¶æ§‹ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eStandalone\n\u003cul\u003e\n\u003cli\u003eå»ºç«‹é›£åº¦ \u003cstrong\u003eä½\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003eå–®ä¸€ MongoDB è³‡æ–™åº«\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.mongodb.com/docs/manual/replication/\"\u003eReplica Set\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003eå»ºç«‹é›£åº¦ \u003cstrong\u003eä¸­\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003eè³‡æ–™æœƒæœ‰å¤šå€‹å‰¯æœ¬æä¾›å®¹éŒ¯ç©ºé–“\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.mongodb.com/docs/manual/sharding/\"\u003eSharded Cluster\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003eå»ºç«‹é›£åº¦ \u003cstrong\u003eé«˜\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003eè³‡æ–™æ”¾ç½®åœ¨ä¸åŒçš„ shardï¼Œæ¯å€‹ shard æˆ– config servers éƒ½æ˜¯ \u003ccode\u003eReplica Set\u003c/code\u003e\n\u003cimg loading=\"lazy\" src=\"/images/Docker-mongodb/Docker-sharded-cluster-production-architecture.png\" alt=\"Docker-sharded-cluster-production-architecture.png\"  /\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e","title":"Docker: è¨­å®š MongoDB"},{"content":"Pnpm ( Performant Node Package Manager ) æ˜¯ä¸€å€‹å¥—ä»¶ç®¡ç†å™¨ã€‚æ ¹æ“šå®˜ç¶²è¡¨ç¤ºï¼Œå¯ä»¥ç¯€çœç£ç¢Ÿç©ºé–“ä¸¦æå‡å®‰è£é€Ÿåº¦ã€‚\nFast, disk space efficient package manager\npnpm çš„ç‰¹é» ä¸åŒçš„å°ˆæ¡ˆå…±ç”¨ä¾è³´å¥—ä»¶ï¼Œç¯€çœç£ç¢Ÿç©ºé–“ æ‰€æœ‰ä¾è³´å¥—ä»¶çš„æª”æ¡ˆéƒ½æœƒè¢«å­˜åœ¨åŒä¸€å€‹ä½ç½®ä¸­ï¼Œç•¶æœ‰å°ˆæ¡ˆéœ€è¦ä¾è³´å¥—ä»¶æ™‚ï¼Œå®ƒçš„æª”æ¡ˆæœƒè¢«ç¡¬é€£çµåˆ°è©²ä½ç½®ï¼Œé€™æ¨£å°±ä¸æœƒæ¶ˆè€—é¡å¤–çš„ç£ç¢Ÿç©ºé–“\néæ‰å¹³åŒ–çš„ node_modules ç›®éŒ„ npm èˆ‡ yarn éƒ½æ˜¯ä»¥æ‰å¹³åŒ–çš„æ–¹å¼å»ºç«‹ node_modules ç›®éŒ„ï¼Œä»–å€‘æœƒç”¢ç”Ÿéæ³•è¨ªå•ä¾è³´çš„å•é¡Œã€‚èˆ‰å€‹ä¾‹å­ï¼Œä»Šå¤©æœ‰ Aã€B å’Œ C ä¸‰ç¨®å¥—ä»¶ï¼Œè€Œä»–å€‘ä¹‹ä¸­çš„é—œä¿‚æ˜¯ A ä¾è³´ C çš„ APIï¼Œå¦‚æœ B ç‰ˆæœ¬æ›´æ–°ä¸¦ä¾è³´ C çš„ 2.0.1 ç‰ˆæœ¬ï¼Œä½† A ä¾ç„¶é‚„æ˜¯ä½¿ç”¨èˆŠç‰ˆçš„ Cï¼Œé‚£å°±æœƒå ±éŒ¯ã€‚\nè€Œ pnpm æ˜¯ä½¿ç”¨è»Ÿé€£çµçš„æ–¹å¼ä¾†å»ºæ§‹ node_modules ç›®éŒ„ï¼š\nç•¶é–‹ç™¼è€…å®‰è£å¥—ä»¶ bar@1.0.0ï¼Œè€Œ bar@1.0.0 åˆä¾è³´ foo@1.0.0å¥—ä»¶ï¼Œæ­¤æ™‚ pnpm å°±æœƒå°‡å°ˆæ¡ˆç›´æ¥ä¾è³´çš„å¥—ä»¶ç¡¬é€£çµæ–¼ .pnpm storeã€‚è€Œ bar@1.0.0 çš„ foo@1.0.0 å°±æœƒä½¿ç”¨è»Ÿé€£çµç›´æ¥ä¾è³´çš„ foo@1.0.0ã€‚\né€™æ¨£å°±å¯ä»¥é¿å…éæ³•è¨ªå•ä¾è³´çš„å•é¡Œäº†ã€‚\næ›´å¤šèˆ‡ npm/yarn çš„æ¯”è¼ƒ Feature Comparison\nå®‰è£æ–¹å¼ æˆ‘ä½¿ç”¨çš„æ˜¯ Linux ç³»çµ±ï¼Œæ ¹æ“šå®˜ç¶²çš„æ–‡ä»¶ä¸‹è¼‰ï¼š\n# bash wget -qO- https://get.pnpm.io/install.sh | ENV=\u0026#34;$HOME/.bashrc\u0026#34; SHELL=\u0026#34;$(which bash)\u0026#34; bash - å…¶ä»–ä¸‹è¼‰æ–¹å¼ï¼špnpm Installation\nCommands npm command pnpm equivalent npm init pnpm init npm install pnpm install npm i \u0026lt;pkg\u0026gt; pnpm add \u0026lt;pkg\u0026gt; npm run \u0026lt;cmd\u0026gt; pnpm \u0026lt;cmd\u0026gt; pnpm updateï¼šå¦‚æœæ²’æœ‰åŠ ä¸Š --filter ä¾†æŒ‡å®š packageï¼Œé‚£å°±æ˜¯æ›´æ–°å…¨éƒ¨ pnpm removeï¼šä¹Ÿå¯ä»¥ä½¿ç”¨ rm, uninstall, un æ›´å¤šçš„æŒ‡ä»¤å¯ä»¥åƒè€ƒå®˜ç¶²çš„ CLI commandsã€‚\nçµè«– æœ€è¿‘é–‹å§‹è½‰æˆä½¿ç”¨ pnpmï¼Œæœ‰æ„Ÿçš„å°±æ˜¯é€Ÿåº¦å¾ˆå¿«ã€‚æœƒä½¿ç”¨å®ƒæœ€å¤§çš„åŸå› å°±æ˜¯å®ƒèƒ½å°‡ä¾è³´ä»¶éƒ½æ”¾åœ¨åŒä¸€è³‡æ–™å¤¾ç®¡ç† (å°ˆæ¡ˆè£¡çš„.pnpm)ï¼Œé€™æ¨£å°±ä¸æœƒå› ç‚ºä¸åŒçš„ä¾è³´ä»¶ç‰ˆæœ¬ï¼Œé€ æˆå…¶ä»–ä¾è³´ä»¶éŒ¯èª¤çš„å•é¡Œã€‚\nSource pnpm, Fast, disk space efficient package manager ä¸ºä»€ä¹ˆç°åœ¨æˆ‘æ›´æ¨è pnpm è€Œä¸æ˜¯ npm/yarn? ","permalink":"https://et860525.github.io/posts/pnpm/","summary":"\u003cp\u003e\u003ca href=\"https://pnpm.io/\"\u003ePnpm\u003c/a\u003e ( Performant Node Package Manager ) æ˜¯ä¸€å€‹å¥—ä»¶ç®¡ç†å™¨ã€‚æ ¹æ“šå®˜ç¶²è¡¨ç¤ºï¼Œå¯ä»¥ç¯€çœç£ç¢Ÿç©ºé–“ä¸¦æå‡å®‰è£é€Ÿåº¦ã€‚\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eFast, disk space efficient package manager\u003c/p\u003e\n\u003c/blockquote\u003e","title":"Pnpm ( Performant Node Package Manager )"},{"content":"ç”Ÿå‘½é€±æœŸ ( lifetimes ) æœƒç¢ºä¿æˆ‘å€‘åœ¨éœ€è¦å¼•ç”¨çš„æ™‚å€™ï¼Œå®ƒå€‘éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚\nåœ¨ Rust ä¸­ï¼Œæ¯å€‹å¼•ç”¨éƒ½æ˜¯æœ‰ç”Ÿå‘½é€±æœŸçš„ï¼Œç°¡å–®ä¾†èªªå°±æ˜¯å®ƒçš„æœ‰æ•ˆç¯„åœã€‚åœ¨å¤§å¤šæƒ…æ³ä¸‹ï¼Œç”Ÿå‘½é€±æœŸéƒ½æ˜¯éš±è—ä¸”å¯ä»¥æ¨å°å‡ºä¾†çš„ï¼Œå¦‚åŒå‹åˆ¥ä¸€æ¨£ä¹Ÿéƒ½æ˜¯å¯ä»¥æ¨å°å‡ºä¾†çš„ã€‚ç•¶å‹åˆ¥æœ‰å¾ˆå¤šç¨®å¯èƒ½çš„æƒ…æ³ä¸‹ï¼Œå°±è¦è©®é‡‹å‹åˆ¥ï¼ŒåŒæ¨£åœ¨ç”Ÿå‘½é€±æœŸä¸‹ï¼Œå¼•ç”¨ä»¥ä¸åŒæ–¹å¼é—œè¯çš„è©±ï¼Œå°±è¦è©®é‡‹ç”Ÿå‘½é€±æœŸã€‚\né€éç”Ÿå‘½é€±æœŸé é˜²è¿·é€”å¼•ç”¨ ç”Ÿå‘½é€±æœŸæœ€ä¸»è¦çš„ç›®çš„å°±æ˜¯è¦é é˜²è¿·é€”å¼•ç”¨ ( dangling references )ï¼š\nfn main() { let r; { let x = 5; r = \u0026amp;x; } println!(\u0026#34;r: {}\u0026#34;, r); } åœ¨é€™è£¡å˜—è©¦ä½¿ç”¨å·²ç¶“é›¢é–‹ä½œç”¨åŸŸçš„å¼•ç”¨ï¼Œå°±æœƒå¾—åˆ°éŒ¯èª¤è¨Šæ¯ï¼Œé€™æ˜¯å› ç‚º r æ‰€æŒ‡å‘çš„æ•¸å€¼å·²ç¶“é›¢é–‹ä½œç”¨åŸŸã€‚é€™ä¹Ÿè¡¨ç¤ºè®Šæ•¸ x å­˜åœ¨çš„ä¸å¤ ä¹…ã€‚é‚£ Rust è¦å¦‚ä½•æ±ºå®šç¨‹å¼ç¢¼ç„¡æ•ˆï¼Ÿå®ƒä½¿ç”¨äº†å€Ÿç”¨æª¢æŸ¥å™¨ ( borrow checker ) ä¾†åšæª¢æŸ¥ã€‚\nå€Ÿç”¨æª¢æŸ¥å™¨ ( Borrow checker ) Rust ç·¨è­¯å™¨æœ‰ä¸€å€‹å€Ÿç”¨æª¢æŸ¥å™¨ ( borrow checker ) æœƒæ¯”è¼ƒä½œç”¨åŸŸä¾†æª¢æ¸¬æ‰€æœ‰çš„å€Ÿç”¨æ˜¯å¦æœ‰æ•ˆã€‚\nä¾ä¸Šé¢çš„ç¨‹å¼ç¢¼ç‚ºä¾‹ï¼š\nfn main() { let r; // ---------+-- \u0026#39;a // | { // | let x = 5; // -+-- \u0026#39;b | r = \u0026amp;x; // | | } // -+ | // | println!(\u0026#34;r: {}\u0026#34;, r); // | } // ---------+ r çš„ç”Ÿå‘½é€±æœŸç‚º 'aï¼Œx ç‚º 'bï¼Œå¯ä»¥çœ‹åˆ° 'b çš„ç”Ÿå‘½é€±æœŸå€å¡Šæ¯” 'a é‚„è¦å°ã€‚è€Œ r å¼•ç”¨äº†ä¸€å€‹ç”Ÿå‘½é€±æœŸæ¯”ä»–è‡ªå·±é‚„çŸ­çš„è®Šæ•¸ xï¼Œæ‰€ä»¥ç¨‹å¼æœƒå ±éŒ¯ï¼šå¼•ç”¨çš„å°è±¡æ¯”å¼•ç”¨è€…å­˜åœ¨çš„æ™‚é–“é‚„çŸ­ã€‚\nä»¥ä¸‹ç‚ºä¿®æ­£ç‰ˆæœ¬ï¼š\nfn main() { let x = 5; // ----------+-- \u0026#39;b // | let r = \u0026amp;x; // --+-- \u0026#39;a | // | | println!(\u0026#34;r: {}\u0026#34;, r); // | | // --+ | } // ----------+ æ­¤æ™‚ x çš„ç”Ÿå‘½é€±æœŸ 'b æ¯” r çš„ç”Ÿå‘½é€±æœŸ 'a é‚„é•·ï¼ŒRust å°±èƒ½çŸ¥é“ r å¼•ç”¨ x æ˜¯æ°¸é æœ‰æ•ˆçš„ã€‚\nå‡½å¼ä¸­çš„æ³›å‹ç”Ÿå‘½é€±æœŸ å¯«ä¸€å€‹æ¯”è¼ƒå…©å€‹å­—ä¸²åˆ‡ç‰‡èª°æ¯”è¼ƒé•·çš„å‡½å¼ã€‚è©²å‡½å¼æœƒæ¥æ”¶å…©å€‹å­—ä¸²åˆ‡ç‰‡ä¸¦å›å‚³ä¸€å€‹å­—ä¸²åˆ‡ç‰‡ï¼š\nfn main() { let string1 = String::from(\u0026#34;abcd\u0026#34;); let string2 = \u0026#34;xyz\u0026#34;; let result = longest(string1.as_str(), string2); println!(\u0026#34;The longest string is {}\u0026#34;, result); } è©²å‡½å¼æ¥æ”¶çš„æ˜¯å­—ä¸²åˆ‡ç‰‡çš„å¼•ç”¨ï¼Œè€Œä¸æ˜¯å­—ä¸²ï¼Œå› æ­¤æˆ‘å€‘ä¸å¸Œæœ› longest æ‹¿åˆ°åƒæ•¸çš„æ‰€æœ‰æ¬Šã€‚\nå­—ä¸²åˆ‡ç‰‡æœ¬ä¾†å°±æ˜¯å¼•ç”¨ï¼Œæ‰€ä»¥ä½œç‚ºåƒæ•¸æ™‚å¯ä»¥ä¸ç”¨åŠ å…¥ \u0026amp;\nå¯¦ä½œ longest å‡½å¼ï¼š\nfn longest(x: \u0026amp;str, y: \u0026amp;str) -\u0026gt; \u0026amp;str { if x.len() \u0026gt; y.len() { x } else { y } } ç·¨è­¯å¾Œæœƒå‡ºç¾ç”Ÿå‘½é€±æœŸçš„éŒ¯èª¤ï¼š\n$ cargo run Compiling chapter10 v0.1.0 (file:///projects/hello) error[E0106]: missing lifetime specifier --\u0026gt; src/main.rs:9:33 | 9 | fn longest(x: \u0026amp;str, y: \u0026amp;str) -\u0026gt; \u0026amp;str { | ---- ---- ^ expected named lifetime parameter | = help: this function\u0026#39;s return type contains a borrowed value, but the signature does not say whether it is borrowed from `x` or `y` help: consider introducing a named lifetime parameter | 9 | fn longest\u0026lt;\u0026#39;a\u0026gt;(x: \u0026amp;\u0026#39;a str, y: \u0026amp;\u0026#39;a str) -\u0026gt; \u0026amp;\u0026#39;a str { | ++++ ++ ++ ++ For more information about this error, try `rustc --explain E0106`. error: could not compile `chapter10` due to previous error éŒ¯èª¤è¨Šæ¯è¡¨ç¤ºå›å‚³å‹åˆ¥å¿…é ˆè¦æœ‰ä¸€å€‹æ³›å‹ç”Ÿå‘½é€±æœŸåƒæ•¸ï¼Œå› ç‚º Rust ä¸çŸ¥é“å›å‚³çš„å¼•ç”¨æ˜¯ x é‚„æ˜¯ yã€‚äº‹å¯¦ä¸Šæˆ‘å€‘ä¹Ÿä¸çŸ¥é“ï¼Œå› ç‚ºé€™è£¡æ˜¯äº¤ç”± if else å€å¡Šåˆ¤å®š x å’Œ y å“ªå€‹å­—ä¸²å¤§å°±å›å‚³å“ªå€‹ã€‚\nç•¶æˆ‘å€‘ä¸çŸ¥é“å“ªå€‹å­—ä¸²æœƒè¢«å›å‚³ï¼Œä¹Ÿä¸çŸ¥é“å‚³éé€²ä¾†çš„å¼•ç”¨å¯¦éš›çš„ç”Ÿå‘½é€±æœŸç‚ºä½•ï¼Œå°±æœƒé€ æˆä»¥ä¸Šçš„å•é¡Œã€‚ç‚ºäº†è§£æ±ºé€™å€‹éŒ¯èª¤ï¼Œå¿…é ˆè¦åŠ ä¸Šæ³›å‹ç”Ÿå‘½é€±æœŸåƒæ•¸ä¾†å®šç¾©å¼•ç”¨çš„é—œä¿‚ï¼Œè®“å€Ÿç”¨æª¢æŸ¥å™¨èƒ½å¤ åˆ†æã€‚\nç”Ÿå‘½é€±æœŸè©®é‡‹èªæ³• ç”Ÿå‘½é€±æœŸè©®é‡‹ ( Lifetime Annotation ) ä¸æœƒæ”¹è®Šå¼•ç”¨èƒ½å­˜æ´»å¤šä¹…ï¼Œåªæ˜¯æè¿°å¼•ç”¨ä¹‹é–“çš„ç›¸äº’é—œä¿‚ï¼Œä¸æœƒå½±éŸ¿å¼•ç”¨çš„ç”Ÿå‘½é€±æœŸã€‚é€™å°±åƒå‡½å¼ç°½åæŒ‡å®šäº†ä¸€å€‹æ³›å‹å‹åˆ¥åƒæ•¸ï¼Œè©²å‡½å¼å°±èƒ½æ¥å—ä»»æ„å‹åˆ¥ä¸€æ¨£ã€‚å‡½å¼å¯ä»¥æŒ‡å®šä¸€å€‹æ³›å‹ç”Ÿå‘½é€±æœŸåƒæ•¸ï¼Œè©²å‡½å¼å°±èƒ½æ¥å—ä»»ä½•ç”Ÿå‘½é€±æœŸã€‚\nç”Ÿå‘½é€±æœŸåƒæ•¸çš„åç¨±å¿…é ˆä»¥ ( ' ) ä½œç‚ºé–‹é ­ï¼Œé€šå¸¸æ˜¯å°å¯«ä¸”å¾ˆçŸ­ã€‚å¤§å¤šæ•¸äººéƒ½ä½¿ç”¨ 'a ä½œç‚ºç¬¬ä¸€å€‹ç”Ÿå‘½é€±æœŸè©®é‡‹ã€‚å°‡ç”Ÿå‘½é€±æœŸè©®é‡‹æ”¾åœ¨ \u0026amp; å¾Œé¢ï¼Œå†ä½¿ç”¨ç©ºæ ¼ä¾†è©®é‡‹å¼•ç”¨çš„å‹åˆ¥ï¼š\n\u0026amp;i32 // ä¸€å€‹å¼•ç”¨ \u0026amp;\u0026#39;a i32 // ä¸€å€‹æœ‰é¡¯å¼ç”Ÿå‘½é€±æœŸçš„å¼•ç”¨ \u0026amp;\u0026#39;a mut i32 // ä¸€å€‹æœ‰é¡¯å¼ç”Ÿå‘½é€±æœŸçš„å¯è®Šå¼•ç”¨ åœ¨å‡½å¼ç°½åä¸­çš„ç”Ÿå‘½é€±æœŸè©®é‡‹ åœ¨æ­¤æ®µç°½åæƒ³è¦è¡¨é”ï¼šç•¶æ‰€æœ‰å‚³éé€²ä¾†çš„åƒæ•¸éƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œé‚£å›å‚³çš„å¼•ç”¨æ‰æœƒæ˜¯æœ‰æ•ˆçš„ã€‚ä»¥ä¸‹æœƒå°‡ç”Ÿå‘½é€±æœŸå‘½åç‚º 'a ä¸¦åŠ é€²æ¯å€‹å¼•ç”¨ï¼š\nfn longest\u0026lt;\u0026#39;a\u0026gt;(x: \u0026amp;\u0026#39;a str, y: \u0026amp;\u0026#39;a str) -\u0026gt; \u0026amp;\u0026#39;a str { if x.len() \u0026gt; y.len() { x } else { y } } é€™æ¨£æ›´æ”¹å®Œ longest å°±èƒ½åŸ·è¡Œäº†ã€‚\næ­¤å‡½å¼ç°½åå‘Šè¨´ Rust æœ‰å€‹ç”Ÿå‘½é€±æœŸ 'aï¼Œå‡½å¼çš„å…©å€‹åƒæ•¸éƒ½æ˜¯å­—ä¸²åˆ‡ç‰‡ï¼Œä¸¦ä¸”éƒ½æœ‰ç”Ÿå‘½é€±æœŸ 'aï¼Œè€Œå›å‚³çš„å­—ä¸²åˆ‡ç‰‡ä¹Ÿæœƒå’Œç”Ÿå‘½é€±æœŸ 'a å­˜æ´»ä¸€æ¨£ä¹…ã€‚\næ³¨æ„ï¼šç•¶æ­¤å‡½å¼ç°½åæŒ‡å®šç”Ÿå‘½é€±æœŸåƒæ•¸æ™‚ï¼Œå°±ä¸èƒ½è®Šæ›´ä»»ä½•å‚³å…¥æˆ–å‚³å‡ºæ•¸å€¼çš„ç”Ÿå‘½é€±æœŸã€‚é€™å€‹ç›®çš„åªæ˜¯ç‚ºäº†å‘Šè¨´å€Ÿç”¨æª¢æŸ¥å™¨ä¸€ä»¶äº‹ï¼Œæ‹’çµ•ä»»ä½•æ²’æœ‰æœå¾ç´„æŸçš„æ•¸å€¼ã€‚longest å‡½å¼ä¸¦ä¸éœ€è¦çŸ¥é“ x èˆ‡ y æœƒå­˜æ´»å¤šä¹…ï¼Œå®ƒåªéœ€è¦çŸ¥é“æœ‰æŸå€‹ä½œç”¨åŸŸæœƒè¢« 'a æ‰€å–ä»£ã€‚\nç•¶ longest å‚³å…¥å¯¦éš›çš„å¼•ç”¨æ™‚ï¼Œæ³›å‹ç”Ÿå‘½é€±æœŸÂ 'aÂ å–å¾—çš„ç”Ÿå‘½é€±æœŸï¼Œæœƒç­‰æ–¼Â xÂ èˆ‡Â yÂ çš„ç”Ÿå‘½é€±æœŸä¸­è¼ƒçŸ­çš„ï¼Œè€Œå›å‚³å¼•ç”¨çš„ç”Ÿå‘½é€±æœŸä¹Ÿæœƒç›¸åŒã€‚\nå‚³å…¥ä¸åŒå¯¦éš›ç”Ÿå‘½é€±æœŸçš„å¼•ç”¨ï¼Œä¾†ä½¿ç”Ÿå‘½é€±æœŸè©®é‡‹èƒ½ç´„æŸÂ longestÂ å‡½å¼ï¼š\nfn main() { let string1 = String::from(\u0026#34;Long long string\u0026#34;); { let string2 = String::from(\u0026#34;xyz\u0026#34;); let result = longest(string1.as_str(), string2.as_str()); println!(\u0026#34;The longest string is {}\u0026#34;, result); } } string1 åœ¨å¤–éƒ¨ä½œç”¨åŸŸçµæŸå‰éƒ½æœ‰æ•ˆï¼›string2 åœ¨å…§éƒ¨ä½œç”¨åŸŸçµæŸå‰éƒ½æœ‰æ•ˆã€‚ result æœƒå–å¾—æŸå€‹å¼•ç”¨ç›´åˆ°å…§éƒ¨ä½œç”¨åŸŸçµæŸ ( ä¾ç…§åƒæ•¸æœ€çŸ­çš„ç”Ÿå‘½é€±æœŸ )ã€‚ æ¥ä¸‹ä¾†åšä¸€é»æ”¹è®Šï¼Œå¦‚æœå°‡ result ç§»å‹•åˆ°å¤–éƒ¨ä½œç”¨åŸŸåšå®£å‘Šï¼Œä¸¦ä¿ç•™ result çš„è³¦å€¼èˆ‡ string2 åœ¨å…§éƒ¨ä½œç”¨åŸŸã€‚ä¸¦å°‡ä½¿ç”¨ result çš„ println! ç§»å‹•åˆ°å¤–éƒ¨ä½œç”¨åŸŸï¼Œç·¨è­¯ä¸¦ä¸”è§€çœ‹çµæœï¼š\nfn main() { let string1 = String::from(\u0026#34;Long long string\u0026#34;); let result; { let string2 = String::from(\u0026#34;xyz\u0026#34;); result = longest(string1.as_str(), string2.as_str()); } println!(\u0026#34;The longest string is {}\u0026#34;, result); } ç·¨è­¯å¾Œæœƒçœ‹åˆ°ä»¥ä¸‹çš„éŒ¯èª¤è¨Šæ¯ï¼š\n$ cargo run Compiling chapter10 v0.1.0 (file:///projects/hello) error[E0597]: `string2` does not live long enough --\u0026gt; src/main.rs:6:44 | 6 | result = longest(string1.as_str(), string2.as_str()); | ^^^^^^^^^^^^^^^^ borrowed value does not live long enough 7 | } | - `string2` dropped here while still borrowed 8 | println!(\u0026#34;The longest string is {}\u0026#34;, result); | ------ borrow later used here For more information about this error, try `rustc --explain E0597`. error: could not compile `chapter10` due to previous error éŒ¯èª¤è¨Šæ¯è¡¨ç¤ºï¼Œéœ€è¦è®“ result èˆ‡ println! æœ‰æ•ˆçš„è©±ï¼Œstring2 å¿…é ˆè¦åœ¨å¤–éƒ¨ä½œç”¨åŸŸæœ‰æ•ˆï¼Œå› ç‚º Rust çŸ¥é“é€™å€‹å‡½å¼çš„åƒæ•¸èˆ‡å›å‚³å€¼ï¼Œéƒ½ä½¿ç”¨è‘—ç›¸åŒçš„ç”Ÿå‘½é€±æœŸ 'aã€‚\nç•¶ç„¶æˆ‘å€‘éƒ½çŸ¥é“ string1 å­—ä¸²é•·åº¦æ¯”è¼ƒé•·ï¼Œresult çš„çµæœæœƒæ˜¯ string1 çš„å¼•ç”¨ï¼Œè€Œä¸” string1 é‚„åœ¨ä½œç”¨åŸŸè£¡ï¼Œç…§ç†ä¾†èªªæ‡‰è©²æ˜¯ä¸æœƒæœ‰å•é¡Œæ‰å°ã€‚ä½†æ˜¯ç·¨è­¯å™¨ä¸æ‡‚ï¼Œæ‰€ä»¥æˆ‘å€‘æ‰æœƒå‘Šè¨´ Rust æ­¤å‡½å¼æ‰€å›å‚³å¼•ç”¨çš„ç”Ÿå‘½é€±æœŸï¼Œæœƒç­‰æ–¼è¼ƒçŸ­çš„ç”Ÿå‘½é€±æœŸã€‚æ‰€ä»¥ç·¨è­¯å™¨æ‰æœƒå ±éŒ¯ï¼Œå› ç‚ºå›å‚³å¯èƒ½æœƒåŒ…å«ç„¡æ•ˆçš„å¼•ç”¨ã€‚\næ·±å…¥ç†è§£ç”Ÿå‘½é€±æœŸ å†ä¾†åšä¸€é»æ”¹è®Šï¼Œå¦‚æœç¾åœ¨ longest å›å‚³çš„æ¢ä»¶æ˜¯æ°¸é å›å‚³ç¬¬ä¸€å€‹å­—ä¸²åˆ‡ç‰‡ï¼Œé‚£åƒæ•¸ y å°±å¯ä»¥ä¸éœ€è¦æŒ‡å®šç”Ÿå‘½é€±æœŸï¼š\nfn longest\u0026lt;\u0026#39;a\u0026gt;(x: \u0026amp;\u0026#39;a str, y: \u0026amp;str) -\u0026gt; \u0026amp;\u0026#39;a str { x } é€™æ˜¯å› ç‚º x èˆ‡å›å‚³å‹åˆ¥çš„ç”Ÿå‘½é€±æœŸéƒ½æ˜¯ 'aï¼Œä½†ç¾åœ¨æ°¸é åªå›å‚³ xï¼Œy æœ‰æ²’æœ‰ç”Ÿå‘½é€±æœŸæ ¹æœ¬æ²’æœ‰ä»»ä½•å·®åˆ¥ã€‚é€™ä¹Ÿè¡¨ç¤ºç•¶å‡½å¼å›å‚³å¼•ç”¨æ™‚ï¼Œå›å‚³å‹åˆ¥çš„ç”Ÿå‘½é€±æœŸå¿…é ˆç¬¦åˆå…¶ä¸­ä¸€å€‹åƒæ•¸çš„ç”Ÿå‘½é€±æœŸã€‚æ‰€ä»¥ä¸‹é¢çš„ç¨‹å¼ç¢¼æ˜¯ä¸æœƒç·¨è­¯æˆåŠŸçš„ï¼š\nfn longest\u0026lt;\u0026#39;a\u0026gt;(x: \u0026amp;str, y: \u0026amp;str) -\u0026gt; \u0026amp;\u0026#39;a str { let result = String::from(\u0026#34;Long long string\u0026#34;); result.as_str() } å› ç‚ºå›å‚³å€¼çš„ç”Ÿå‘½é€±æœŸèˆ‡åƒæ•¸çš„ç”Ÿå‘½é€±æœŸç„¡é—œã€‚éŒ¯èª¤è¨Šæ¯ç‚ºï¼š\n$ cargo run Compiling chapter10 v0.1.0 (file:///projects/hello) error[E0515]: cannot return reference to local variable `result` --\u0026gt; src/main.rs:11:5 | 11 | result.as_str() | ^^^^^^^^^^^^^^^ returns a reference to data owned by the current function For more information about this error, try `rustc --explain E0515`. error: could not compile `chapter10` due to previous error æ­¤æ™‚æˆ‘å€‘å˜—è©¦å¾å‡½å¼ä¸­å›å‚³ result å¼•ç”¨ï¼Œ ä½† result å·²ç¶“é›¢é–‹ä½œç”¨åŸŸï¼Œå·²ç¶“æ˜¯è¿·é€”å¼•ç”¨äº†ï¼ŒRust æ˜¯ä¸æœƒå…è¨±ä½¿ç”¨è¿·é€”å¼•ç”¨ã€‚è§£æ±ºé€™å€‹å•é¡Œæœ€å¥½çš„æ–¹æ³•å°±æ˜¯å›å‚³æœ‰æ‰€æœ‰æ¬Šçš„å‹åˆ¥ï¼Œè€Œä¸æ˜¯å¼•ç”¨ã€‚\nç”±ä¸Šå¯çŸ¥ï¼Œç”Ÿå‘½é€±æœŸèªæ³•æ˜¯ç”¨ä¾†é€£æ¥å‡½å¼ä¸­ä¸åŒåƒæ•¸èˆ‡å›å‚³å€¼çš„ç”Ÿå‘½é€±æœŸã€‚åªè¦èƒ½é€£çµï¼ŒRust å°±èƒ½æœ‰è¶³å¤ çš„è³‡è¨Šé˜²æ­¢ç”¢ç”Ÿè¿·é€”æŒ‡æ¨™æˆ–é•åè¨˜æ†¶é«”å®‰å…¨çš„æ“ä½œã€‚\nåœ¨çµæ§‹é«”ä¸­ä½¿ç”¨ç”Ÿå‘½é€±æœŸè©®é‡‹ çµæ§‹é«”çš„æ‰€æœ‰å®šç¾©éƒ½æŒæœ‰å‹åˆ¥çš„æ‰€æœ‰æ¬Šï¼Œç„¶è€Œçµæ§‹é«”ä¹Ÿå¯ä»¥æŒæœ‰å¼•ç”¨ã€‚åœ¨é€™è£¡ä½¿ç”¨ ImportantExcerpt ä¾†ç•¶ä½œä¾‹å­ï¼š\nstruct ImportantExcerpt\u0026lt;\u0026#39;a\u0026gt; { part: \u0026amp;\u0026#39;a str, } fn main() { let novel = String::from(\u0026#34;Call me Ishmael. Some years ago...\u0026#34;); let first_sentence = novel.split(\u0026#39;.\u0026#39;).next().expect(\u0026#34;Can not find \u0026#39;.\u0026#39;\u0026#34;); let i = ImportantExcerpt { part: first_sentence, }; } å¦‚åŒæ³›å‹è³‡æ–™å‹åˆ¥ï¼Œåœ¨çµæ§‹é«”åç¨±å¾ŒåŠ ä¸Šæ³›å‹ç”Ÿå‘½é€±æœŸåƒæ•¸ ( \u0026lt;'a\u0026gt; ) åœ¨ main è£¡ç”¢ç”Ÿä¸€å€‹çµæ§‹é«” ImportantExcerpt å¯¦ä¾‹ï¼Œè®Šæ•¸ novel æ“æœ‰ String è³‡æ–™ï¼Œè€Œ novel åœ¨ ImportantExcerpt å¯¦ä¾‹ä¹‹å‰å»ºç«‹çš„ï¼Œé€™è¡¨ç¤º novel ä¸æœƒæ¯” ImportantExcerpt æ—©é›¢é–‹ä½œç”¨åŸŸï¼Œæ‰€ä»¥ ImportantExcerpt è£¡çš„å¼•ç”¨å°±èƒ½æˆç«‹ çœç•¥ç”Ÿå‘½é€±æœŸ ç¾åœ¨æˆ‘å€‘å·²ç¶“çŸ¥é“æ¯å€‹å¼•ç”¨éƒ½æœ‰ç”Ÿå‘½é€±æœŸï¼Œé‚£æ˜¯å¦æ¯ä¸€æ¬¡éƒ½è¦å¯«å‡ºä¾†å‘¢ï¼Ÿä»¥ä¸‹çš„å‡½å¼æ˜¯æ²’æœ‰è©®é‡‹ç”Ÿå‘½é€±æœŸé‚„å¯ä»¥ç·¨è­¯æˆåŠŸçš„ï¼š\nfn first_word(s: \u0026amp;str) -\u0026gt; \u0026amp;str { let bytes = s.as_bytes(); for (i, \u0026amp;item) in bytes.iter().enumerate() { if item == b\u0026#39; \u0026#39; { return \u0026amp;s[0..i]; } } \u0026amp;s[..] } ä»¥ä¸Šçš„ç¨‹å¼æ›¾ç¶“å‡ºç¾åœ¨Rust: æ‰€æœ‰æ¬Š ( Ownership )ï¼Œé‚£ç‚ºä»€éº¼å®ƒå¯ä»¥ä¸ç”¨å¯«å‡ºç”Ÿå‘½é€±æœŸï¼Ÿ\nå¦‚æœæ˜¯åœ¨æ—©æœŸç‰ˆæœ¬ Rust ( 1.0 ä¹‹å‰ )ï¼Œä¸Šé¢çš„ç¨‹å¼ç¢¼å°±çœŸçš„ç„¡æ³•ç·¨è­¯äº†ï¼Œå› ç‚ºé‚£å€‹æ™‚å€™æ¯å€‹å¼•ç”¨éƒ½å¿…é ˆè¦é¡¯ç¤ºç”Ÿå‘½é€±æœŸï¼Œåœ¨ç•¶æ™‚æ­¤å‡½å¼å°±æœƒæ˜¯ï¼š\nfn first_word\u0026lt;\u0026#39;a\u0026gt;(s: \u0026amp;\u0026#39;a str) -\u0026gt; \u0026amp;\u0026#39;a str{ åœ¨å¯«äº†å¤§é‡ Rust ç¨‹å¼ç¢¼å¾Œï¼ŒRust åœ˜éšŠç™¼ç¾é–‹ç™¼è€…æœƒåœ¨ç‰¹å®šæƒ…æ³åè¦†è¼¸å…¥åŒæ¨£çš„ç”Ÿå‘½é€±æœŸè©®é‡‹ï¼Œè€Œé€™äº›æƒ…æ³éƒ½æ˜¯å¯é æœŸçš„ï¼Œä¸¦ä¸”éµå¾ªä¸€äº›æ˜ç¢ºçš„æ¨¡å¼ã€‚æ‰€ä»¥ Rust åœ˜éšŠå°‡é€™äº›æ¨¡å¼åŠ å…¥ç·¨è­¯å™¨çš„ç¨‹å¼ç¢¼ä¸­ï¼Œè®“å€Ÿç”¨æª¢æŸ¥å™¨å¯ä»¥ä¾æ“šé€™äº›è¦å‰‡è‡ªè¡Œæ¨å°ç”Ÿå‘½ç”Ÿå‘½é€±æœŸã€‚\né€™å€‹è®“ Rust åˆ†æçš„æ¨¡å¼ç¨±ç‚ºç”Ÿå‘½é€±æœŸçœç•¥è¦å‰‡ ( lifetime elision rules ) ï¼Œç•¶ä½ çš„ç¨‹å¼ç¢¼ç¬¦åˆè©²æƒ…å½¢æ™‚ï¼Œå°±å¯ä»¥ä¸ç”¨å¯«å‡ºç”Ÿå‘½é€±æœŸã€‚\nç”Ÿå‘½é€±æœŸçœç•¥è¦å‰‡ä¸¦ä¸æ˜¯å®Œç¾çš„ï¼Œé‚„æ˜¯æœ‰ä¸€äº›æ¨¡ç¨œå…©å¯çš„ç”Ÿå‘½é€±æœŸï¼Œç•¶ç·¨è­¯å™¨ç„¡æ³•çŒœå‡ºç”Ÿå‘½é€±æœŸæ™‚ï¼Œå°±æœƒå›å‚³éŒ¯èª¤çµ¦ä½ ï¼Œèªªæ˜ä½ å¿…é ˆè‡ªå·±æŒ‡å®šç”Ÿå‘½é€±æœŸ\nç”Ÿå‘½é€±æœŸçœç•¥è¦å‰‡ ( Lifetime elision rules ) é¦–å…ˆè¦å…ˆçŸ¥é“ç”Ÿå‘½é€±æœŸæœ‰å…©ç¨®ï¼š\nåœ¨å‡½å¼æˆ–æ–¹æ³•åƒæ•¸ä¸Šçš„ç”Ÿå‘½é€±æœŸç¨±ç‚ºè¼¸å…¥ç”Ÿå‘½é€±æœŸ ( input lifetimes ) åœ¨å›å‚³å€¼çš„ç”Ÿå‘½é€±æœŸå‰‡ç¨±ç‚ºè¼¸å‡ºç”Ÿå‘½é€±æœŸ ( output lifetimes ) ç·¨è­¯å™¨æœƒæ ¹æ“šä¸‰é …è¦å‰‡ä¾†æ¨å°æ²’æœ‰é¡¯å¼ç”Ÿå‘½é€±æœŸçš„å‹åˆ¥ã€‚ç¬¬ä¸€å€‹è¦å‰‡é©ç”¨æ–¼è¼¸å…¥ç”Ÿå‘½é€±æœŸï¼Œè€Œç¬¬äºŒèˆ‡ç¬¬ä¸‰å€‹è¦å‰‡é©ç”¨æ–¼è¼¸å‡ºç”Ÿå‘½é€±æœŸã€‚å¦‚æœä¸‰å€‹è¦å‰‡è·‘å®Œï¼Œé‚„æ˜¯æ²’æœ‰æ¨æ–·å‡ºç”Ÿå‘½é€±æœŸï¼Œç·¨è­¯å™¨å°±æœƒåœæ­¢ä¸¦å›å‚³éŒ¯èª¤ã€‚\nç¬¬ä¸€å€‹è¦å‰‡ï¼šç·¨è­¯å™¨æœƒçµ¦äºˆæ¯å€‹å¼•ç”¨åƒæ•¸ä¸€å€‹ç”Ÿå‘½é€±æœŸåƒæ•¸ï¼š\nfn foo\u0026lt;\u0026#39;a\u0026gt;(x: \u0026amp;\u0026#39;a i32) // 1å€‹åƒæ•¸ï¼›1å€‹ç”Ÿå‘½é€±æœŸ fn foo\u0026lt;\u0026#39;a, \u0026#39;b\u0026gt;(x: \u0026amp;\u0026#39;a i32, y: \u0026amp;\u0026#39;b i32) // 2å€‹åƒæ•¸ï¼›2å€‹ç”Ÿå‘½é€±æœŸ ç¬¬äºŒå€‹è¦å‰‡ï¼šå¦‚æœåªæœ‰ä¸€å€‹è¼¸å…¥ç”Ÿå‘½é€±æœŸåƒæ•¸ï¼Œæ‰€æœ‰è¼¸å‡ºç”Ÿå‘½é€±æœŸåƒæ•¸å°±ç­‰æ–¼æ­¤åƒæ•¸ï¼š\nfn foo\u0026lt;\u0026#39;a\u0026gt;(x: \u0026amp;\u0026#39;a i32) -\u0026gt; \u0026amp;\u0026#39;a i32 ç¬¬ä¸‰å€‹è¦å‰‡ï¼šå¦‚æœè¼¸å…¥çš„ç”Ÿå‘½é€±æœŸåƒæ•¸è£¡æœ‰Â \u0026amp;selfÂ æˆ–Â \u0026amp;mut selfï¼Œå¾ˆæ˜é¡¯é€™å°±æ˜¯æ–¹æ³• ( methods )ï¼Œé‚£ self çš„ç”Ÿå‘½é€±æœŸåƒæ•¸å°±ç­‰åŒæ–¼æ‰€æœ‰è¼¸å‡ºç”Ÿå‘½é€±æœŸåƒæ•¸ã€‚\nç¾åœ¨å°±å¯ä»¥æ ¹æ“šä¸Šé¢çš„ä¸‰å€‹è¦å‰‡ï¼Œä¾†è§£é‡‹ å‡½å¼ä¸­çš„æ³›å‹ç”Ÿå‘½é€±æœŸ è£¡çš„ longest å‡½å¼éŒ¯èª¤çš„åŸå› äº†ï¼š\nfn longest(x: \u0026amp;str, y: \u0026amp;str) -\u0026gt; \u0026amp;str { å…ˆå¥—ç”¨ç¬¬ä¸€å€‹è¦å‰‡ï¼Œæ¯å€‹åƒæ•¸éƒ½æœ‰è‡ªå·±çš„ç”Ÿå‘½é€±æœŸã€‚è€Œé€™æ¬¡æœ‰å…©å€‹åƒæ•¸ï¼š\nfn longest\u0026lt;\u0026#39;a, \u0026#39;b\u0026gt;(x: \u0026amp;\u0026#39;a str, y: \u0026amp;\u0026#39;b str) -\u0026gt; \u0026amp;str { ç¬¬äºŒå€‹è¦å‰‡å°±ä¸é©ç”¨äº†ï¼Œå› ç‚ºé€™è£¡ä¸åªæœ‰ä¸€å€‹ç”Ÿå‘½é€±æœŸåƒæ•¸ã€‚ç¬¬ä¸‰å€‹è¦å‰‡ä¹Ÿä¸é©ç”¨ï¼Œlongest æ˜¯å‡½å¼è€Œä¸æ˜¯æ–¹æ³•ã€‚ç¶“éä¸‰å€‹è¦å‰‡å¾Œï¼Œç·¨è­¯å™¨é‚„æ˜¯ç„¡æ³•æ¨æ–·å‡ºå‹åˆ¥çš„ç”Ÿå‘½é€±æœŸï¼Œé€™ä¹Ÿå°±æ˜¯ç¨‹å¼æœƒå‡ºç¾éŒ¯èª¤çš„åŸå› ã€‚\nå±¬æ–¼æ–¹æ³•å®šç¾©ä¸­çš„ç”Ÿå‘½é€±æœŸè©®é‡‹ é‚£ç‚ºä»€éº¼ç¬¬ä¸‰å€‹è¦å‰‡åªé©ç”¨æ–¼æ–¹æ³•å‘¢ï¼Ÿ\nçµæ§‹é«”æ¬„ä½çš„ç”Ÿå‘½é€±æœŸæ°¸é éœ€è¦å®£å‘Šåœ¨Â implÂ é—œéµå­—å¾Œæ–¹ä»¥åŠçµæ§‹é«”åç¨±å¾Œæ–¹ï¼Œå› ç‚ºé€™äº›ç”Ÿå‘½é€±æœŸæ˜¯çµæ§‹é«”å‹åˆ¥çš„ä¸€éƒ¨åˆ†ã€‚\nåœ¨ impl å€å¡Šä¸­ï¼Œæ–¹æ³•æ‰€ç°½åçš„å¼•ç”¨å¾ˆå¯èƒ½æœƒèˆ‡çµæ§‹é«”æ¬„ä½çš„å¼•ç”¨ç”Ÿå‘½é€±æœŸç¶å®šï¼Œç•¶ç„¶å®ƒå€‘ä¹Ÿå¯èƒ½æ˜¯ç¨ç«‹çš„ã€‚\né€™è£¡ä½¿ç”¨ ImportantExcerpt ä¾†ä½œç¯„ä¾‹ï¼Œé¦–å…ˆä½¿ç”¨ä¸€å€‹æ–¹æ³•åç‚º levelï¼Œå…¶åƒæ•¸å°±åªæœ‰ \u0026amp;self çš„å¼•ç”¨ï¼Œè€Œå›å‚³å€¼æ˜¯ i32 ä¸¦ä¸æ˜¯å¼•ç”¨ï¼š\nstruct ImportantExcerpt\u0026lt;\u0026#39;a\u0026gt; { part: \u0026amp;\u0026#39;a str, } impl\u0026lt;\u0026#39;a\u0026gt; ImportantExcerpt\u0026lt;\u0026#39;a\u0026gt; { fn level(\u0026amp;self) -\u0026gt; i32 { 3 } } ä»¥ä¸‹ç‚ºç¬¬ä¸‰å€‹ç”Ÿå‘½é€±æœŸçœç•¥è¦å‰‡é©ç”¨çš„ç¯„ä¾‹ï¼š\nimpl\u0026lt;\u0026#39;a\u0026gt; ImportantExcerpt\u0026lt;\u0026#39;a\u0026gt; { fn announce_and_return_part(\u0026amp;self, announcement: \u0026amp;str) -\u0026gt; \u0026amp;str { println!(\u0026#34;Noticeï¼š{}\u0026#34;, announcement); self.part } } é¦–å…ˆï¼Œæ ¹æ“šç¬¬ä¸€å€‹ç”Ÿå‘½é€±æœŸçœç•¥è¦å‰‡ï¼Œçµ¦äºˆ \u0026amp;self èˆ‡ announcement å„è‡ªçš„ç”Ÿå‘½é€±æœŸã€‚ç„¶å¾Œå› ç‚ºå…¶ä¸­ä¸€å€‹åƒæ•¸æ˜¯ \u0026amp;selfï¼Œé©ç”¨æ–¼ç¬¬ä¸‰å€‹ç”Ÿå‘½é€±æœŸçœç•¥è¦å‰‡ï¼Œæ‰€ä»¥è©²å›å‚³å‹åˆ¥æœƒå–å¾—Â \u0026amp;selfÂ çš„ç”Ÿå‘½é€±æœŸã€‚\néœæ…‹ç”Ÿå‘½é€±æœŸ æœ‰å€‹ç‰¹æ®Šçš„ç”Ÿå‘½é€±æœŸÂ 'staticï¼Œé€™è¡¨ç¤ºè©²å¼•ç”¨å¯ä»¥å­˜æ´»åœ¨æ•´å€‹ç¨‹å¼æœŸé–“ã€‚å­—ä¸²æœ‰ 'static ç”Ÿå‘½é€±æœŸï¼š\nlet s: \u0026amp;\u0026#39;static str = \u0026#34;I have static lifetime\u0026#34;; æ­¤å­—ä¸²çš„æ–‡å­—æœƒç›´æ¥å„²å­˜åœ¨ç¨‹å¼çš„åŸ·è¡Œæª”ä¸­ï¼Œæ°¸é æœ‰æ•ˆã€‚\næ³›å‹å‹åˆ¥åƒæ•¸ã€ç‰¹å¾µç•Œé™èˆ‡ç”Ÿå‘½é€±æœŸçš„çµ„åˆ é€™é‚Šä½¿ç”¨ä¸€å€‹å‡½å¼ä¾†çµ„åˆæ³›å‹å‹åˆ¥åƒæ•¸ã€ç‰¹å¾µç•Œé™èˆ‡ç”Ÿå‘½é€±æœŸï¼š\nuse std::fmt::Display; fn longest_with_an_announcement\u0026lt;\u0026#39;a, T\u0026gt;( x: \u0026amp;\u0026#39;a str, y: \u0026amp;\u0026#39;a str, ann: T, ) -\u0026gt; \u0026amp;\u0026#39;a str where T: Display, { println!(\u0026#34;Announcementï¼{}\u0026#34;, ann); if x.len() \u0026gt; y.len() { x } else { y } } é€™å€‹å‡½å¼æœƒæ¯”è¼ƒå…©å€‹å­—ä¸²åˆ‡ç‰‡ï¼Œä¸¦å›å‚³æ¯”è¼ƒé•·çš„é‚£ä¸€å€‹ ann ä½¿ç”¨æ³›å‹å‹åˆ¥ Tï¼Œå¾Œé¢çš„ where å¯ä»¥æŒ‡å®š T æœ‰ Display ç‰¹å¾µã€‚é€™è¡¨ç¤ºé€™å€‹ ann åƒæ•¸å¯ä»¥ä½¿ç”¨ {} æ–¹å¼å°å‡ºä¾† ç”Ÿå‘½é€±æœŸä¹Ÿæ˜¯ä¸€ç¨®æ³›å‹ï¼Œæ‰€ä»¥ç”Ÿå‘½é€±æœŸåƒæ•¸ 'a èˆ‡ æ³›å‹å‹åˆ¥åƒæ•¸ T éƒ½æœƒä¸€èµ·å¯«åœ¨ \u0026lt;\u0026gt; è£¡ çµè«– ç”Ÿå‘½é€±æœŸèˆ‡æ‰€æœ‰æ¬Šéƒ½æ˜¯ Rust ç®¡ç†è¨˜æ†¶é«”å¾ˆé‡è¦çš„æ©Ÿåˆ¶ï¼Œè€Œé€éå€Ÿç”¨æª¢æŸ¥å™¨å°‡å¼•ç”¨çš„ä½œç”¨åŸŸåšæ¯”è¼ƒï¼Œå¯ä»¥è®“ç„¡æ•ˆçš„å¼•ç”¨åœ¨ç·¨è­¯æœŸé–“å°±è¢«ç™¼ç¾ã€‚åœ¨ä¸‰å€‹ç”Ÿå‘½é€±æœŸçœç•¥è¦å‰‡ä¸‹ï¼ŒRust å¤§å¤šçš„ç”Ÿå‘½é€±æœŸéƒ½å¯ä»¥è‡ªå‹•è¢«æ¨å°å‡ºä¾†ï¼Œé€™å°±è·Ÿé€™å°±è·Ÿå‹åˆ¥ä¸€æ¨£ã€‚\nä»¥ä¸Šé€™äº›åˆ†æéƒ½æ˜¯åœ¨ç·¨è­¯æœŸé–“é€²è¡Œçš„ï¼Œå®Œå…¨ä¸æœƒå½±éŸ¿åŸ·è¡Œçš„æ•ˆèƒ½ğŸ˜†ï¼\n","permalink":"https://et860525.github.io/posts/rust-lifetimes/","summary":"\u003cp\u003e\u003cstrong\u003eç”Ÿå‘½é€±æœŸ ( lifetimes )\u003c/strong\u003e æœƒç¢ºä¿æˆ‘å€‘åœ¨éœ€è¦å¼•ç”¨çš„æ™‚å€™ï¼Œå®ƒå€‘éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨ Rust ä¸­ï¼Œæ¯å€‹å¼•ç”¨éƒ½æ˜¯æœ‰ç”Ÿå‘½é€±æœŸçš„ï¼Œç°¡å–®ä¾†èªªå°±æ˜¯å®ƒçš„æœ‰æ•ˆç¯„åœã€‚åœ¨å¤§å¤šæƒ…æ³ä¸‹ï¼Œç”Ÿå‘½é€±æœŸéƒ½æ˜¯éš±è—ä¸”å¯ä»¥æ¨å°å‡ºä¾†çš„ï¼Œå¦‚åŒå‹åˆ¥ä¸€æ¨£ä¹Ÿéƒ½æ˜¯å¯ä»¥æ¨å°å‡ºä¾†çš„ã€‚ç•¶å‹åˆ¥æœ‰å¾ˆå¤šç¨®å¯èƒ½çš„æƒ…æ³ä¸‹ï¼Œå°±è¦\u003cstrong\u003eè©®é‡‹å‹åˆ¥\u003c/strong\u003eï¼ŒåŒæ¨£åœ¨ç”Ÿå‘½é€±æœŸä¸‹ï¼Œå¼•ç”¨ä»¥ä¸åŒæ–¹å¼é—œè¯çš„è©±ï¼Œå°±è¦\u003cstrong\u003eè©®é‡‹ç”Ÿå‘½é€±æœŸ\u003c/strong\u003eã€‚\u003c/p\u003e","title":"Rust: ç”Ÿå‘½é€±æœŸ( Lifetimes )"},{"content":"é€™ç¯‡æ–‡ç« æœƒç´€éŒ„å¦‚ä½•åœ¨ Express å°ˆæ¡ˆè£¡è¨­å®š TypeScriptã€‚\nå…ˆæ±ºæ¢ä»¶ï¼š\nå®‰è£ Node.js ( LTS ) åœ¨ä½ çš„é–‹ç™¼ç’°å¢ƒä¸Š åŸºæœ¬çš„ Node.js ã€ Express èˆ‡ TypeScript çŸ¥è­˜ å°ˆæ¡ˆåˆå§‹åŒ– å»ºç«‹ä¸€å€‹ç©ºçš„è³‡æ–™å¤¾ï¼Œä¸¦åˆå§‹åŒ–Â package.jsonï¼š\nmkdir express-typescript cd express-typescript npm init -y ä¸‹è¼‰ Express èˆ‡é–‹ç™¼ä¼ºæœå™¨çš„ç›¸é—œå¥—ä»¶ï¼š\nnpm i express dotenv dotenvÂ æ˜¯ä¸€å€‹ç®¡ç†ç’°å¢ƒè®Šæ•¸çš„å¥—ä»¶ï¼Œå¯ä»¥æ ¹æ“šç’°å¢ƒçš„ä¸åŒè¨­å®šä¸åŒçš„é…ç½® å®‰è£ TypeScript èˆ‡Â @typesÂ å®£å‘Šå¥—ä»¶ï¼š\nnpm i -D typescript @types/express @types/node @types/\u0026lt;package-name\u0026gt;ï¼šåªè¦è©²å¥—ä»¶æœ‰æ”¯æ´ TypeScriptï¼Œä½ å°±èƒ½åœ¨ç›´æ¥ä½¿ç”¨é€™å€‹æ–¹å¼ï¼Œä¸‹è¼‰é å…ˆå®šç¾©å¥½çš„å®£å‘Šæª”æ¡ˆ -D æ˜¯ --save-devï¼šè¡¨ç¤ºå¥—ä»¶åªæœƒå­˜åœ¨æ–¼ devDependencies éƒ½å®Œæˆå¾Œå¯ä»¥æª¢æŸ¥ package.json æª”æ¡ˆ (æ²’æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œå¥—ä»¶çš„ç‰ˆæœ¬ä»¥è‡ªå·±çš„ç‚ºæº–)ï¼š\n{ \u0026#34;name\u0026#34;: \u0026#34;express-typescript\u0026#34;, \u0026#34;version\u0026#34;: \u0026#34;1.0.0\u0026#34;, \u0026#34;description\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;main\u0026#34;: \u0026#34;index.js\u0026#34;, \u0026#34;scripts\u0026#34;: { \u0026#34;test\u0026#34;: \u0026#34;echo \\\u0026#34;Error: no test specified\\\u0026#34; \u0026amp;\u0026amp; exit 1\u0026#34; }, \u0026#34;keywords\u0026#34;: [], \u0026#34;author\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;license\u0026#34;: \u0026#34;ISC\u0026#34;, \u0026#34;dependencies\u0026#34;: { \u0026#34;dotenv\u0026#34;: \u0026#34;^16.0.3\u0026#34;, \u0026#34;express\u0026#34;: \u0026#34;^4.18.2\u0026#34; }, \u0026#34;devDependencies\u0026#34;: { \u0026#34;@types/express\u0026#34;: \u0026#34;^4.17.17\u0026#34;, \u0026#34;@types/node\u0026#34;: \u0026#34;^18.11.18\u0026#34;, \u0026#34;typescript\u0026#34;: \u0026#34;^4.9.5\u0026#34; } } ç”¢ç”Ÿ TypeScript çš„é…ç½®æ–‡ä»¶ ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ä¾†ç”¢ç”ŸÂ tsconfig.jsonï¼š\nnpx tsc --init åœ¨è¼¸å‡ºå¯ä»¥çœ‹åˆ°ç”¢ç”Ÿçš„æª”æ¡ˆèˆ‡é è¨­çš„è¨­å®šï¼š\nCreated a new tsconfig.json with: target: es2016 module: commonjs strict: true esModuleInterop: true skipLibCheck: true forceConsistentCasingInFileNames: true You can learn more at https://aka.ms/tsconfig é€™è£¡ä¹Ÿå¯ä»¥æ‰“é–‹ tsconfig.json ä¾†ä¿®æ”¹è‡ªå·±éœ€è¦çš„è¨­å®šã€‚ä»¥ä¸‹æ˜¯æˆ‘çš„è¨­å®šï¼š\n{ \u0026#34;compilerOptions\u0026#34;: { \u0026#34;target\u0026#34;: \u0026#34;es2017\u0026#34;, \u0026#34;module\u0026#34;: \u0026#34;commonjs\u0026#34;, \u0026#34;esModuleInterop\u0026#34;: true, \u0026#34;skipLibCheck\u0026#34;: true, \u0026#34;forceConsistentCasingInFileNames\u0026#34;: true, \u0026#34;strict\u0026#34;: true, \u0026#34;rootDir\u0026#34;: \u0026#34;./src\u0026#34;, \u0026#34;outDir\u0026#34;: \u0026#34;./dist\u0026#34;, }, \u0026#34;include\u0026#34;: [\u0026#34;src/**/*.ts\u0026#34;], \u0026#34;exclude\u0026#34;: [\u0026#34;node_modules\u0026#34;, \u0026#34;dist\u0026#34;] } é è¨­çš„è¨­å®šï¼š\ntargetï¼šæŒ‡å®šç·¨è­¯å™¨æ‰€ç”¢ç”Ÿçš„ JavaScript version moduleï¼šç·¨è­¯ JavaScript ç¨‹å¼ç¢¼ä½¿ç”¨çš„ modules managerã€‚commonjsÂ ç‚º Node.js çš„æ¨™æº– strictï¼šåš´æ ¼é¡å‹æª¢æŸ¥é¸é … esModuleInteropï¼šè®“æˆ‘å€‘èƒ½å°‡ ES6 modules ç·¨è­¯æˆ commonJS modules skipLibCheckï¼šå¦‚æœç‚ºÂ trueï¼Œå‰‡æœƒè·³éæª¢æŸ¥åŸºç¤å®£å‘Šæª”æ¡ˆ ( declaration files ) forceConsistentCasingInFileNamesï¼šå¦‚æœç‚ºÂ trueï¼Œå•Ÿç”¨å€åˆ†å¤§å°å¯«å‘½åæ–‡ä»¶ æ–°å¢çš„è¨­å®šï¼š\nrootDirï¼šæ¬²ç·¨è­¯çš„è·¯å¾‘ï¼ŒæŠŠè©²è³‡æ–™å¤¾è£¡é¢çš„ .ts éƒ½ç·¨è­¯æˆ JavaScript outDirï¼šç·¨è­¯å¾Œè¼¸å‡ºæª”æ¡ˆçš„åœ°æ–¹ includeï¼šç´å…¥ç·¨è­¯çš„ç¯„åœ excludeï¼šä¸ç´å…¥ç·¨è­¯çš„ç¯„åœ å»ºç«‹ Express app é¦–å…ˆï¼Œå…ˆåœ¨æ ¹ç›®éŒ„ ( root ) ä¸‹å»ºç«‹ä¸€å€‹æª”æ¡ˆ .envï¼Œé€™å€‹æª”æ¡ˆå­˜æ”¾çš„æ˜¯æ•æ„Ÿè³‡æ–™ä¾› dotenv ä¾†è®€å–çš„ã€‚è©²æª”æ¡ˆç›®å‰æœƒæœ‰ä»¥ä¸‹è¨­å®šï¼š\nPORT=3000 ä¹‹å¾Œå†æ–°å¢æª”æ¡ˆ src/app.ts ä¸¦è¼¸å…¥ä¸‹é¢çš„ç¨‹å¼ç¢¼ä¾†å»ºç«‹ä¸€å€‹ä¼ºæœå™¨ï¼š\nimport express, { Express, Request, Response } from \u0026#39;express\u0026#39;; import dotenv from \u0026#39;dotenv\u0026#39;; dotenv.config(); const app: Express = express(); const port = process.env.PORT; app.get(\u0026#39;/\u0026#39;, (req: Request, res: Response) =\u0026gt; { res.send(\u0026#39;Express + TypeScript Server\u0026#39;); }); app.listen(port, () =\u0026gt; { console.log( `[server]: Server is running at http://localhost:${port}` ); }); é€é dotenv å°±å¯ä»¥è®“ port ç²å–åœ¨ .env æª”æ¡ˆè£¡çš„è¨­å®š è¦é‹è¡Œä¼ºæœå™¨å‰å¿…é ˆè¦å…ˆçŸ¥é“ä¸€ä»¶äº‹æƒ…ï¼Œç€è¦½å™¨æ˜¯ç„¡æ³•ç†è§£ TypeScript ç¨‹å¼ç¢¼çš„ï¼Œå¿…é ˆè¦å…ˆå°‡æª”æ¡ˆè½‰æˆ JavaScript ç€è¦½å™¨æ‰èƒ½ä½¿ç”¨ã€‚é‚£è¦å¦‚ä½•æ‰èƒ½è®“ TypeScript çŸ¥é“å“ªäº›æª”æ¡ˆæ˜¯éœ€è¦ç·¨è­¯çš„å‘¢ï¼Ÿé€™æ™‚å€™è¨­å®š tsconfig.json å°±å¾ˆé‡è¦äº† (è«‹åƒè€ƒä¸Šæ–¹ tsconfig.json æ‰€æ–°å¢çš„è¨­å®š)ã€‚\nå¦‚æœå·²ç¶“æœ‰è¨­å®šæŒ‡å®šçš„è³‡æ–™å¤¾ï¼Œå°±å¯ä»¥ä½¿ç”¨ä¸‹åˆ—æŒ‡ä»¤ä¾†å°‡ .ts æª”æ¡ˆè½‰ç‚º .jsï¼š\ntsc è½‰æ›å®Œæˆå¾Œå°±å¯ä»¥é‹è¡Œä¼ºæœå™¨äº†ï¼š\nnode dist/app.js ç•«é¢ä¸Šæœƒé¡¯ç¤º [server]: Server is running at http://localhost:3000 é€£æ¥åˆ°å¾Œé¢çš„ç¶²å€ï¼Œå°±å¯ä»¥çœ‹åˆ°ä¼ºæœå™¨æ­£å¸¸é‹è¡Œçš„ç•«é¢äº†ã€‚\næŒ‰ä¸‹ Ctrl+c å°±å¯ä»¥åœæ­¢ä¼ºæœå™¨\næŒçºŒç›£çœ‹ TypeScript æª”æ¡ˆ åœ¨é–‹ç™¼æœŸé–“ï¼Œé€šå¸¸æœƒé »ç¹çš„æ”¹è®Šç¶²é å…§å®¹ä¸¦è§€å¯Ÿå…¶çµæœï¼Œå¦‚æœä»¥ä¸Šè¿°æ–¹å¼æ¯ä¸€æ¬¡éƒ½è¦å…ˆç·¨è­¯å†åŸ·è¡Œï¼Œè‚¯å®šæœƒé€ æˆè¨±å¤šä¸æ–¹ä¾¿ï¼Œè€Œä¸”éš¨è‘—æ™‚é–“å¢é•·ç¨‹å¼ä¹Ÿæœƒè¶Šä¾†è¶Šå¤§ï¼Œæ‰€ç·¨è­¯çš„æ™‚é–“ä¹Ÿæœƒç›¸å°å¢åŠ ã€‚\nå¯ä»¥ä½¿ç”¨ nodemon ä¾†è§£æ±ºé€™å€‹å•é¡Œã€‚nodemon æ˜¯ä¸€å€‹å¹«åŠ©é–‹ç™¼è€…çš„å·¥å…·ï¼Œç•¶ç›®éŒ„è£¡çš„æª”æ¡ˆæ”¹è®Šæ™‚ï¼Œå®ƒæœƒè‡ªå‹•åµæ¸¬ä¸¦å¹«åŠ©æˆ‘å€‘é‡é–‹æ‡‰ç”¨ç¨‹å¼ã€‚ä½†æ˜¯é‡é–‹æ‡‰ç”¨ç¨‹å¼æ˜¯ä¸å¤ çš„ï¼Œå› ç‚º TypeScript é‚„æœ‰è¦å…ˆç·¨è­¯çš„å•é¡Œï¼Œæ‰€ä»¥å¯ä»¥æ­é… ts-node ä¸€èµ·ä½¿ç”¨ (å¦‚æœæ²’æœ‰å®‰è£æ­¤å¥—ä»¶ï¼Œåœ¨åŸ·è¡Œ nodemon æ™‚å°±æœƒè¦ä½ å®‰è£)ã€‚\nå®‰è£å…©å€‹æ‰€éœ€è¦çš„å¥—ä»¶ï¼š\nnpm i -D nodemon ts-node æ‰“é–‹ package.json ä¾†ç·¨å¯«è…³æœ¬ï¼š\n\u0026#34;scripts\u0026#34;: { \u0026#34;build\u0026#34;: \u0026#34;tsc\u0026#34;, \u0026#34;dev\u0026#34;: \u0026#34;NODE_ENV=development nodemon ./src/app.ts\u0026#34; } é‹è¡Œè…³æœ¬ï¼š\nnpm run dev ä½ å¯ä»¥å˜—è©¦æ”¹è®Š res.send('Express + TypeScript Server'); è£¡çš„æ–‡å­—ï¼Œå„²å­˜å¾Œé‡æ•´ç¶²é å°±èƒ½çœ‹åˆ°æ”¹è®Šçš„çµæœï¼Œå°±ä¸éœ€è¦é€²è¡Œç·¨è­¯å†åŸ·è¡Œçš„å‹•ä½œäº†ã€‚\nçµè«– ä»¥ä¸Šå°±æ˜¯å»ºç«‹ä¸€å€‹æœ€åŸºæœ¬ Express + TypeScript çš„æ–¹å¼ã€‚\n","permalink":"https://et860525.github.io/posts/typescript-express-initialization/","summary":"\u003cp\u003eé€™ç¯‡æ–‡ç« æœƒç´€éŒ„å¦‚ä½•åœ¨ \u003ca href=\"https://expressjs.com/\"\u003eExpress\u003c/a\u003e å°ˆæ¡ˆè£¡è¨­å®š \u003ca href=\"https://www.typescriptlang.org/\"\u003eTypeScript\u003c/a\u003eã€‚\u003c/p\u003e\n\u003cp\u003eå…ˆæ±ºæ¢ä»¶ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå®‰è£ \u003ca href=\"https://nodejs.org/en/\"\u003eNode.js\u003c/a\u003e ( LTS ) åœ¨ä½ çš„é–‹ç™¼ç’°å¢ƒä¸Š\u003c/li\u003e\n\u003cli\u003eåŸºæœ¬çš„ \u003ccode\u003eNode.js\u003c/code\u003e ã€ \u003ccode\u003eExpress\u003c/code\u003e èˆ‡ \u003ccode\u003eTypeScript\u003c/code\u003e çŸ¥è­˜\u003c/li\u003e\n\u003c/ul\u003e","title":"TypeScript: åˆå§‹åŒ– Express å°ˆæ¡ˆ"},{"content":"ç‰¹å¾µ( trait )ï¼Œæ˜¯å®šç¾©ç‰¹å®šå‹åˆ¥èˆ‡å…¶ä»–å‹åˆ¥å…±äº«çš„åŠŸèƒ½ã€‚å¯ä»¥ä½¿ç”¨ç‰¹å¾µç•Œé™ ( trait bounds ) ä¾†æŒ‡å®šæ³›å‹å‹åˆ¥ç‚ºæ“æœ‰ç‰¹å®šè¡Œç‚ºçš„ä»»æ„å‹åˆ¥ã€‚\nç‰¹å¾µé¡ä¼¼æ–¼å…¶ä»–èªè¨€å¸¸ç¨±ä½œä»‹é¢ ( interfaces ) çš„åŠŸèƒ½ï¼Œä½†é‚„æ˜¯æœ‰äº›å·®ç•°ã€‚\nå®šç¾©ç‰¹å¾µ èˆ‰ä¾‹ï¼Œç¾åœ¨æˆ‘å€‘æœ‰å…©å€‹çµæ§‹é«”å„è‡ªæ“æœ‰ä¸åŒç¨®é¡èˆ‡ä¸åŒæ•¸é‡çš„æ–‡å­—ï¼š\nNewsArticleÂ å„²å­˜ç‰¹å®šåœ°é»çš„æ–°èæ•…äº‹ TweetÂ å‰‡æœ‰æœ€å¤š 280 å­—å…ƒçš„å…§å®¹ï¼Œä¸”æœ‰å€‹æ¬„ä½ä¾†åˆ¤æ–·æ˜¯å…¨æ–°çš„æ¨æ–‡ã€è½‰æ¨æˆ–å…¶ä»–æ¨æ–‡çš„å›è¦†ã€‚ æˆ‘å€‘æƒ³è¦å»ºç«‹ä¸€å€‹å¤šåª’é«”è³‡æ–™åº«ï¼Œä¾†é¡¯ç¤ºå¯èƒ½å­˜åœ¨æ–¼ NewsArticleÂ æˆ–Â TweetÂ å¯¦ä¾‹çš„ç¸½çµ ( summary )ã€‚è¦é”æˆé€™å€‹ç›®çš„ï¼Œæˆ‘å€‘æœƒå‘¼å«è©²å¯¦ä¾‹çš„Â summarizeÂ æ–¹æ³•ä¾†ç²å¾—å¯¦ä¾‹è£¡çš„ summaryã€‚\næ–°å»ºç«‹ä¸€å€‹æª”æ¡ˆç‚º src/lib.rsï¼Œä¸¦åœ¨æ­¤ä½¿ç”¨Â traitÂ é—œéµå­—å®šç¾©ä¸€å€‹ Summary ç‰¹å¾µï¼š\npub trait Summary { fn summarize(\u0026amp;self) -\u0026gt; String; } fn summarize(\u0026amp;self) -\u0026gt; String å®£å‘Šæ–¹æ³•ç°½åä¾†æè¿°æœ‰å¯¦ä½œæ­¤ç‰¹å¾µçš„å‹åˆ¥è¡Œç‚º ç‰¹å¾µæœ¬é«”ä¸­å¯ä»¥æœ‰å¤šå€‹æ–¹æ³•ï¼Œæ¯è¡Œæœƒæœ‰ä¸€å€‹æ–¹æ³•ç°½åä¸¦éƒ½ä»¥åˆ†è™Ÿåšçµå°¾ã€‚\næ¯å€‹æœ‰å¯¦ä½œæ­¤ç‰¹å¾µçš„å‹åˆ¥ï¼Œéƒ½å¿…é ˆæä¾›å…¶è‡ªè¨‚è¡Œç‚ºçš„æ–¹æ³•æœ¬é«”ã€‚ç·¨è­¯å™¨æœƒå¼·åˆ¶è¦æ±‚ä»»ä½•æœ‰Â SummaryÂ ç‰¹å¾µçš„å‹åˆ¥éƒ½è¦æœ‰å®šç¾©ç›¸åŒç°½åçš„Â summarizeÂ æ–¹æ³•ã€‚\nå‹åˆ¥å¯¦ä½œç‰¹å¾µ åœ¨ src/lib.rs ä¸­å®šç¾© Summary ç‰¹å¾µå®Œæˆå¾Œï¼Œå°±å¯ä»¥åœ¨è³‡æ–™åº«è£¡å¯¦ä½œå®ƒï¼š\npub trait Summary { fn summarize(\u0026amp;self) -\u0026gt; String; } pub struct NewsArticle { pub headline: String, pub location: String, pub author: String, pub content: String, } impl Summary for NewsArticle { fn summarize(\u0026amp;self) -\u0026gt; String { format!(\u0026#34;{} {} è‘— ({})\u0026#34;, self.headline, self.author, self.location) } } pub struct Tweet { pub username: String, pub content: String, pub reply: bool, pub retweet: bool, } impl Summary for Tweet { fn summarize(\u0026amp;self) -\u0026gt; String { format!(\u0026#34;{}: {}\u0026#34;, self.username, self.content) } } åœ¨Â implÂ ä¹‹å¾Œæˆ‘å€‘åŠ ä¸Šæƒ³è¦å¯¦ä½œçš„ç‰¹å¾µï¼Œç„¶å¾Œä½¿ç”¨ for é—œéµå­—åŠ ä¸Šæƒ³è¦å¯¦ä½œçš„å‹åˆ¥åç¨±ã€‚ä¸¦åœ¨ impl å€å¡Šè£¡å®šç¾©ç‰¹å¾µæ‰€æŒ‡å®šçš„æ–¹æ³•ã€‚\né€™è£¡ä½¿ç”¨çš„ rust_aggregator æ˜¯ä¸€é–‹å§‹ cargo new \u0026lt;name\u0026gt; çš„åå­—ï¼Œæˆ‘å€‘å·²ç¶“åœ¨å‡½å¼åº«è£¡åŠ å…¥å°Â NewsArticleÂ å’ŒÂ TweetÂ å¯¦ä½œÂ SummaryÂ ç‰¹å¾µï¼Œå¦‚æœæ˜¯ crate çš„ä½¿ç”¨è€…åªè¦ç›´æ¥å‘¼å«å³å¯ã€‚å”¯ä¸€çš„ä¸åŒå°±æ˜¯ï¼Œä½¿ç”¨çš„ç‰¹å¾µä¹Ÿå¿…é ˆåŠ å…¥åˆ°ä½œç”¨åŸŸä¸­ã€‚\nä»¥ä¸‹æ˜¯æˆ‘çš„ rust_aggregator å‡½å¼åº«çš„ main.rsï¼š\nuse rust_aggregator::{self, Summary, Tweet}; fn main() { let tweet = Tweet { username: String::from(\u0026#34;horse_ebooks\u0026#34;), content: String::from( \u0026#34;of course, as you probably already know, people\u0026#34;, ), reply: false, retweet: false, }; println!(\u0026#34;1 å‰‡æ–°æ¨æ–‡ï¼š{}\u0026#34;, tweet.summarize()); } æ­¤ç¨‹å¼ç¢¼æœƒå°å‡ºï¼š1 å‰‡æ–°æ¨æ–‡ï¼šhorse_ebooks: of course, as you probably alreadyknow, peopleã€‚\né è¨­å¯¦ä½œ å°‡ç‰¹å¾µå…§çš„ä¸€äº›æ–¹æ³•é å…ˆå®šç¾©å¯¦ä½œï¼Œå°±ä¸ç”¨è¦æ±‚å‹åˆ¥å¯¦ä½œé€™äº›æ–¹æ³•äº†ã€‚å¦‚æœç‰¹å®šå‹åˆ¥æƒ³è¦æ›´æ”¹ç‰¹å¾µå…§æ–¹æ³•çš„å¯¦ä½œï¼Œç›´æ¥å¯«ä¸Šæ–¹æ³•å°±èƒ½è¦†è“‹é è¨­çš„å¯¦ä½œã€‚ä»¥ä¸‹æ˜¯å®šç¾©é è¨­å¯¦ä½œï¼š\npub trait Summary { fn summarize(\u0026amp;self) -\u0026gt; String { String::from(\u0026#34;(é–±è®€æ›´å¤š...)\u0026#34;) } } ç•¶ summarize æ–¹æ³•æ­¤æ™‚æœ‰é è¨­å¯¦ä½œï¼Œå°±ä¸æœƒå¼·åˆ¶è¦æ±‚å‹åˆ¥éœ€è¦è¨­å®šæ­¤æ–¹æ³•ï¼š\nfn main() { let article = NewsArticle { headline: String::from(\u0026#34;Penguins win the Stanley Cup Championship!\u0026#34;), location: String::from(\u0026#34;Pittsburgh, PA, USA\u0026#34;), author: String::from(\u0026#34;Iceburgh\u0026#34;), content: String::from( \u0026#34;The Pittsburgh Penguins once again are the best \\ hockey team in the NHL.\u0026#34;, ), }; println!(\u0026#34;æœ‰æ–°æ–‡ç« ç™¼ä½ˆï¼{}\u0026#34;, article.summarize()); } å¦‚æœ NewsArticle æ²’æœ‰å¯¦ä½œ summarize æ–¹æ³•ï¼Œæ­¤ç¨‹å¼ç¢¼å°±æœƒå°å‡ºÂ æœ‰æ–°æ–‡ç« ç™¼ä½ˆï¼(é–±è®€æ›´å¤š...)ã€‚\nç‰¹å¾µä½œç‚ºåƒæ•¸ ä½¿ç”¨ç‰¹å¾µä¾†å®šç¾©å‡½å¼æ‰€æ¥å—çš„åƒæ•¸ã€‚åœ¨ Summary ç‰¹å¾µå®šç¾©ä¸€å€‹æ–°çš„ notify å‡½å¼ï¼Œå®ƒæœƒä½¿ç”¨è‡ªå·±çš„åƒæ•¸ item ä¾†å‘¼å« summarize æ–¹æ³•ï¼Œæ‰€ä»¥æ­¤åƒæ•¸çš„å‹åˆ¥æœƒé æœŸæœ‰ Summary ç‰¹å¾µã€‚\npub fn notify(item: \u0026amp;impl Summary) { println!(\u0026#34;é ­æ¢æ–°èï¼{}\u0026#34;, item.summarize()); } itemÂ åƒæ•¸æŒ‡å®šå¯¦éš›å‹åˆ¥ç”¨çš„æ˜¯ impl é—œéµå­—åŠ ä¸Šç‰¹å¾µåç¨±ï¼Œè¡¨ç¤ºæ­¤åƒæ•¸æœƒæ¥å—ä»»ä½•æœ‰å¯¦ä½œæŒ‡å®šç‰¹å¾µçš„å‹åˆ¥ ( NewsArticleÂ æˆ–Â Tweet ) ã€‚ä½†å¦‚æœç”¨å…¶ä»–å‹åˆ¥åƒæ˜¯Â StringÂ æˆ–Â i32Â ä¾†å‘¼å«æ­¤ç¨‹å¼ç¢¼å‰‡æœƒç„¡æ³•ç·¨è­¯ï¼Œå› ç‚ºé‚£äº›å‹åˆ¥æ²’æœ‰å¯¦ä½œÂ Summaryã€‚\né€™èƒ½è®“å‡½å¼çš„åƒæ•¸åªæ¥å—ç‰¹å®šç‰¹å¾µçš„å‹åˆ¥\nç‰¹å¾µç•Œé™èªæ³• impl TraitÂ æ˜¯ä¸€å€‹æ›´é•·æ ¼å¼çš„èªæ³•ç³–ï¼Œè€Œé€™å€‹æ ¼å¼ç¨±ç‚ºç‰¹å¾µç•Œé™ ( trait bound )ï¼Œå®ƒé•·å¾—åƒï¼š\npub fn notify\u0026lt;T: Summary\u0026gt;(item: \u0026amp;T) { println!(\u0026#34;é ­æ¢æ–°èï¼{}\u0026#34;, item.summarize()); } impl TraitÂ èªæ³•æ¯”è¼ƒæ–¹ä¾¿ï¼Œä¸”åœ¨ç°¡å–®çš„æ¡ˆä¾‹ä¸­å¯ä»¥è®“ç¨‹å¼ç¢¼æ¯”è¼ƒç°¡æ½”ï¼Œè€Œç‰¹å¾µç•Œé™é©åˆå…¶ä»–è¤‡é›œçš„æ¡ˆä¾‹ã€‚\nèˆ‰ä¾‹åƒæ•¸æ˜¯å…©å€‹å¯¦ä½œ Summary åƒæ•¸ï¼Œä½¿ç”¨ impl Traitï¼š\npub fn notify(item1: \u0026amp;impl Summary, item2: \u0026amp;impl Summary) { å¦‚æœå‡½å¼å…è¨± item1 èˆ‡ item2 æ˜¯ä¸åŒå‹åˆ¥ï¼Œå°±å¯ä½¿ç”¨ impl Traitã€‚ä½†å¦‚æœå…©å€‹åƒæ•¸æ˜¯åŒä¸€å‹åˆ¥ï¼Œå°±è¦æ”¹æˆç‰¹å¾µç•Œé™ ( trait bound ) çš„æ–¹å¼ï¼š\npub fn notify\u0026lt;T: Summary\u0026gt;(item1: \u0026amp;T, item2: \u0026amp;T) { é€™æ¨£ item1 èˆ‡ item2 çš„å‹åˆ¥å°±å¿…é ˆè¦ç›¸åŒäº†ã€‚\nä½¿ç”¨ã€Œ+ã€æŒ‡å®šå¤šå€‹ç‰¹å¾µç•Œé™ åœ¨ä¸Šä¸€ç« æ³›å‹æœ‰æåˆ°ç”¨å…©å€‹ç‰¹å¾µçš„å‡½å¼ï¼š\nfn largest\u0026lt;T: PartialOrd + Copy\u0026gt;(list: \u0026amp;[T]) -\u0026gt; T { é€™å…©å€‹ç‰¹å¾µåˆ†åˆ¥ç‚ºï¼š\nPartialOrd åˆ¤æ–·é‚è¼¯ Copy å°‡è®Šæ•¸æŒ‡æ´¾çµ¦å¦ä¸€å€‹è®Šæ•¸ é€™å€‹æ–¹æ³•ä¹Ÿä¸€æ¨£å¯ä»¥ç”¨åœ¨åƒæ•¸è£¡ã€‚å‡è¨­ notify ä¸­çš„ item ä¸åªèƒ½å‘¼å« summarizeÂ æ–¹æ³•ï¼Œé‚„èƒ½é¡¯ç¤ºæ ¼å¼åŒ–è¨Šæ¯çš„è©±ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ +ï¼š\nimpl Trait pub fn notify(item: \u0026amp;(impl Summary + Display)) { ç‰¹å¾µç•Œé™ pub fn notify\u0026lt;T: Summary + Display\u0026gt;(item: \u0026amp;T) ä½¿ç”¨ã€Œwhereã€ä½¿ç‰¹å¾µç•Œé™æ›´æ¸…æ¥š å¦‚æœä»Šå¤©æ¯å€‹æ³›å‹éƒ½æœ‰è‡ªå·±çš„ç‰¹å¾µç•Œé™ï¼Œæœƒé€ æˆå‡½å¼ç°½åé›£ä»¥é–±è®€ï¼š\nfn some_function\u0026lt;T: Display + Clone, U: Clone + Debug\u0026gt;(t: \u0026amp;T, u: \u0026amp;U) -\u0026gt; i32 { ä½¿ç”¨ where è®“ä¸€åˆ‡çœ‹èµ·ä¾†ä¸é‚£éº¼è¤‡é›œï¼š\nfn some_function\u0026lt;T, U\u0026gt;(t: \u0026amp;T, u: \u0026amp;U) -\u0026gt; i32 where { T: Display + Clone, U: Clone + Debug, } å›å‚³æœ‰å¯¦ä½œç‰¹å¾µçš„å‹åˆ¥ åœ¨å›å‚³å‹åˆ¥çš„ä½ç½®ä½¿ç”¨Â impl TraitÂ èªæ³•ï¼Œä¾†å›å‚³æŸå€‹æœ‰å¯¦ä½œç‰¹å¾µçš„å‹åˆ¥ï¼š\nfn returns_summarizable() -\u0026gt; impl Summary { Tweet { username: String::from(\u0026#34;horse_ebooks\u0026#34;), content: String::from( \u0026#34;of course, as you probably already know, people\u0026#34;, ), reply: false, retweet: false, } } ä½†æ˜¯å¦‚æœä½¿ç”¨ impl Trait çš„è©±å°±åªèƒ½å›å‚³å–®ä¸€å‹åˆ¥ã€‚èˆ‰ä¾‹ä¾†èªªï¼Œé›–ç„¶ç¨‹å¼ç¢¼æŒ‡å®šå›å‚³çš„å‹åˆ¥ç‚º impl Summaryï¼Œä½†æ˜¯å°‡ç¨‹å¼ç¢¼å¯«æˆå¯èƒ½æœƒå›å‚³ NewsArticleÂ æˆ–Â Tweet å°±æœƒç„¡æ³•åŸ·è¡Œï¼š\nfn returns_summarizable(switch: bool) -\u0026gt; impl Summary { if switch { NewsArticle { headline: String::from( \u0026#34;Penguins win the Stanley Cup Championship!\u0026#34;, ), location: String::from(\u0026#34;Pittsburgh, PA, USA\u0026#34;), author: String::from(\u0026#34;Iceburgh\u0026#34;), content: String::from( \u0026#34;The Pittsburgh Penguins once again are the best \\ hockey team in the NHL.\u0026#34;, ), } } else { Tweet { username: String::from(\u0026#34;horse_ebooks\u0026#34;), content: String::from( \u0026#34;of course, as you probably already know, people\u0026#34;, ), reply: false, retweet: false, } } } å°æ–¼å¯èƒ½è¿”å›Â NewsArticleÂ æˆ–Â TweetÂ çš„è©±æ˜¯ä¸è¢«å…è¨±çš„ï¼Œå› ç‚ºÂ impl TraitÂ èªæ³•æœƒé™åˆ¶åœ¨ç·¨è­¯å™¨ä¸­æœ€çµ‚æ±ºå®šçš„å‹åˆ¥ã€‚\né€éç‰¹å¾µç•Œé™ä¾†é¸æ“‡æ€§å¯¦ä½œæ–¹æ³• åœ¨æœ‰ä½¿ç”¨æ³›å‹å‹åˆ¥åƒæ•¸Â implÂ å€å¡Šä¸­ä½¿ç”¨ç‰¹å¾µç•Œé™ï¼Œå°±å¯ä»¥æœ‰é¸æ“‡æ€§çš„å¯¦ä½œç‰¹å®šå‹åˆ¥çš„å¯¦ä½œæ–¹æ³•ï¼š\nuse std::fmt::Display; struct Pair\u0026lt;T\u0026gt; { x: T, y: T, } impl\u0026lt;T\u0026gt; Pair\u0026lt;T\u0026gt; { fn new(x: T, y: T) -\u0026gt; Self { Self { x, y } } } impl\u0026lt;T: Display + PartialOrd\u0026gt; Pair\u0026lt;T\u0026gt; { fn cmp_display(\u0026amp;self) { if self.x \u0026gt;= self.y { println!(\u0026#34;æœ€å¤§çš„æ˜¯ x = {}\u0026#34;, self.x); } else { println!(\u0026#34;æœ€å¤§çš„æ˜¯ y = {}\u0026#34;, self.y); } } } ç°¡å–®ä¾†èªªï¼Œç¬¬ä¸€å€‹ impl\u0026lt;T\u0026gt; å› ç‚ºå®ƒæ²’æœ‰ä»»ä½•ç‰¹å¾µï¼Œæ‰€æœ‰å‹åˆ¥çš„ Pair éƒ½å¯ä»¥ä½¿ç”¨é€™å€‹æ–¹æ³•ï¼›ç¬¬äºŒå€‹ impl å‰‡æœ‰é™å®šå‹åˆ¥ï¼Œå¦‚æœå‹åˆ¥çš„ç‰¹å¾µæ˜¯ \u0026lt;T: Display + PartialOrd\u0026gt; é‚£å®ƒå°±å¯ä»¥ä½¿ç”¨ï¼Œå¦‚æœæ²’æœ‰å‰‡ç„¡æ³•ä½¿ç”¨é€™å€‹æ–¹æ³•ã€‚\nè€Œé€™ç¨®æ»¿è¶³ç‰¹å¾µç•Œé™çš„å‹åˆ¥å¯¦ä½œç‰¹å¾µï¼Œå‰‡ç¨±ä¹‹ç‚ºå…¨é¢å¯¦ä½œ ( blanket implementations )ï¼Œé€™è¢«å»£æ³›çš„ä½¿ç”¨åœ¨ Rust æ¨™æº–å‡½å¼ä¸­ã€‚èˆ‰å€‹ä¾‹å­ï¼Œæ¨™æº–å‡½å¼åº«æœƒå°ä»»ä½•æœ‰å¯¦ä½œ Display ç‰¹å¾µçš„å‹åˆ¥å¯¦ä½œ ToStringï¼Œä»¥ä¸‹æ˜¯é¡ä¼¼æ–¼æ¨™æº–å‡½å¼åº«ä¸­çš„ impl å€å¡Šï¼š\nimpl\u0026lt;T: Display\u0026gt; ToString for T { // --çœç•¥-- } æ¨™æº–å‡½å¼åº«æœ‰æ­¤å…¨é¢å¯¦ä½œï¼Œé€™æ¨£å°±èƒ½å°‡æ•´æ•¸èˆ‡å­—å…ƒè½‰ç‚º Stringï¼š\nlet s1 = 3.to_string(); let s2 = \u0026#39;c\u0026#39;.to_string(); çµè«– ä¸Šè¿°æœ‰æåˆ° Traitèˆ‡å…¶ä»–ç¨‹å¼èªè¨€çš„ Interface æœ‰äº›ä¸åŒï¼Œå…¶ä¸­æœ€å¤§çš„ä¸åŒåœ¨æ–¼ï¼šInterface ä¸»è¦æ˜¯æ ¹æ“šç‰¹å®šçš„ object ä¾†è¨­å®šæ¥å£çš„ï¼›Trait å‰‡å¯ä»¥å°ç¾æœ‰çš„å‹åˆ¥ä¾†å¯¦ç¾å¯¦ä½œï¼š\ntrait Hash { fn hash(\u0026amp;self) -\u0026gt; u64; } impl Hash for bool { fn hash(\u0026amp;self) -\u0026gt; u64 { if *self { 0 } else { 1 } } } impl Hash for i64 { fn hash(\u0026amp;self) -\u0026gt; u64 { *self as u64 } } åœ¨ Hash çš„ä½œç”¨åŸŸå…§å°±å¯ä»¥ä½¿ç”¨ true.hash() é€™æ¨£çš„å¯«æ³•ã€‚\nå¼•ç”¨ ç‰¹å¾µï¼šå®šç¾©å…±åŒè¡Œç‚º Traits: Defining Shared Behavior Abstraction without overhead: traits in Rust ","permalink":"https://et860525.github.io/posts/rust-trait/","summary":"\u003cp\u003eç‰¹å¾µ( trait )ï¼Œæ˜¯å®šç¾©ç‰¹å®šå‹åˆ¥èˆ‡å…¶ä»–å‹åˆ¥å…±äº«çš„åŠŸèƒ½ã€‚å¯ä»¥ä½¿ç”¨\u003cstrong\u003eç‰¹å¾µç•Œé™ ( trait bounds )\u003c/strong\u003e ä¾†æŒ‡å®šæ³›å‹å‹åˆ¥ç‚ºæ“æœ‰ç‰¹å®šè¡Œç‚ºçš„ä»»æ„å‹åˆ¥ã€‚\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eç‰¹å¾µé¡ä¼¼æ–¼å…¶ä»–èªè¨€å¸¸ç¨±ä½œ\u003cstrong\u003eä»‹é¢ ( interfaces )\u003c/strong\u003e çš„åŠŸèƒ½ï¼Œä½†é‚„æ˜¯æœ‰äº›å·®ç•°ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e","title":"Rust: ç‰¹å¾µ( Trait )"},{"content":"æ³›å‹ ( generics )ï¼Œå¯¦éš›å‹åˆ¥æˆ–å±¬æ€§çš„æŠ½è±¡è¡¨ç¤ºã€‚èˆ‰ä¾‹ä¾†èªªï¼ŒString å’Œ i32 é€™å…©å€‹ä¸åŒå‹åˆ¥çš„è³‡æ–™éƒ½å¯ä»¥è¢«å­˜åˆ° Vec çµæ§‹é«”å»ºç«‹çš„å¯¦ä¾‹ä¸­ï¼Œä¸éœ€è¦é‡å°å‹åˆ¥ä¾†åšåˆ†åˆ¥ï¼Œåªè¦ä½¿ç”¨Â Vec\u0026lt;String\u0026gt;Â æˆ–Â Vec\u0026lt;i32\u0026gt;ï¼Œé€™æ˜¯å› ç‚ºÂ VecÂ çµæ§‹é«”ä½¿ç”¨äº†æ³›å‹ã€‚\næ³›å‹å°±æ˜¯Â åƒæ•¸å¤šå‹ ( parametric polymorphism )ï¼Œåœ¨å®šç¾©å‹åˆ¥æˆ–å‡½æ•¸çš„æ™‚å€™ä¸å»æ˜ç¢ºæŒ‡å®šå…·é«”çš„å‹åˆ¥ï¼Œè€Œæ˜¯ä»¥åƒæ•¸çš„å½¢å¼ä¾†å‚³å…¥å‹åˆ¥ï¼Œé€™å¯ä»¥è®“ç¨‹å¼è¨­è¨ˆæ›´ç‚ºå½ˆæ€§ã€‚\nä»¥ä¸‹å…ˆä¾†çœ‹æ³›å‹åœ¨å„å€‹åœ°æ–¹ä¸­å¦‚ä½•å®šç¾©ã€‚\nå‡½å¼ä¸­å®šç¾© ç”¨ä¸€å€‹æ‰¾å‡ºé™£åˆ—æœ€å¤§å…ƒç´ å€¼çš„ç¨‹å¼ä¾†å¯¦ä½œæ³›å‹ï¼Œé¦–å…ˆï¼Œå…ˆä¾†çœ‹å®ƒåŸæœ¬çš„æ¨£å­ï¼š\nfn largest_i32(list: \u0026amp;[i32]) -\u0026gt; i32 { let mut largest = list[0]; for \u0026amp;item in list.iter() { if item \u0026gt; largest { largest = item; } } largest } fn largest_char(list: \u0026amp;[char]) -\u0026gt; char { let mut largest = list[0]; for \u0026amp;item in list.iter() { if item \u0026gt; largest { largest = item; } } largest } fn main() { let int_list = vec![34, 50, 25, 100, 65]; let result = largest_i32(\u0026amp;int_list); println!(\u0026#34;The largest integer number is {}\u0026#34;, result); let char_list = vec![\u0026#39;y\u0026#39;, \u0026#39;m\u0026#39;, \u0026#39;a\u0026#39;, \u0026#39;q\u0026#39;]; let result = largest_char(\u0026amp;char_list); println!(\u0026#34;The largest char is {}\u0026#34;, result); } å…©å€‹ largest_i32ã€largest_charï¼Œå¯ä»¥åˆ†åˆ¥å¾ 32ä½å…ƒçš„æœ‰è™Ÿæ•´æ•¸é™£åˆ—åˆ‡ç‰‡ã€å­—å…ƒé™£åˆ—åˆ‡ç‰‡ä¸­æ‰¾å‡ºæœ€å¤§çš„å…ƒç´ ä¸¦å›å‚³å‡ºä¾†ã€‚åŸºæœ¬ä¸Šå‡½å¼è£¡é¢çš„ç¨‹å¼ç¢¼éƒ½æ˜¯ç›¸åŒçš„ï¼Œåªæ˜¯å› ç‚ºæˆ‘å€‘è¦è™•ç†ä¸åŒå‹åˆ¥çš„è³‡æ–™æ‰€ä»¥å¯«äº†ä¸‰æ¬¡ï¼Œå¦‚æœè¦é€£ i8ã€i16ã€i64ã€u8ã€u16ã€u32ã€u64ã€f32 ç­‰å‹åˆ¥çš„é™£åˆ—åˆ‡ç‰‡éƒ½å¯«ï¼Œé‚£ä¸å°±è¦å†å¤šå¯«8æ¬¡ï¼Œæ‰€ä»¥ Rust æä¾›æ³›å‹ä¾†è§£æ±ºé€™å€‹å•é¡Œï¼Œä»¥ä¸‹æ˜¯æ”¹ç‚ºæ³›å‹ç¤ºç¯„ï¼š\nfn largest\u0026lt;T\u0026gt;(list: \u0026amp;[T]) -\u0026gt; T { let mut largest = list[0]; for \u0026amp;item in list.iter() { if item \u0026gt; largest { largest = item; } } largest } fn main() { let int_list = vec![34, 50, 25, 100, 65]; let result = largest(\u0026amp;int_list); println!(\u0026#34;The largest integer number is {}\u0026#34;, result); let char_list = vec![\u0026#39;y\u0026#39;, \u0026#39;m\u0026#39;, \u0026#39;a\u0026#39;, \u0026#39;q\u0026#39;]; let result = largest(\u0026amp;char_list); println!(\u0026#34;The largest char is {}\u0026#34;, result); } åœ¨å‘¼å« largest\u0026lt;T\u0026gt; å‡½å¼æ™‚ï¼Œç·¨è­¯å™¨æœƒåœ¨ç·¨è­¯éšæ®µæ™‚è‡ªå‹•åˆ¤æ–·æ³›å‹çš„ç¬¬ä¸€å€‹åƒæ•¸å‹åˆ¥ï¼Œä¾†æ±ºå®š T æœƒæ˜¯ä»€éº¼å‹åˆ¥ã€‚å¦‚æœä¸æƒ³è¦è®“ç·¨è­¯å™¨è‡ªå·±åˆ¤å®šï¼Œé‚£å°±åœ¨å‘¼å«å‡½å¼æ™‚ç›´æ¥æŒ‡å®šæ³›å‹çš„å‹åˆ¥ï¼š\nfn largest\u0026lt;T\u0026gt;(list: \u0026amp;[T]) -\u0026gt; T { // ç•¥... } fn main() { let int_list = vec![34, 50, 25, 100, 65]; let result = largest::\u0026lt;i32\u0026gt;(\u0026amp;int_list); println!(\u0026#34;The largest integer number is {}\u0026#34;, result); let char_list = vec![\u0026#39;y\u0026#39;, \u0026#39;m\u0026#39;, \u0026#39;a\u0026#39;, \u0026#39;q\u0026#39;]; let result = largest::\u0026lt;char\u0026gt;(\u0026amp;char_list); println!(\u0026#34;The largest char is {}\u0026#34;, result); } ä¸ç®¡å¦‚ä½•ï¼Œä¸Šè¿°ç¨‹å¼ç¢¼åŸ·è¡Œéƒ½æœƒå‡ºç¾éŒ¯èª¤ã€‚é€™æ˜¯å› ç‚ºè¦å°‡å€¼é€²è¡Œå¤§æ–¼å°æ–¼çš„åˆ¤å®šä¹‹é¡çš„é‚è¼¯åˆ¤æ–·ï¼Œè©²å€¼å°±å¿…é ˆè¦æœ‰ PartialOrd çš„ç‰¹å¾µ ( trait ) ã€‚ç¶œä¸Šæ‰€çŸ¥ï¼Œæ³›å‹çš„ T å¯ä»¥æ˜¯ä»»ä½•å‹åˆ¥ï¼Œä½†å®ƒä¸ä¸€å®šæœƒæ˜¯ PartialOrd ç‰¹å¾µï¼Œæ‰€ä»¥ç¨‹å¼ç¢¼æ‰æœƒç·¨è­¯å¤±æ•—ã€‚ç‚ºäº†è¦è®“ç·¨è­¯å™¨ç¢ºå®š T è¦æœ‰é€™å€‹ PartialOrd ç‰¹å¾µï¼Œæˆ‘å€‘å¿…é ˆäº‹å…ˆæ˜ç¢ºå®šç¾©ï¼Œå°±åƒå®šç¾©ä¸€èˆ¬å‡½å¼åƒæ•¸çš„å‹åˆ¥ï¼š\nfn largest\u0026lt;T: PartialOrd\u0026gt;(list: \u0026amp;[T]) -\u0026gt; T { // åŠ ä¸Š PartialOrd ç‰¹å¾µ let mut largest = list[0]; for \u0026amp;item in list.iter() { if item \u0026gt; largest { largest = item; } } largest } fn main() { // ç•¥... } å†ç·¨è­¯ä¸€æ¬¡é‚„æ˜¯æœƒæœ‰éŒ¯èª¤ï¼Œé€™æ˜¯å› ç‚ºç¬¬ 2è¡Œæœ‰å°‡é™£åˆ—çš„å…ƒç´ æŒ‡æ´¾çµ¦ largest è®Šæ•¸ï¼Œé€™ç¨® æŠŠè®Šæ•¸æŒ‡æ´¾çµ¦å¦ä¸€å€‹è®Šæ•¸å°±è¡¨ç¤ºé€™å€‹å‹åˆ¥æœ‰ Copy çš„ç‰¹å¾µã€‚æ‰€ä»¥é‚„è¦å†è®“ T çŸ¥é“è©²å‹åˆ¥é‚„æœƒæœ‰ Copy ç‰¹å¾µï¼š\nfn largest\u0026lt;T: PartialOrd + Copy\u0026gt;(list: \u0026amp;[T]) -\u0026gt; T { // å†åŠ ä¸Š Copy ç‰¹å¾µ let mut largest = list[0]; for \u0026amp;item in list.iter() { if item \u0026gt; largest { largest = item; } } largest } fn main() { // ç•¥... } é€™æ¨£ç¨‹å¼å°±å¯ä»¥åŸ·è¡Œäº†ï¼š\nâ¯ cargo run Compiling hello_cargo v0.1.0 (file:///projects//hello_cargo) Finished dev [unoptimized + debuginfo] target(s) in 0.23s Running `target/debug/hello_cargo` The largest integer number is 100 The largest char is y çµæ§‹é«”ä¸­å®šç¾© åœ¨çµæ§‹é«”çš„åç¨±å³é‚ŠåŠ ä¸Š \u0026lt;\u0026gt; èªæ³•ä¾†å®šç¾©æ³›å‹ï¼š\nstruct Point\u0026lt;T\u0026gt; { x: T, y: T } fn main() { let integer = Point { x: 5, y: 10 }; let float = Point { x: 1.0, y: 4.0 }; } ç·¨è­¯å™¨åœ¨ç·¨è­¯æœŸé–“ä¹Ÿæœƒè‡ªå‹•åˆ¤æ–·æ³›å‹ç¬¬ä¸€å€‹æ¥è§¸çš„å€¼ï¼Œä¾†æ±ºå®šå‹åˆ¥ã€‚å› æ­¤ integer çš„æ³›å‹ç‚º i32ï¼›float çš„æ³›å‹ç‚º f64ã€‚\nå¦ä¸€å€‹ä¾‹å­ï¼š\nstruct Point\u0026lt;T\u0026gt; { x: T, y: T } fn main() { let wont_work = Point { x: 5, y: 4.0 }; } ä»¥ä¸Šç¨‹å¼å°±æœƒç™¼ç”ŸéŒ¯èª¤ï¼Œå› ç‚ºæ³›å‹ç¬¬ä¸€å€‹æ¥è§¸çš„å€¼æ˜¯ 5 ä¹Ÿå°±æ˜¯ i32 å‹åˆ¥ï¼Œæ­¤æ™‚ Point çš„ x èˆ‡ y çš„å€¼éƒ½ä¸€å®šè¦æ˜¯ i32ï¼Œè‡ªç„¶ä¹Ÿå°±ä¸èƒ½å­˜å– 4.0 é€™å€‹ f64 çš„å‹åˆ¥ã€‚\nè¦è§£æ±ºä¸Šé¢çš„å•é¡Œï¼Œå¯ä»¥ä½¿ç”¨å…©å€‹æ³›å‹åƒæ•¸ï¼š\nstruct Point\u0026lt;T, U\u0026gt; { x: T, y: U } fn main() { let both_integer = Point { x: 5, y: 10 }; let both_float = Point { x: 1.0, y: 4.0 }; let integer_and_float = Point { x: 5, y: 4.0 }; } æšèˆ‰ä¸­å®šç¾© åƒæ˜¯ Option æšèˆ‰ èˆ‡ Result æšèˆ‰ï¼š\nenum Option\u0026lt;T\u0026gt; { Some(T), None } enum Result\u0026lt;T, E\u0026gt; { Ok(T), Err(E) } æ–¹æ³•ä¸­å®šç¾© impl é—œéµå­—å³é‚Šä¹Ÿå¯ä»¥åŠ ä¸Š \u0026lt;\u0026gt; ä¾†å®šç¾©æ³›å‹è¦ä½¿ç”¨çš„åƒæ•¸ï¼š\nstruct Point\u0026lt;T\u0026gt; { x: T, y: T, } impl\u0026lt;T\u0026gt; Point\u0026lt;T\u0026gt; { fn x(\u0026amp;self) -\u0026gt; \u0026amp;T { \u0026amp;self.x } } fn main() { let p = Point { x: 5, y: 10 }; println!(\u0026#34;p.x = {}\u0026#34;, p.x()); } impl ä¹Ÿå¯ä»¥åªé‡å°çš„ç‰¹å®šçš„å‹åˆ¥ï¼Œä¾†å¯¦ä½œé—œè¯å‡½å¼å’Œæ–¹æ³•ï¼š\nstruct Point\u0026lt;T\u0026gt; { x: T, y: T, } impl\u0026lt;T\u0026gt; Point\u0026lt;T\u0026gt; { fn x(\u0026amp;self) -\u0026gt; \u0026amp;T { \u0026amp;self.x } } impl Point\u0026lt;f64\u0026gt; { fn distance_from_origin(\u0026amp;self) -\u0026gt; f64 { (self.x.powi(2) + self.y.powi(2)).sqrt() } } impl Point\u0026lt;i32\u0026gt; { fn distance_from_origin(\u0026amp;self) -\u0026gt; f64 { ((self.x.pow(2) + self.y.pow(2)) as f64).sqrt() } } fn main() { let p = Point { x: 3.0, y: 4.0 }; println!(\u0026#34;distance = {}\u0026#34;, p.distance_from_origin()); let p = Point { x: 5, y: 12 }; println!(\u0026#34;distance = {}\u0026#34;, p.distance_from_origin()); } ä½¿ç”¨æ³›å‹çš„ç¨‹å¼ç¢¼æ•ˆèƒ½ Rust çš„æ³›å‹ä¸æœƒæœ‰ä»»ä½•é¡å¤–çš„é‹ç®—æ•ˆèƒ½çš„è€—æã€‚\nRust åœ¨ç·¨è­¯æ™‚å°ä½¿ç”¨æ³›å‹çš„ç¨‹å¼ç¢¼é€²è¡Œå–®æ…‹åŒ– ( monomorphization ) ã€‚å–®æ…‹åŒ–èƒ½è®“æ³›å‹è½‰æ›æˆç‰¹å®šç¨‹å¼ç¢¼çš„éç¨‹ï¼Œä¸¦åœ¨ç·¨è­¯æ™‚å¡«å…¥å¯¦éš›å‹åˆ¥ã€‚ç°¡å–®ä¾†èªªï¼Œå®ƒæœƒæ ¹æ“šå¡«å…¥çš„å¯¦éš›å‹åˆ¥ï¼Œè‡ªå‹•ç”¢ç”Ÿç›¸æ‡‰çš„ç¨‹å¼ç¢¼ã€‚\nä»¥ä¸‹ç¤ºç¯„æ¨™æº–å‡½å¼åº«çš„æ³›å‹æšèˆ‰Â Option\u0026lt;T\u0026gt; æ˜¯å¦‚ä½•åšåˆ°çš„ï¼š\nlet integer = Some(5); let float = Some(5.0); Rust åœ¨ç·¨è­¯ä¸Šé¢çš„ç¨‹å¼ç¢¼æ™‚ï¼Œå°±æœƒé€²è¡Œå–®æ…‹åŒ–ã€‚ä¸Šé¢çš„å‹æ…‹åˆ†åˆ¥æ˜¯ i32 èˆ‡ f64ï¼Œè€Œç·¨è­¯å™¨æœƒè‡ªå‹•ç”¢ç”Ÿ Option_i32 å’Œ Option_f64 çš„çµæ§‹é«” ( ç·¨è­¯å™¨å¯¦éš›çš„åç¨±èˆ‡é€™é‚Šçš„ä¸åŒ )ï¼š\nenum Option_i32 { Some(i32), None, } enum Option_f64 { Some(f64), None, } fn main() { let integer = Option_i32::Some(5); let float = Option_f64::Some(5.0); } å› æ­¤ï¼Œä½¿ç”¨æ³›å‹çš„æ™‚å€™ï¼Œç¨‹å¼åœ¨åŸ·è¡Œéšæ®µå®Œå…¨ä¸éœ€è¦ä½¿ç”¨é¡å¤–çš„é‹ç®—è³‡æºå»é€²è¡Œå‹åˆ¥çš„æª¢æŸ¥ï¼Œå› ç‚ºé€™äº›å·¥ä½œéƒ½åœ¨ç·¨è­¯æœŸé–“è‡ªå‹•å®Œæˆäº†ã€‚\nçµè«– åœ¨ TypeScript è£¡ä¹Ÿæœ‰æ³›å‹çš„æ©Ÿåˆ¶ï¼Œæ‰€ä»¥å­¸ç¿’èµ·ä¾†ä¸¦ä¸é‚£éº¼åƒåŠ›ã€‚æ³›å‹å°±æ˜¯ç‚ºäº†è§£æ±ºé€™ç¨®ä¸åŒå‹åˆ¥ä½†æ˜¯ç¨‹å¼ç¢¼é‡è¤‡çš„æƒ…æ³ï¼ŒåŠ ä¸Šä¸‹å€‹ç« ç¯€æœƒæåˆ°çš„ç‰¹å¾µ ( trait ) ä¾†é™å®šå“ªç¨®å‹åˆ¥èƒ½ä½¿ç”¨ã€‚\nå¼•ç”¨ æ³›å‹è³‡æ–™å‹åˆ¥ ","permalink":"https://et860525.github.io/posts/rust-generics/","summary":"\u003cp\u003eæ³›å‹ ( generics )ï¼Œå¯¦éš›å‹åˆ¥æˆ–å±¬æ€§çš„æŠ½è±¡è¡¨ç¤ºã€‚èˆ‰ä¾‹ä¾†èªªï¼Œ\u003ccode\u003eString\u003c/code\u003e å’Œ \u003ccode\u003ei32\u003c/code\u003e é€™å…©å€‹ä¸åŒå‹åˆ¥çš„è³‡æ–™éƒ½å¯ä»¥è¢«å­˜åˆ° \u003ca href=\"https://doc.rust-lang.org/std/vec/struct.Vec.html\"\u003eVec çµæ§‹é«”\u003c/a\u003eå»ºç«‹çš„å¯¦ä¾‹ä¸­ï¼Œä¸éœ€è¦é‡å°å‹åˆ¥ä¾†åšåˆ†åˆ¥ï¼Œåªè¦ä½¿ç”¨Â \u003ccode\u003eVec\u0026lt;String\u0026gt;\u003c/code\u003eÂ æˆ–Â \u003ccode\u003eVec\u0026lt;i32\u0026gt;\u003c/code\u003eï¼Œé€™æ˜¯å› ç‚ºÂ \u003ccode\u003eVec\u003c/code\u003eÂ çµæ§‹é«”ä½¿ç”¨äº†æ³›å‹ã€‚\u003c/p\u003e\n\u003cp\u003eæ³›å‹å°±æ˜¯Â \u003cstrong\u003eåƒæ•¸å¤šå‹ ( parametric polymorphism )\u003c/strong\u003eï¼Œåœ¨å®šç¾©å‹åˆ¥æˆ–å‡½æ•¸çš„æ™‚å€™ä¸å»æ˜ç¢ºæŒ‡å®šå…·é«”çš„å‹åˆ¥ï¼Œè€Œæ˜¯ä»¥åƒæ•¸çš„å½¢å¼ä¾†å‚³å…¥å‹åˆ¥ï¼Œé€™å¯ä»¥è®“ç¨‹å¼è¨­è¨ˆæ›´ç‚ºå½ˆæ€§ã€‚\u003c/p\u003e\n\u003cp\u003eä»¥ä¸‹å…ˆä¾†çœ‹æ³›å‹åœ¨å„å€‹åœ°æ–¹ä¸­å¦‚ä½•å®šç¾©ã€‚\u003c/p\u003e","title":"Rust: æ³›å‹( Generics )"},{"content":"åœ¨ä¸€é–‹å§‹æ’°å¯«æ–‡ç« æ™‚ï¼Œæœ¬ä¾†æƒ³ä»¥å¯«æ¯”è¼ƒä¹…çš„ TypeScript ä¾†åšéƒ¨è½æ ¼çš„é–‹é ­æ–‡ç« ï¼Œä½†åœ¨éå¹´å‰æ¥è§¸åˆ° Rust é€™å€‹ç¨‹å¼èªè¨€ï¼Œå°±é †å‹¢æŠŠæœ€è¿‘å­¸åˆ°çš„æ±è¥¿æ”¾ä¸Šä¾†ã€‚ç­‰åˆ°æŠŠåœ¨ TypeScript é‡åˆ°çš„å•é¡Œæ•´ç†ä¸€ä¸‹å†å¯«æˆä¸€å€‹ç³»åˆ—æ”¾ä¸Šä¾†ã€‚\næ‰€æœ‰æ¬Š ( ownership ) æ˜¯ Rust ç”¨ä¾†Â ç®¡ç†ç¨‹å¼è¨˜æ†¶é«”çš„ä¸€ç³»åˆ—è¦å‰‡ï¼Œè®“ Rust ä¸éœ€è¦åƒåœ¾å›æ”¶ ( Garbage collection ) å°±å¯ä»¥ä¿éšœè¨˜æ†¶é«”çš„å®‰å…¨ã€‚\næ‰€æœ‰ç¨‹å¼éƒ½éœ€è¦åœ¨åŸ·è¡Œæ™‚ç®¡ç†å®ƒå€‘ä½¿ç”¨è¨˜æ†¶é«”çš„æ–¹å¼ï¼Œé€™è£¡æœ‰å¸¸è¦‹çš„å…©ç¨®ï¼š\nèªè¨€æœ¬èº«å°±æœ‰åƒåœ¾å›æ”¶æ©Ÿåˆ¶ï¼Œåœ¨ç¨‹å¼åŸ·è¡Œæ™‚ä¸æ–·å°‹æ‰¾ä¸å†ä½¿ç”¨çš„è¨˜æ†¶é«” é–‹ç™¼è€…å¿…é ˆè¦ªè‡ªåˆ†é…å’Œé‡‹æ”¾è¨˜æ†¶é«” è€Œ Rust é¸æ“‡ç¬¬ä¸‰ç¨®æ–¹å¼ï¼šè¨˜æ†¶é«”ç”±æ‰€æœ‰æ¬Šç³»çµ±ç®¡ç†ï¼Œç·¨è­¯å™¨æœƒåœ¨ç·¨è­¯æ™‚åŠ ä¸Šä¸€äº›è¦å‰‡æª¢æŸ¥ï¼Œå¦‚æœæœ‰é•è¦ï¼Œç¨‹å¼å°±ç„¡æ³•ç·¨è­¯ã€‚\næ‰€æœ‰æ¬Šçš„è¦å‰‡å®Œå…¨ä¸æœƒé™ä½åŸ·è¡Œç¨‹å¼çš„é€Ÿåº¦\nå †ç–Š ( Stack ) èˆ‡å †ç© ( Heap ) å †ç–Šèˆ‡å †ç©éƒ½æ˜¯æä¾›ç¨‹å¼ç¢¼åœ¨åŸ·è¡Œæ™‚èƒ½å¤ ä½¿ç”¨çš„è¨˜æ†¶é«”éƒ¨åˆ†ï¼Œä½†çµ„æˆçš„æ–¹å¼ä¸ä¸€æ¨£ã€‚\nå †ç–Š ( Stack ) æœƒæŒ‰ç…§é †åºä¾åºæ’åˆ—å®ƒå€‘ï¼Œä¸¦ä»¥ç›¸åé †åºç§»é™¤ï¼Œé€™ä¹Ÿç¨±ä¹‹ç‚º å¾Œé€²å…ˆå‡º ( last in, first out )ã€‚æ‰€æœ‰åœ¨å †ç–Šä¸Šçš„è³‡æ–™éƒ½å¿…é ˆæ˜¯å·²çŸ¥çš„å›ºå®šå¤§å°ï¼Œåœ¨ç·¨è­¯æœŸé–“å±¬æ–¼æœªçŸ¥æˆ–å¯èƒ½è®Šæ›´å¤§å°çš„è³‡æ–™å‰‡å¿…é ˆå„²å­˜åœ¨æ–¼å †ç©ã€‚\næƒ³åƒå †ç–Šæ˜¯ç›¤å­ï¼Œç•¶åŠ å…¥ç›¤å­æ™‚åªèƒ½ç–Šåœ¨æœ€ä¸Šæ–¹ï¼Œæƒ³è¦æ‹¿èµ°ç›¤å­ä¹Ÿåªèƒ½æ‹¿æœ€ä¸Šé¢çš„ç›¤å­ï¼Œæƒ³å¾ä¸­é–“æˆ–æœ€ä¸‹é¢æ’å…¥æˆ–æ‹¿èµ°ç›¤å­éƒ½ä¸è¡Œã€‚\nå †ç© ( Heap ) ç›¸æ¯”å †ç–Šå°±æ²’æœ‰çµ„ç¹”ï¼Œç•¶è³‡æ–™æ”¾é€²å †ç©æ™‚ï¼Œè¨˜æ†¶é«”åˆ†é…å™¨ ( memory allocator )æœƒæ‰¾åˆ°ä¸€å¡Šå¤ å¤§çš„ç©ºä½ï¼Œä¸¦æ¨™è¨˜å·²å ç”¨ï¼Œç„¶å¾Œå›å‚³ä¸€å€‹æŒ‡æ¨™ ( pointer ) æŒ‡å‘è©²ä½å€ã€‚é€™ä¸€æ•´å€‹éç¨‹ç¨±ä¹‹ç‚º å †ç©ä¸Šåˆ†é… ( allocating on the heap ) æˆ–ç°¡ç¨±ç‚ºåˆ†é…ã€‚ä¹Ÿå› ç‚ºæŒ‡æ¨™æ˜¯å›ºå®šçš„å¤§å°ï¼Œå®ƒå¯ä»¥è¢«å­˜åœ¨å †ç–Šä¸Šï¼Œç•¶éœ€è¦å­˜å–å¯¦éš›çš„è³‡æ–™æ™‚ï¼Œå°±é€éæŒ‡æ¨™å»ç²å¾—å³å¯ã€‚\nè³‡æ–™åœ¨å †ç–Šèˆ‡å †ç©çš„æ¯”è¼ƒï¼š\nå°‡è³‡æ–™æ¨å…¥å †ç–Šæœƒæ¯”å †ç©åˆ†é…é‚„å¿«ï¼Œå› ç‚ºåˆ†é…å™¨ä¸ç”¨å»å°‹æ‰¾ç©ºä½ï¼Œå…¶ä½ç½®æ°¸é åœ¨å †ç–Šçš„æœ€ä¸Šæ–¹ã€‚å †ç©å°±éœ€è¦æ¯”è¼ƒå¤šçš„æ­¥é©Ÿï¼Œåˆ†é…å™¨å¿…é ˆè¦å…ˆæ‰¾åˆ°ä¸€å€‹è¶³å¤ çš„ç©ºä½ï¼Œä¸¦åšç´€éŒ„ç‚ºä¸‹ä¸€æ¬¡åˆ†é…åšæº–å‚™ã€‚\nç²å¾—è³‡æ–™çš„æ™‚é–“ä¹Ÿæ˜¯å †ç–Šæœ€å¿«ï¼Œå› ç‚ºå †ç©å¿…é ˆè¦é€éæŒ‡æ¨™æ‰èƒ½æ‰¾åˆ°ã€‚å¦‚æœè™•ç†å™¨èˆ‡è¨˜æ†¶é«”é–“è·³è½‰çš„æ™‚é–“è¶Šå°‘ï¼Œå‰‡é€Ÿåº¦å°±è¶Šå¿«ã€‚\nç†è§£æ‰€æœ‰æ¬Šä¸»è¦å°±æ˜¯ç‚ºäº†ç®¡ç†å †ç©ã€‚\næ‰€æœ‰æ¬Šè¦å‰‡ Rust ä¸­æ¯å€‹æ•¸å€¼éƒ½æœ‰å€‹æ“æœ‰è€… ( owner )ã€‚ åŒæ™‚é–“åªèƒ½æœ‰ä¸€å€‹æ“æœ‰è€…ã€‚ ç•¶æ“æœ‰è€…é›¢é–‹ä½œç”¨åŸŸ ( scope ) æ™‚ï¼Œæ•¸å€¼å°±æœƒè¢«ä¸Ÿæ£„ã€‚ ä½œç”¨åŸŸ ( scope ) fn main() { { // s åœ¨æ­¤è™•ç„¡æ•ˆï¼Œå› ç‚ºå®ƒé‚„æ²’å®£å‘Š let s = \u0026#34;hello\u0026#34;; // s åœ¨æ­¤é–‹å§‹è¦–ç‚ºæœ‰æ•ˆ // ä½¿ç”¨ s } // æ­¤ä½œç”¨åŸŸçµæŸï¼Œ s ä¸å†æœ‰æ•ˆ } å…©å€‹é‡è¦çš„æ™‚é–“é»ï¼š\nç•¶Â sÂ é€²å…¥ä½œç”¨åŸŸæ™‚ï¼Œå®ƒæ˜¯æœ‰æ•ˆçš„ã€‚ å®ƒæŒçºŒè¢«è¦–ç‚ºæœ‰æ•ˆç›´åˆ°å®ƒé›¢é–‹ä½œç”¨åŸŸç‚ºæ­¢ã€‚ è¨˜æ†¶é«”èˆ‡åˆ†é… è€Œå°æ–¼Â StringÂ å‹åˆ¥ä¾†èªªï¼Œç‚ºäº†è¦èƒ½å¤ æ”¯æ´å¯è®Šæ€§Â (æ”¹è®Šæ–‡å­—é•·åº¦å¤§å°)ï¼Œæˆ‘å€‘éœ€è¦åœ¨å †ç© ( Heap ) ä¸Šåˆ†é…ä¸€å¡Šç·¨è­¯æ™‚æœªçŸ¥å¤§å°çš„è¨˜æ†¶é«”ä¾†å„²å­˜é€™æ¨£çš„å…§å®¹ï¼š\nè¨˜æ†¶é«”åˆ†é…å™¨å¿…é ˆåœ¨åŸ·è¡Œæ™‚è«‹æ±‚è¨˜æ†¶é«” æˆ‘å€‘ä¸å†éœ€è¦é€™å€‹Â StringÂ æ™‚ï¼Œæˆ‘å€‘éœ€è¦ä»¥æŸç¨®æ–¹æ³•å°‡æ­¤è¨˜æ†¶é«”é‚„çµ¦åˆ†é…å™¨ ç¬¬ä¸€éƒ¨åˆ†ï¼Œç•¶å‘¼å«Â String::fromÂ ï¼Œä»–æœƒè«‹æ±‚åˆ†é…ä¸€å¡Šå®ƒéœ€è¦çš„è¨˜æ†¶é«”ï¼Œé€™åœ¨å…¶ä»–ç¨‹å¼èªè¨€éƒ½ä¸€æ¨£ã€‚\nç¬¬äºŒéƒ¨åˆ†ï¼Œåœ¨æ“æœ‰åƒåœ¾å›æ”¶æ©Ÿåˆ¶(garbage collector, GC)Â çš„èªè¨€ä¸­ï¼ŒGC æœƒè¿½è¹¤ä¸¦æ¸…ç†ä¸å†ä½¿ç”¨çš„è¨˜æ†¶é«”ã€‚æ²’æœ‰ GC çš„è©±ï¼Œå°±å¿…é ˆè‡ªå·±å»è­˜åˆ¥å“ªäº›è¨˜æ†¶é«”ä¸å†ä½¿ç”¨ï¼Œä¸¦ä¸”é‡‹æ”¾å®ƒå€‘ã€‚å¦‚æœå¿˜è¨˜é‡‹æ”¾æœƒé€ æˆè¨˜æ†¶é«”çš„æµªè²»ï¼Œå¤ªæ—©é‡‹æ”¾å‰‡æœƒæ‹¿åˆ°ç„¡æ•ˆçš„è®Šæ•¸ï¼Œå¦‚æœé‡‹æ”¾äº†å…©æ¬¡ï¼Œå°±æœƒé€ æˆç¨‹å¼éŒ¯èª¤ã€‚\nRust çš„æ–¹æ³•æ˜¯ï¼Œç•¶è¨˜æ†¶é«”åœ¨æ“æœ‰å®ƒçš„è®Šæ•¸é›¢é–‹ä½œç”¨åŸŸæ™‚å°±æœƒè‡ªå‹•é‡‹æ”¾ï¼š\nfn main() { { let s = String::from(\u0026#34;hello\u0026#34;); // s åœ¨æ­¤é–‹å§‹è¦–ç‚ºæœ‰æ•ˆ // ä½¿ç”¨ s } // æ­¤ä½œç”¨åŸŸçµæŸ // s ä¸å†æœ‰æ•ˆ } ç•¶Â sÂ é›¢é–‹ä½œç”¨åŸŸï¼ŒStringÂ æ‰€éœ€è¦çš„è¨˜æ†¶é«”é‡‹æ”¾å›åˆ†é…å™¨ã€‚ç•¶é›¢é–‹ä½œç”¨åŸŸï¼ŒRust æœƒå¹«æˆ‘å€‘å‘¼å«ä¸€å€‹ç‰¹æ®Šå‡½å¼Â dropÂ ä¾†é‡‹æ”¾è¨˜æ†¶é«”ã€‚\nè®Šæ•¸èˆ‡è³‡æ–™äº’å‹•çš„æ–¹å¼ï¼šç§»å‹•ï¼ˆMoveï¼‰ fn main() { let x = 5; let y = x; } ä¸€èˆ¬ä¾†èªªï¼Œx å–å¾—æ•¸å€¼ 5ï¼Œç„¶å¾Œ copy ä¸€ä»½çµ¦ yã€‚\nä½†åœ¨ String çš„ç‰ˆæœ¬ï¼Œå°±ä¸åªæ˜¯æ‹·è²é‚£éº¼ç°¡å–®\nfn main() { let s1 = String::from(\u0026#34;hello\u0026#34;); let s2 = s1; println!(\u0026#34;{}, world!\u0026#34;, s1); } é€™å°±è¦å…ˆäº†è§£ String çš„æ¶æ§‹ï¼Œä¸€å€‹ String ç”±ä¸‰å€‹éƒ¨åˆ†çµ„æˆï¼š\næŒ‡å‘å„²å­˜å­—ä¸²å…§å®¹è¨˜æ†¶é«”çš„æŒ‡æ¨™ å®ƒçš„é•·åº¦ï¼šæ˜¯ String å…§å®¹åœ¨è¨˜æ†¶é«”ä»¥ä½å…ƒçµ„ç‚ºå–®ä½æ‰€ä½”ç”¨çš„å¤§å° å®ƒçš„å®¹é‡ï¼šæ˜¯ StringÂ å¾åˆ†é…å™¨ä»¥ä½å…ƒçµ„ç‚ºå–®ä½å–å¾—çš„ç¸½è¨˜æ†¶é«”é‡ æ‰€ä»¥å°‡Â s1Â è³¦å€¼çµ¦Â s2ï¼ŒStringÂ çš„è³‡æ–™æœƒè¢«æ‹·è²ï¼Œä¸éé€™è£¡æŒ‡çš„æ˜¯æ‹·è²å †ç–Šä¸Šçš„æŒ‡æ¨™ã€é•·åº¦å’Œå®¹é‡ã€‚\nå¦‚æœ Rust ç›´æ¥æ‹·è²å †ç©çš„è³‡æ–™ï¼Œs2 = s1Â çš„å‹•ä½œèŠ±è²»æœƒè®Šå¾—éå¸¸æ˜‚è²´ï¼Œç•¶å †ç©ä¸Šçš„è³‡æ–™éå¸¸é¾å¤§æ™‚ï¼Œæ˜¯ååˆ†å½±éŸ¿æ•ˆèƒ½çš„ã€‚\nå…ˆå‰æœ‰æåˆ°ç•¶è®Šæ•¸é›¢é–‹ä½œç”¨åŸŸæ™‚ï¼ŒRust æœƒè‡ªå‹•å‘¼å« drop å‡½å¼ä¾†æ¸…ç†å †ç©ä¸Šçš„è³‡æ–™ã€‚è€Œç•¶ s2 èˆ‡ s1 é›¢é–‹ä½œç”¨åŸŸæ™‚ï¼Œå®ƒå€‘éƒ½æœƒå˜—è©¦é‡‹æ”¾ç›¸åŒçš„è¨˜æ†¶é«”ï¼Œé€™è¢«ç¨±ç‚º é›™é‡é‡‹æ”¾ ( double free )ï¼Œé‡‹æ”¾è¨˜æ†¶é«”å…©æ¬¡å¯èƒ½æœƒå°è‡´è¨˜æ†¶é«”æå£ï¼Œé€²è€Œé€ æˆå®‰å…¨æ¼æ´ã€‚\næ‰€ä»¥ç‚ºäº†ä¿éšœè¨˜æ†¶é«”å®‰å…¨ï¼Œlet s2 = s1; å¾Œ s1 å°±ä¸å†æœ‰æ•ˆï¼Œæ‰€ä»¥åœ¨ s2 å»ºç«‹å¾Œå†ä½¿ç”¨ s1 å°±æœƒç„¡æ³•åŸ·è¡Œï¼š\nlet s1 = String::from(\u0026#34;hello\u0026#34;); let s2 = s1; println!(\u0026#34;{}, world!\u0026#34;, s1); Rust æœƒè·³å‡ºéŒ¯èª¤é˜²æ­¢ä½ åŸ·è¡Œï¼š\n$ cargo run Compiling ownership v0.1.0 (file:///projects/ownership) error[E0382]: borrow of moved value: `s1` --\u0026gt; src/main.rs:5:28 | 2 | let s1 = String::from(\u0026#34;hello\u0026#34;); | -- move occurs because `s1` has type `String`, which does not implement the `Copy` trait 3 | let s2 = s1; | -- value moved here 4 | 5 | println!(\u0026#34;{}, world!\u0026#34;, s1); | ^^ value borrowed here after move | = note: this error originates in the macro `$crate::format_args_nl` which comes from the expansion of the macro `println` (in Nightly builds, run with -Z macro-backtrace for more info) For more information about this error, try `rustc --explain E0382`. error: could not compile `ownership` due to previous error è®Šæ•¸èˆ‡è³‡æ–™äº’å‹•çš„æ–¹å¼ï¼šå…‹éš†ï¼ˆCloneï¼‰ å¦‚æœéœ€è¦æ·±æ‹·è² ( deep copy )çš„è©±ï¼Œä½¿ç”¨ cloneï¼š\nfn main() { let s1 = String::from(\u0026#34;hello\u0026#34;); let s2 = s1.clone(); println!(\u0026#34;s1 = {}, s2 = {}\u0026#34;, s1, s2); } é€™æ¨£ s1 èˆ‡ s2 éƒ½èƒ½ä½¿ç”¨ã€‚\nåªåœ¨å †ç–Šä¸Šçš„è³‡æ–™ï¼šæ‹·è²ï¼ˆCopyï¼‰ fn main() { let x = 5; let y = x; println!(\u0026#34;x = {}, y = {}\u0026#34;, x, y); } Q: é‚£ç‚ºä»€éº¼ä¸Šé¢çš„ç¨‹å¼ç¢¼æœƒæˆç«‹ï¼Ÿæ²’æœ‰å‘¼å«Â cloneï¼Œä½†Â xÂ å»ä»æ˜¯æœ‰æ•ˆçš„ï¼Œæ²’æœ‰ç§»å‹•åˆ°Â yã€‚\nA: å› ç‚ºåƒæ•´æ•¸é€™æ¨£çš„å‹åˆ¥åœ¨ç·¨è­¯æ™‚æ˜¯å·²çŸ¥å¤§å°ï¼Œæ‰€ä»¥åªæœƒå­˜åœ¨åœ¨å †ç–Šä¸Šã€‚\nRust æœ‰å€‹ç‰¹åˆ¥çš„æ¨™è¨˜å«åšÂ CopyÂ ç‰¹å¾µï¼ˆtraitï¼‰å¯ä»¥ç”¨åœ¨æ¨™è¨˜åƒæ•´æ•¸é€™æ¨£å­˜åœ¨å †ç–Šä¸Šçš„å‹åˆ¥ã€‚å¦‚æœä¸€å€‹å‹åˆ¥æœ‰å¯¦ä½œ ( implement ) DropÂ ç‰¹å¾µçš„è©±ï¼ŒRust ä¸æœƒå…è¨±æˆ‘å€‘è®“æ­¤å‹åˆ¥æ“æœ‰Â CopyÂ ç‰¹å¾µã€‚\nå“ªäº›å‹åˆ¥æœ‰å¯¦ä½œÂ CopyÂ ç‰¹å¾µå‘¢ï¼ŸåŸºæœ¬åŸå‰‡æ˜¯ä»»ä½•ç°¡å–®åœ°ç´”é‡æ•¸å€¼éƒ½å¯ä»¥å¯¦ä½œÂ Copy\næ‰€æœ‰æ•´æ•¸å‹åˆ¥åƒæ˜¯Â u32ã€‚ å¸ƒæ—å‹åˆ¥Â boolï¼Œå®ƒåªæœ‰æ•¸å€¼Â trueÂ èˆ‡Â falseã€‚ æ‰€æœ‰æµ®é»æ•¸å‹åˆ¥åƒæ˜¯Â f64ã€‚ å­—å…ƒå‹åˆ¥Â charã€‚ å…ƒçµ„ï¼Œä¸éåŒ…å«çš„å‹åˆ¥ä¹Ÿéƒ½è¦æœ‰å¯¦ä½œÂ CopyÂ æ‰è¡Œã€‚æ¯”å¦‚Â (i32, i32)Â å°±æœ‰å¯¦ä½œÂ Copyï¼Œä½†Â (i32, String)Â å‰‡ç„¡ã€‚ æ‰€æœ‰æ¬Šèˆ‡å‡½å¼ å‚³éæ•¸å€¼çµ¦å‡½å¼çš„æ–¹å¼å’Œè³¦å€¼çµ¦è®Šæ•¸æ˜¯é¡ä¼¼çš„ã€‚\nfn main() { let s = String::from(\u0026#34;hello\u0026#34;); // s é€²å…¥ä½œç”¨åŸŸ takes_ownership(s); // s çš„å€¼é€²å…¥å‡½å¼ // æ‰€ä»¥ s ä¹Ÿåœ¨æ­¤ç„¡æ•ˆ let x = 5; // x é€²å…¥ä½œç”¨åŸŸ makes_copy(x); // x æœ¬è©²ç§»å‹•é€²å‡½å¼è£¡ // ä½† i32 æœ‰ Copyï¼Œæ‰€ä»¥ x å¯ç¹¼çºŒä½¿ç”¨ } fn takes_ownership(some_string: String) { // some_string é€²å…¥ä½œç”¨åŸŸ println!(\u0026#34;{}\u0026#34;, some_string); } // some_string åœ¨æ­¤é›¢é–‹ä½œç”¨åŸŸä¸¦å‘¼å« `drop` // ä½”ç”¨çš„è¨˜æ†¶é«”è¢«é‡‹æ”¾ fn makes_copy(some_integer: i32) { // some_integer é€²å…¥ä½œç”¨åŸŸ println!(\u0026#34;{}\u0026#34;, some_integer); } // some_integer åœ¨æ­¤é›¢é–‹ä½œç”¨åŸŸï¼Œæ²’æœ‰ä»»ä½•å‹•ä½œç™¼ç”Ÿ å¦‚æœå‘¼å«Â takes_ownershipÂ å¾Œä½¿ç”¨Â sï¼ŒRust æœƒæ‹‹å‡ºç·¨è­¯æ™‚æœŸéŒ¯èª¤ã€‚\nå›å‚³å€¼èˆ‡ä½œç”¨åŸŸ è®Šæ•¸çš„æ‰€æœ‰æ¬Šæ¯æ¬¡éƒ½æœƒéµç…§ç›¸åŒçš„æ¨¡å¼ï¼Œåªè¦è³¦å€¼çµ¦å…¶ä»–è®Šæ•¸å°±æœƒç§»å‹•ã€‚ç•¶æœ‰å †ç©çš„è®Šæ•¸é›¢é–‹ä½œç”¨åŸŸï¼Œè©²å€¼å°±æœƒè¢« drop æ¸…é™¤ï¼Œé™¤éè³‡æ–™çš„æ‰€æœ‰æ¬Šè¢«è½‰ç§»åˆ°å…¶ä»–è®Šæ•¸ã€‚\nä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ä¾†å›å‚³åƒæ•¸çš„æ‰€æœ‰å€¼ï¼š\nfn main() { let s1 = String::from(\u0026#34;hello\u0026#34;); let (s2, len) = calculate_length(s1); // s1 ç§»å…¥ calculate_length // å°‡æ‰€æœ‰æ¬Šé€éå›å‚³çµ¦ s2 println!(\u0026#34;\u0026#39;{}\u0026#39; çš„é•·åº¦ç‚º {}ã€‚\u0026#34;, s2, len); } fn calculate_length(s: String) -\u0026gt; (String, usize) { let length = s.len(); // len() å›å‚³ String çš„é•·åº¦ (s, length) } ä»¥ä¸Šæ˜¯æ­£ç¢ºçš„åšæ³•ï¼Œä½†å¦‚æœè¦é‡è¤‡ä½¿ç”¨é€™å€‹å€¼ï¼Œæ¯ä¸€æ¬¡éƒ½è¦å‚³é€²å‚³å‡ºå°±å¾ˆéº»ç…©ã€‚æ‰€ä»¥ Rust é‚„æœ‰æä¾›ä¸€å€‹åœ¨ä¸ç§»è½‰æ‰€æœ‰æ¬Šçš„æƒ…æ³ä¸‹ä½¿ç”¨æ•¸å€¼ï¼Œç¨±ç‚º å¼•ç”¨ ( references )ã€‚\nå¼•ç”¨èˆ‡å€Ÿç”¨ å¼•ç”¨ ( references )Â å°±åƒæ˜¯æŒ‡å‘æŸå€‹åœ°å€çš„æŒ‡æ¨™ï¼Œæˆ‘å€‘å¯ä»¥è¿½è¹¤å­˜å–åˆ°è©²è™•å„²å­˜çš„è³‡è¨Šï¼Œè€Œè®“è©²åœ°å€è¢«å…¶ä»–è®Šæ•¸æ‰€æ“æœ‰ï¼Œèˆ‡æŒ‡æ¨™ä¸åŒçš„æ˜¯ï¼Œå¼•ç”¨ä¿è­‰æ‰€æŒ‡å‘çš„ç‰¹å®šå‹åˆ¥çš„æ•¸å€¼ä¸€å®šæ˜¯æœ‰æ•ˆçš„ã€‚\nfn main() { let s1 = String::from(\u0026#34;hello\u0026#34;); let len = calculate_length(\u0026amp;s1); println!(\u0026#34;\u0026#39;{}\u0026#39; çš„é•·åº¦ç‚º {}ã€‚\u0026#34;, s1, len); } fn calculate_length(s: \u0026amp;String) -\u0026gt; usize { s.len() } \u0026amp;s1Â èªæ³•è®“æˆ‘å€‘å¯ä»¥å»ºç«‹ä¸€å€‹æŒ‡å‘Â s1Â æ•¸å€¼çš„å¼•ç”¨ï¼Œä½†ä¸æœƒæ“æœ‰å®ƒã€‚ä¹Ÿå› ç‚ºå®ƒæ²’æœ‰æ‰€æœ‰æ¬Šï¼Œå®ƒæ‰€æŒ‡å‘çš„è³‡æ–™åœ¨å¼•ç”¨ä¸å†ä½¿ç”¨å¾Œä¸¦ä¸æœƒè¢«ä¸Ÿæ£„ã€‚\nå»ºç«‹å¼•ç”¨é€™æ¨£çš„å‹•ä½œå«åšå€Ÿç”¨ï¼ˆborrowingï¼‰ã€‚å°±åƒç¾å¯¦ä¸–ç•Œä¸€æ¨£ï¼Œå¦‚æœæœ‰äººæ“æœ‰ä¸€å€‹æ±è¥¿ï¼Œä»–å¯ä»¥å€Ÿç”¨çµ¦ä½ ã€‚ç•¶ä½ ä½¿ç”¨å®Œå¾Œï¼Œä½ å°±é‚„çµ¦ä»–ï¼Œä½ ä¸¦ä¸æ“æœ‰å®ƒã€‚\nä»¥ä¸‹ç¨‹å¼ç¢¼èƒ½ä¸èƒ½åŸ·è¡Œï¼Ÿ\nfn main() { let s = String::from(\u0026#34;hello\u0026#34;); change(\u0026amp;s); } fn change(some_string: \u0026amp;String) { some_string.push_str(\u0026#34;, world\u0026#34;); } ç­”æ¡ˆæ˜¯ä¸è¡Œï¼Œå› ç‚ºå®ƒåªæ˜¯å€Ÿç”¨ï¼Œæ‰€ä»¥ä¸èƒ½æ”¹è®Šå¼•ç”¨çš„å€¼ã€‚\nå¯è®Šå¼•ç”¨ å¦‚æœè¦è®“ä¸Šæ–¹çš„ç¨‹å¼ç¢¼ï¼Œæ”¹è®Šå¼•ç”¨çš„å€¼ï¼š\nfn main() { let mut s = String::from(\u0026#34;hello\u0026#34;); change(\u0026amp;mut s); } fn change(some_string: \u0026amp;mut String) { some_string.push_str(\u0026#34;, world\u0026#34;); } å…ˆå°‡ s åŠ å…¥ mut è®“ä»–èƒ½è¢«æ”¹è®Š changeÂ å‡½å¼çš„åœ°æ–¹å»ºç«‹äº†ä¸€å€‹å¯è®Šå¼•ç”¨Â \u0026amp;mut s change å‡½å¼çš„æ–°ç°½ç« ç‚º some_string: \u0026amp;mut String ä¾†æ¥æ”¶é€™å€‹å¯è®Šå¼•ç”¨ å¯è®Šå¼•ç”¨æœ‰ä¸€å€‹å¤§é™åˆ¶ï¼šå°ç›¸åŒçš„è®Šæ•¸å¯è®Šå¼•ç”¨åªèƒ½æœ‰ä¸€å€‹ã€‚å¦‚æœå˜—è©¦å»ºç«‹å…©å€‹å¯è®Šå¼•ç”¨å°±æœƒå¤±æ•—ï¼š\nfn main() { let mut s = String::from(\u0026#34;hello\u0026#34;); let r1 = \u0026amp;mut s; let r2 = \u0026amp;mut s; println!(\u0026#34;{}, {}\u0026#34;, r1, r2); } éŒ¯èª¤è³‡è¨Šï¼š\n$ cargo run Compiling ownership v0.1.0 (file:///projects/ownership) error[E0499]: cannot borrow `s` as mutable more than once at a time --\u0026gt; src/main.rs:5:14 | 4 | let r1 = \u0026amp;mut s; | ------ first mutable borrow occurs here 5 | let r2 = \u0026amp;mut s; | ^^^^^^ second mutable borrow occurs here 6 | 7 | println!(\u0026#34;{}, {}\u0026#34;, r1, r2); | -- first borrow later used here For more information about this error, try `rustc --explain E0499`. error: could not compile `ownership` due to previous error é€™é …é™åˆ¶çš„å¥½è™•æ˜¯ Rust å¯ä»¥åœ¨ç·¨è­¯æ™‚æœŸå°±é˜²æ­¢è³‡æ–™ç«¶çˆ­ ( data races )ã€‚å®ƒæœƒç”±ä»¥ä¸‹ä¸‰ç¨®è¡Œç‚ºå¼•ç™¼ï¼š\nåŒæ™‚æœ‰å…©å€‹ä»¥ä¸Šçš„æŒ‡æ¨™å­˜å–åŒå€‹è³‡æ–™ã€‚ è‡³å°‘æœ‰ä¸€å€‹æŒ‡æ¨™åœ¨å¯«å…¥è³‡æ–™ã€‚ æ²’æœ‰é‡å°è³‡æ–™çš„åŒæ­¥å­˜å–æ©Ÿåˆ¶ã€‚ è³‡æ–™ç«¶çˆ­æœƒé€ æˆæœªå®šç¾©è¡Œç‚º ( undefined behavior )ï¼Œè€Œä¸”åœ¨åŸ·è¡Œæ™‚ä½ é€šå¸¸æ˜¯å¾ˆé›£è¨ºæ–·ä¸¦ä¿®æ­£çš„ï¼Œè€Œ Rust èƒ½é˜»æ­¢é€™æ¨£çš„å•é¡Œï¼Œå®ƒä¸æœƒè®“æœ‰è³‡æ–™ç«¶çˆ­çš„ç¨‹å¼ç¢¼ç·¨è­¯ã€‚\nç°¡å–®ä¾†èªªï¼Œä¸è¦åŒæ™‚æ“æœ‰åŒä¸€å€‹å¼•ç”¨å°±å¯åŸ·è¡Œï¼š\nfn main() { let mut s = String::from(\u0026#34;hello\u0026#34;); { let r1 = \u0026amp;mut s; } // r1 é›¢é–‹ä½œç”¨åŸŸï¼Œæ‰€ä»¥å»ºç«‹æ–°çš„å¼•ç”¨ä¹Ÿä¸æœƒæœ‰å•é¡Œ let r2 = \u0026amp;mut s; } å¯è®Šå¼•ç”¨å’Œä¸å¯è®Šå¼•ç”¨ï¼Œä¸èƒ½åŒæ™‚ä½¿ç”¨ï¼š\nfn main() { let mut s = String::from(\u0026#34;hello\u0026#34;); let r1 = \u0026amp;s; // æ²’å•é¡Œ let r2 = \u0026amp;s; // æ²’å•é¡Œ let r3 = \u0026amp;mut s; // æœ‰å•é¡Œï¼ println!(\u0026#34;{}, {}, and {}\u0026#34;, r1, r2, r3); } é€™æ˜¯å› ç‚ºï¼Œä¸å¯è®Šå¼•ç”¨çš„ä½¿ç”¨è€…ä¸å¸Œæœ›æœ‰äººæ”¹è®Šäº†å€¼ï¼Œä¸¦é€ æˆéŒ¯èª¤ã€‚ä¸éå¤šå€‹ä¸å¯è®Šå¼•ç”¨æ˜¯æ²’å•é¡Œçš„ï¼Œå› ç‚ºå¤§å®¶éƒ½ä¸èƒ½è®Šæ›´å€¼ã€‚\nå¼•ç”¨çš„ä½œç”¨åŸŸå§‹æ–¼å®ƒè¢«å®£å‘Šçš„åœ°æ–¹ï¼Œä¸€ç›´åˆ°å®ƒæœ€å¾Œä¸€æ¬¡å¼•ç”¨è¢«ä½¿ç”¨ç‚ºæ­¢ï¼š\nfn main() { let mut s = String::from(\u0026#34;hello\u0026#34;); let r1 = \u0026amp;s; // æ²’å•é¡Œ let r2 = \u0026amp;s; // æ²’å•é¡Œ println!(\u0026#34;{} and {}\u0026#34;, r1, r2); // è®Šæ•¸ r1 å’Œ r2 å°‡ä¸å†ä½¿ç”¨ let r3 = \u0026amp;mut s; // æ²’å•é¡Œ println!(\u0026#34;{}\u0026#34;, r3); } è¿·é€”å¼•ç”¨ ( Dangling references ) æœ‰æŒ‡æ¨™çš„ç¨‹å¼èªè¨€ï¼Œå°±æœƒä¸å°å¿ƒç”¢ç”Ÿ è¿·é€”æŒ‡æ¨™ ( dangling pointer )ã€‚ç•¶è³‡æºå·²ç¶“è¢«é‡‹æ”¾ä½†æŒ‡æ¨™å»é‚„ç•™è‘—ï¼Œé€™æ¨£çš„æŒ‡æ¨™æŒ‡å‘çš„åœ°æ–¹å¾ˆå¯èƒ½å°±å·²ç¶“è¢«åˆ¥äººæ‰€æœ‰äº†ã€‚åœ¨ Rust ä¸­ç·¨è­¯å™¨æœƒä¿è­‰å¼•ç”¨çµ•ä¸æœƒæ˜¯è¿·é€”å¼•ç”¨ã€‚\nfn main() { let reference_to_nothing = dangle(); } fn dangle() -\u0026gt; \u0026amp;String { // å›å‚³ String çš„è¿·é€”å¼•ç”¨ let s = String::from(\u0026#34;hello\u0026#34;); // s æ˜¯å€‹æ–° String \u0026amp;s // æˆ‘å€‘å›å‚³ String s çš„å¼•ç”¨ } // s åœ¨æ­¤æœƒé›¢é–‹ä½œç”¨åŸŸä¸¦é‡‹æ”¾ï¼Œå®ƒçš„è¨˜æ†¶é«”å°±ä¸è¦‹äº†ã€‚ // å±éšªï¼ s æ˜¯åœ¨ dangle è£¡é¢ç”¢ç”Ÿçš„ï¼Œç•¶ dangle çµæŸ s æœƒè¢«é‡‹æ”¾ã€‚å¦‚æœå˜—è©¦å›å‚³ sï¼Œé€™å€‹å¼•ç”¨æœƒæŒ‡å‘ä¸€å€‹ç„¡æ•ˆçš„ Stringï¼Œæ‰€ä»¥ Rust ä¸æœƒè®“å®ƒç™¼ç”Ÿã€‚\nè®“ä»–å›å‚³çš„å€¼ä¸æ˜¯å¼•ç”¨å°±å¯ä»¥äº†ï¼Œé€™é‚Šç›´æ¥å›å‚³ Stringå°±å¥½ï¼š\nfn main() { let string = no_dangle(); } fn no_dangle() -\u0026gt; String { let s = String::from(\u0026#34;hello\u0026#34;); s } åˆ‡ç‰‡ (Slice) åˆ‡ç‰‡ (Slice) å¯ä»¥å¼•ç”¨ä¸€ä¸²é›†åˆçš„å…ƒç´ åˆ—ï¼Œä¸¦éå¼•ç”¨æ•´å€‹é›†åˆã€‚åˆ‡ç‰‡ä¹Ÿæ˜¯ä¸€ç¨®å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒæ²’æœ‰æ‰€æœ‰æ¬Šã€‚\nå¯«ä¸€å€‹å‡½å¼æ¥æ”¶ä¸€ä¸²ç”¨ç©ºæ ¼åˆ†é–‹å–®å­—çš„å­—ä¸²ï¼Œå¦‚ï¼šHello worldã€Good jobï¼Œä¸¦å›å‚³ç¬¬ä¸€å€‹æ‰¾åˆ°çš„å–®å­—ï¼›å¦‚æœæ²’æœ‰æ‰¾åˆ°ä»»ä½•ç©ºæ ¼ï¼Œå°±ä»£è¡¨æ•´å€‹å­—ä¸²å°±æ˜¯ä¸€å€‹å–®å­—ï¼Œä¸¦å›å‚³æ•´å€‹å­—ä¸²ã€‚\nfn first_word(s: \u0026amp;String) -\u0026gt; usize { let bytes = s.as_bytes(); for (i, \u0026amp;item) in bytes.iter().enumerate() { if item == b\u0026#39; \u0026#39; { return i; } } s.len() } fn main() { let mut s = String::from(\u0026#34;hello world\u0026#34;); let word = first_word(\u0026amp;s); // word å–å¾—æ•¸å€¼ 5 s.clear(); // é€™æœƒæ¸…ç©º Stringï¼Œé€™å°±ç­‰æ–¼ \u0026#34;\u0026#34; // word ä»ç„¶æ˜¯æ•¸å€¼ 5 ï¼Œä½†æ˜¯æˆ‘å€‘å·²ç¶“æ²’æœ‰ç›¸ç­‰æ„ç¾©çš„å­—ä¸²äº† // æ“æœ‰ 5 çš„è®Šæ•¸ word ç¾åœ¨å®Œå…¨æ²’æ„ç¾©ï¼ } let bytes = s.as_bytes();ï¼šå°‡ String è½‰æ›æˆä¸€å€‹ä½å…ƒçµ„é™£åˆ— for (i, \u0026amp;item) in bytes.iter().enumerate()ï¼šä½¿ç”¨ iter æ–¹æ³•å°ä½å…ƒå»ºç«‹ä¸€å€‹ç–Šä»£å™¨ (iterator) iter()ï¼šæ˜¯ä¸€å€‹å›å‚³é›†åˆä¸­çš„æ¯å€‹å…ƒç´ æ–¹æ³• enumerate()ï¼šå›å‚³çš„å…ƒçµ„ä¸­ç¬¬ä¸€å€‹æ˜¯ç´¢å¼•(i)ï¼Œç¬¬äºŒå€‹æ˜¯å…ƒç´ çš„å¼•ç”¨(\u0026amp;item) if item == b' ' {return i} ï¼šæ‰¾åˆ°ç©ºæ ¼å¾Œå›å‚³è©²ä½ç½®ï¼Œå¦‚æœæ²’æœ‰å°±å›å‚³æ•´å€‹å­—ä¸²é•·åº¦ ç¨‹å¼é›–ç„¶å¯ä»¥æˆåŠŸç·¨è­¯ï¼Œå¯ä»¥çœ‹åˆ° s çš„å…§å®¹èˆ‡ word æ˜¯æ²’æœ‰ç›´æ¥é—œä¿‚çš„ï¼Œæ‰€ä»¥ç•¶ s æ”¹è®Šå¾Œï¼Œç›´æ¥ä½¿ç”¨ word å»ç²å¾— s çš„å–®å­—ï¼Œå°±æœƒé€ æˆéŒ¯èª¤ï¼Œé€™ä¹Ÿå°è‡´éœ€è¦ç•™æ„ word æ˜¯ä¸æ˜¯èˆ‡ s è„«é‰¤ï¼Œè€Œé€™å€‹éº»ç…©å¯ä»¥ä½¿ç”¨ Rust çš„ å­—ä¸²åˆ‡ç‰‡(tring slice)ã€‚\nå­—ä¸²åˆ‡ç‰‡ fn main() { let s = String::from(\u0026#34;hello world\u0026#34;); let hello = \u0026amp;s[0..5]; let world = \u0026amp;s[6..11]; } åŸºæœ¬ä¸Šå°±æ˜¯ Python çš„ sliceï¼Œåªæ˜¯ç”¨å¼•ç”¨çš„æ–¹å¼\nèˆ‡å…¶å¼•ç”¨æ•´å€‹Â Stringï¼Œé€éÂ [0..5]Â ä¾†å¼•ç”¨äº†ä¸€éƒ¨åˆ†çš„ Stringã€‚\næ›´æ”¹ä¸Šæ–¹å›å‚³å­—ä¸²çš„ç¨‹å¼ï¼š\nfn first_word(s: \u0026amp;str) -\u0026gt; \u0026amp;str { let bytes = s.as_bytes(); for (i, \u0026amp;item) in bytes.iter().enumerate() { if item == b\u0026#39; \u0026#39; { return \u0026amp;s[0..i]; } } \u0026amp;s[..] } å¯ä»¥å°‡ fn first_word(s: \u0026amp;String) -\u0026gt; \u0026amp;String å¯«æˆ fn first_word(s: \u0026amp;str) -\u0026gt; \u0026amp;str\nç¾åœ¨ç·¨è­¯å™¨æœƒç¢ºä¿ String çš„å¼•ç”¨æ˜¯æœ‰æ•ˆçš„ï¼Œæ‰€ä»¥ç•¶ä½¿ç”¨ä»¥ä¸‹ç¨‹å¼ç¢¼é€²è¡Œç·¨è­¯ï¼Œå°±æœƒç›´æ¥è·³å‡ºéŒ¯èª¤ï¼š\nfn main() { let mut s = String::from(\u0026#34;hello world\u0026#34;); let word = first_word(\u0026amp;s); // word å–å¾—æ•¸å€¼ 5 s.clear(); // éŒ¯èª¤ println!(\u0026#34;ç¬¬ä¸€å€‹å–®å­—ç‚ºï¼š{}\u0026#34;, word); } $ cargo run Compiling ownership v0.1.0 (file:///projects/ownership) error[E0502]: cannot borrow `s` as mutable because it is also borrowed as immutable --\u0026gt; src/main.rs:18:5 | 16 | let word = first_word(\u0026amp;s); | -- immutable borrow occurs here 17 | 18 | s.clear(); // éŒ¯èª¤ï¼ | ^^^^^^^^^ mutable borrow occurs here 19 | 20 | println!(\u0026#34;ç¬¬ä¸€å€‹å–®å­—ç‚ºï¼š{}\u0026#34;, word); | ---- immutable borrow later used here For more information about this error, try `rustc --explain E0502`. error: could not compile `ownership` due to previous error å‡ºç¾éŒ¯èª¤æ˜¯å› ç‚ºå€Ÿç”¨çš„è¦å‰‡ï¼šç•¶å‘¼å« clear æœƒæ¸…é™¤ Stringï¼Œé€™è¡¨ç¤ºå®ƒå¿…é ˆæ˜¯å¯è®Šå¼•ç”¨ã€‚åœ¨ clear å¾Œå‘¼å« println! ï¼Œé€™æ™‚å°±æœƒç”¨åˆ° word çš„å¼•ç”¨ã€‚Rust ä¸å…è¨±åŒæ™‚å­˜åœ¨Â clearÂ çš„å¯è®Šå¼•ç”¨èˆ‡Â wordÂ çš„ä¸å¯è®Šå¼•ç”¨ï¼Œæ‰€ä»¥æœƒç·¨è­¯å¤±æ•—ã€‚é€™å°±èƒ½è®“é€™äº›éŒ¯èª¤åœ¨ç·¨è­¯æœŸé–“å°±è¢«ç™¼ç¾ï¼Œé€²è€Œä¿®æ”¹ã€‚\nçµè«– åœ¨é«˜ä¸­æ™‚æœŸæœ‰ä½¿ç”¨ Unity è£½ä½œééŠæˆ²ï¼Œç•¶æ™‚æ‰€ä½¿ç”¨çš„å°±æ˜¯ C# ç¨‹å¼èªè¨€ï¼Œå°æ–¼ GC é€™å€‹æ©Ÿåˆ¶æ˜¯ä¸é™Œç”Ÿçš„ï¼Œè€Œåˆ°äº†å¤§å­¸è½‰ç‚ºå¯«ç¶²é æ™‚ï¼ŒJavaScript ä¹Ÿæœ‰ GC çš„æ©Ÿåˆ¶ä¾†å›æ”¶è¨˜æ†¶é«”ã€‚ç¬¬ä¸€æ¬¡æ¥è§¸ Rust ç®¡ç†è¨˜æ†¶é«”çš„æ–¹æ³•ï¼Œæ‰€æœ‰æ¬Šçš„è¦å‰‡çœ‹ä¼¼é™åˆ¶å¾ˆå¤šå…¶å¯¦ç”¨èµ·ä¾†å¾ˆç›´è¦ºï¼Œä»–å¯ä»¥é é˜²å¾ˆå¤šå•é¡Œï¼Œä¾‹å¦‚: æŒ‡æ¨™æ˜¯ç©ºçš„ã€è¿·é€”æŒ‡æ¨™ç­‰ç­‰ã€‚\nå¼•ç”¨ ç†è§£æ‰€æœ‰æ¬Š ","permalink":"https://et860525.github.io/posts/rust-ownership/","summary":"\u003cp\u003eåœ¨ä¸€é–‹å§‹æ’°å¯«æ–‡ç« æ™‚ï¼Œæœ¬ä¾†æƒ³ä»¥å¯«æ¯”è¼ƒä¹…çš„ TypeScript ä¾†åšéƒ¨è½æ ¼çš„é–‹é ­æ–‡ç« ï¼Œä½†åœ¨éå¹´å‰æ¥è§¸åˆ° Rust é€™å€‹ç¨‹å¼èªè¨€ï¼Œå°±é †å‹¢æŠŠæœ€è¿‘å­¸åˆ°çš„æ±è¥¿æ”¾ä¸Šä¾†ã€‚ç­‰åˆ°æŠŠåœ¨ TypeScript é‡åˆ°çš„å•é¡Œæ•´ç†ä¸€ä¸‹å†å¯«æˆä¸€å€‹ç³»åˆ—æ”¾ä¸Šä¾†ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæ‰€æœ‰æ¬Š ( ownership )\u003c/strong\u003e æ˜¯ Rust ç”¨ä¾†Â \u003cstrong\u003eç®¡ç†ç¨‹å¼è¨˜æ†¶é«”çš„ä¸€ç³»åˆ—è¦å‰‡\u003c/strong\u003eï¼Œè®“ Rust ä¸éœ€è¦\u003ca href=\"https://zh.wikipedia.org/zh-tw/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6_(%E8%A8%88%E7%AE%97%E6%A9%9F%E7%A7%91%E5%AD%B8)\"\u003eåƒåœ¾å›æ”¶ ( Garbage collection )\u003c/a\u003e å°±å¯ä»¥ä¿éšœè¨˜æ†¶é«”çš„å®‰å…¨ã€‚\u003c/p\u003e","title":"Rust: æ‰€æœ‰æ¬Š( Ownership )"},{"content":"åœ¨åˆæœŸå»ºç«‹éƒ¨è½æ ¼æ™‚ï¼Œæœ¬ä¾†æ˜¯æƒ³ç§Ÿä¸€å°è™›æ“¬ä¸»æ©Ÿï¼Œå†æŠŠå¯«å¥½çš„ç¶²é ä¸Ÿä¸Šå»ï¼Œä¸éæœ€å¾Œé‚„æ˜¯é¸æ“‡ä½¿ç”¨ GitHub Pagesã€‚\nJekyll æ˜¯ Github å»ºè­°çš„éœæ…‹ç¶²ç«™ç”¢ç”Ÿå™¨ï¼Œä¸éåœ¨æŸ¥è©¢è³‡æ–™æ™‚ç™¼ç¾ç”± Go æ‰€å»ºæ§‹çš„ Hugoï¼Œé»é€²å»ç¶²é ä¸Šé¢å°±å¯«è‘—è‡ªå·±æ˜¯ã€Œä¸–ç•Œä¸Šæœ€å¿«çš„ç¶²ç«™æ¶è¨­æ¡†æ¶ã€ï¼Œé‚£ä¸è©¦è©¦çœ‹æ€éº¼è¡Œã€‚\nå®‰è£ Hugo Hugo æœ‰å…©ç¨®ç‰ˆæœ¬ï¼Œæ¨™æº–ç‰ˆ (standard) èˆ‡æ“´å……ç‰ˆ (extended)ï¼Œå®˜æ–¹æ¨è–¦ä½¿ç”¨ æ“´å……ç‰ˆã€‚\nä¸‹è¼‰çš„æ–¹å¼æ˜¯æ ¹æ“šè‡ªå·±çš„ä½œæ¥­ç³»çµ±ä¾†é¸æ“‡ï¼Œè€Œæˆ‘ä½¿ç”¨çš„æ˜¯ Linuxï¼Œå…¶ä»–çš„ä½œæ¥­ç³»çµ±å¯ä»¥åƒè€ƒ Hugo Installationã€‚\nå°æ–¼ Linux ç³»çµ±ï¼Œæœ€ç°¡å–®çš„æ–¹å¼å°±æ˜¯ç›´æ¥ä½¿ç”¨ Package managers ä¸‹è¼‰ï¼š\nsudo apt install hugo ä½†æ˜¯ç”¨é€™å€‹æ–¹å¼ä¸‹è¼‰çš„é€šå¸¸éƒ½ä¸æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ‰€ä»¥ Hugo é‚„æä¾› Prebuilt binaries çš„æ–¹å¼ï¼Œä¸‹è¼‰å‰è¦å…ˆç¢ºå®šç‰ˆæœ¬ (ä½¿ç”¨ç•¶ä¸‹æ˜¯ v0.109.0)ï¼š\ncd /tmp \u0026amp;\u0026amp; mkdir hugo-binary \u0026amp;\u0026amp; cd hugo-binary wget https://github.com/gohugoio/hugo/releases/download/v0.109.0/hugo_extended_0.109.0_linux-amd64.tar.gz tar -xvf hugo_extended_0.109.0_linux-amd64.tar.gz cd ../ \u0026amp;\u0026amp; rm -rf hugo-binary/ hugo version æœ€å¾Œå¦‚æœæœ‰å‡ºç¾ç‰ˆæœ¬è™Ÿå°±æ˜¯æˆåŠŸå®‰è£äº†ã€‚\nåˆå§‹åŒ–ç¶²ç«™ ä½¿ç”¨ä»¥ä¸‹å¾—æŒ‡ä»¤ä¾†å»ºç«‹å°ˆæ¡ˆçš„ç›®éŒ„ï¼š\nhugo new site my_blog é€²åˆ°è³‡æ–™å¤¾è£¡æ‰¾åˆ° config.tomlï¼Œé€™å€‹æ˜¯ Hugo çš„è¨­å®šæª”ã€‚\nå¦‚æœä½ ä¸å–œæ­¡ä½¿ç”¨ config.tomlï¼ŒHugo æœ‰æä¾› config.yaml æˆ– config.jsonï¼Œåœ¨å»ºç«‹å°ˆæ¡ˆæ™‚ä½¿ç”¨ hugo new my_project -f \u0026lt;yaml or json\u0026gt;\né¸æ“‡ä¸»é¡Œ å¯ä»¥åˆ° Hugo Themes ä¾†é¸æ“‡ä½ æƒ³è¦çš„ä¸»é¡Œï¼Œæˆ‘é€™è£¡ä½¿ç”¨ hugo-PaperModï¼š\ncd my_blog git init # åˆå§‹åŒ– Git git submodule add --depth=1 https://github.com/adityatelange/hugo-PaperMod.git themes/PaperMod git submodule update --init --recursive # needed when you reclone your repo (submodules may not get cloned automatically) æ¥è‘—å°‡ä¸»é¡Œåç¨±åŠ å…¥ config.tomlï¼š\ntheme = \u0026#34;PaperMod\u0026#34; é€šå¸¸ä¸‹è¼‰çš„ä¸»é¡Œè£¡é¢éƒ½æœƒæœ‰ exampleSite æˆ–æ˜¯å°‡å®ƒç¨ç«‹å‡ºä¾†ï¼Œéƒ½èƒ½åœ¨è©²ä¸»é¡Œçš„ Github æ‰¾åˆ°ã€‚exampleSite è£¡éƒ½æœƒæœ‰å·²ç¶“è¨­å®šå¥½çš„ config.toml å¯ä»¥ç›´æ¥å¥—ç”¨ï¼Œä¹Ÿå¯ä»¥æ ¹æ“šè‡ªå·±çš„éœ€æ±‚ä¾†è¨­å®šã€‚\nå¯ä»¥å°‡ exampleSite çš„ content è£¡çš„æª”æ¡ˆéƒ½æ”¾é€²å°ˆæ¡ˆçš„ content è£¡ï¼Œé€™å°±æ˜¯é è¨­çš„æ–‡ç« ï¼Œå¯ä»¥åœ¨é‹è¡Œç¶²ç«™æ™‚å…ˆé è¦½é¡¯ç¤ºçš„ç‹€æ…‹\né‹è¡Œç¶²ç«™ hugo server å¦‚æœæ²’æœ‰ä»»ä½•éŒ¯èª¤ï¼Œå°±å¯ä»¥åˆ° http://localhost:1313 ä¾†è§€çœ‹ç¶²ç«™ã€‚\né€™å€‹ç¶²ç«™åªé‹è¡Œåœ¨ä½ çš„é›»è…¦ä¸Šï¼Œè¦æ”¾åˆ° GitHub Pages ä¸Šæ‰èƒ½è®“å…¶ä»–äººçœ‹åˆ°\néƒ¨å±¬åˆ° GitHub Pages é¦–å…ˆï¼Œå…ˆåœ¨ Github å»ºç«‹æ–°çš„å°ˆæ¡ˆï¼Œåå­—ç‚º \u0026lt;your-account\u0026gt;.github.ioã€‚\næ ¹æ“šå®˜æ–¹æ–‡ä»¶ Host on GitHubï¼Œä½¿ç”¨ GitHub Action ä¾†éƒ¨å±¬ç¶²ç«™ï¼Œåœ¨æ ¹ç›®éŒ„ä¸‹æ–°å¢æª”æ¡ˆ .github/workflows/gh-pages.ymlï¼Œè©²æª”æ¡ˆçš„ç¨‹å¼ç¢¼ç‚ºï¼š\nname: github pages on: push: branches: - main # Set a branch that will trigger a deployment pull_request: jobs: deploy: runs-on: ubuntu-22.04 steps: - uses: actions/checkout@v3 with: submodules: true # Fetch Hugo themes (true OR recursive) fetch-depth: 0 # Fetch all history for .GitInfo and .Lastmod - name: Setup Hugo uses: peaceiris/actions-hugo@v2 with: hugo-version: \u0026#39;latest\u0026#39; # extended: true - name: Build run: hugo --minify - name: Deploy uses: peaceiris/actions-gh-pages@v3 if: github.ref == \u0026#39;refs/heads/main\u0026#39; with: github_token: ${{ secrets.GITHUB_TOKEN }} publish_dir: ./public å®Œæˆå¾Œå†æŠŠå°ˆæ¡ˆæ¨ä¸Šå»ï¼š\ngit status git add . git commit -m \u0026#34;Init my hugo blog\u0026#34; git branch -M main git remote add origin git@github.com:\u0026lt;your-account\u0026gt;/\u0026lt;your-account\u0026gt;.github.io.git git push -u origin master åˆ°è©² repo çš„ Actions å°±æœƒçœ‹åˆ°ä»¥ä¸‹ç•«é¢ï¼š\nå¦‚æœæœ‰å‡ºç¾éŒ¯èª¤ï¼Œè«‹åˆ° Repo -\u0026gt; Settings -\u0026gt; Actions -\u0026gt; General ç¢ºèª\nActions permissions è¨­å®šç‚º Allow all actions and reusable workflows Workflow permissions è¨­å®šç‚º Read and write permissions Actions å®Œæˆç·¨è­¯å¾Œï¼Œè¨­å®š Github Pages è¦ä½¿ç”¨çš„ branchï¼š\næœ€å¾Œå†åˆ° https://\u0026lt;your-account\u0026gt;.github.io/ å°±èƒ½çœ‹åˆ°è¨­å®šçš„é é¢äº†ã€‚\n","permalink":"https://et860525.github.io/posts/hugo-with-github-pages/","summary":"\u003cp\u003eåœ¨åˆæœŸå»ºç«‹éƒ¨è½æ ¼æ™‚ï¼Œæœ¬ä¾†æ˜¯æƒ³ç§Ÿä¸€å°è™›æ“¬ä¸»æ©Ÿï¼Œå†æŠŠå¯«å¥½çš„ç¶²é ä¸Ÿä¸Šå»ï¼Œä¸éæœ€å¾Œé‚„æ˜¯é¸æ“‡ä½¿ç”¨ \u003ca href=\"https://pages.github.com/\"\u003eGitHub Pages\u003c/a\u003eã€‚\u003c/p\u003e\n\u003cp\u003eJekyll æ˜¯ Github å»ºè­°çš„éœæ…‹ç¶²ç«™ç”¢ç”Ÿå™¨ï¼Œä¸éåœ¨æŸ¥è©¢è³‡æ–™æ™‚ç™¼ç¾ç”± Go æ‰€å»ºæ§‹çš„ \u003ca href=\"https://gohugo.io/\"\u003eHugo\u003c/a\u003eï¼Œé»é€²å»ç¶²é ä¸Šé¢å°±å¯«è‘—è‡ªå·±æ˜¯ã€Œä¸–ç•Œä¸Šæœ€å¿«çš„ç¶²ç«™æ¶è¨­æ¡†æ¶ã€ï¼Œé‚£ä¸è©¦è©¦çœ‹æ€éº¼è¡Œã€‚\u003c/p\u003e","title":"å°‡ Hugo ç”¢ç”Ÿçš„éœæ…‹ç¶²ç«™éƒ¨å±¬åœ¨ GitHub Pages"}]